# Contexte du Projet : Fleet & Geofence API
GÃ©nÃ©rÃ© le : Wed 28 Jan 2026 11:32:54 PM WAT
Framework : Spring Boot WebFlux (Reactive)

## 1. Arborescence du Projet
```
.
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ gabriel.md
â”œâ”€â”€ .gitattributes
â”œâ”€â”€ .github
â”‚Â Â  â”œâ”€â”€ appmod
â”‚Â Â  â”‚Â Â  â””â”€â”€ appcat
â”‚Â Â  â””â”€â”€ workflows
â”‚Â Â      â””â”€â”€ ci-cd.yml
â”œâ”€â”€ .gitignore
â”œâ”€â”€ import_context.sh
â”œâ”€â”€ mvnw
â”œâ”€â”€ mvnw.cmd
â”œâ”€â”€ pom.xml
â”œâ”€â”€ project_context.txt
â”œâ”€â”€ prompt.md
â”œâ”€â”€ Readme.md
â”œâ”€â”€ src
â”‚Â Â  â”œâ”€â”€ main
â”‚Â Â  â”‚Â Â  â”œâ”€â”€ java
â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ com
â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ yowyob
â”‚Â Â  â”‚Â Â  â”‚Â Â          â””â”€â”€ template
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”œâ”€â”€ application
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â””â”€â”€ service
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â      â”œâ”€â”€ ProductService.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â      â”œâ”€â”€ VehicleDetailsService.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â      â”œâ”€â”€ VehicleLookupService.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â      â”œâ”€â”€ VehicleMediaService.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â      â”œâ”€â”€ VehicleOwnershipService.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â      â”œâ”€â”€ VehicleService.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â      â””â”€â”€ VehicleSmartCreationService.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”œâ”€â”€ domain
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”œâ”€â”€ exception
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ NotFoundException.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ StockFullException.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”œâ”€â”€ model
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ party
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Party.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ PartyType.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ Product.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ vehicle
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”œâ”€â”€ details
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ VehicleAmenity.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ VehicleCanTransport.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ VehicleIllustrationImage.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ VehicleKeyword.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ VehicleReview.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”œâ”€â”€ FuelType.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”œâ”€â”€ Manufacturer.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”œâ”€â”€ ownership
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ UsageRole.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ VehicleOwnership.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”œâ”€â”€ TransmissionType.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”œâ”€â”€ Vehicle.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”œâ”€â”€ VehicleMake.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”œâ”€â”€ VehicleModel.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”œâ”€â”€ VehicleSize.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â””â”€â”€ VehicleType.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â””â”€â”€ ports
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â      â”œâ”€â”€ in
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â      â”‚Â Â  â”œâ”€â”€ CreateProductUseCase.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â      â”‚Â Â  â”œâ”€â”€ ManageVehicleDetailsUseCase.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â      â”‚Â Â  â”œâ”€â”€ ManageVehicleLookupUseCase.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â      â”‚Â Â  â”œâ”€â”€ ManageVehicleMediaUseCase.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â      â”‚Â Â  â”œâ”€â”€ ManageVehicleOwnershipUseCase.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â      â”‚Â Â  â””â”€â”€ ManageVehicleUseCase.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â      â””â”€â”€ out
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â          â”œâ”€â”€ MediaStoragePort.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â          â”œâ”€â”€ ProductCachePort.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â          â”œâ”€â”€ ProductEventPublisherPort.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â          â”œâ”€â”€ ProductRepositoryPort.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â          â”œâ”€â”€ StockClientPort.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â          â”œâ”€â”€ VehicleDetailsRepositoryPort.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â          â”œâ”€â”€ VehicleLookupRepositoryPort.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â          â”œâ”€â”€ VehicleOwnershipRepositoryPort.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â          â””â”€â”€ VehicleRepositoryPort.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”œâ”€â”€ infrastructure
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”œâ”€â”€ adapters
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ inbound
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â  â”œâ”€â”€ kafka
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ ProductEventConsumer.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â  â””â”€â”€ rest
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ dto
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ details
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleAmenityRequest.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleAmenityResponse.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleCanTransportRequest.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleCanTransportResponse.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleIllustrationImageRequest.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleIllustrationImageResponse.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleKeywordRequest.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleKeywordResponse.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleReviewRequest.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ VehicleReviewResponse.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ lookup
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ FuelTypeRequest.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ FuelTypeResponse.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ManufacturerRequest.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ManufacturerResponse.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ TransmissionTypeRequest.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ TransmissionTypeResponse.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleMakeRequest.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleMakeResponse.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleModelRequest.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleModelResponse.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleSizeRequest.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleSizeResponse.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleTypeRequest.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ VehicleTypeResponse.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ ownership
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleOwnershipRequest.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ VehicleOwnershipResponse.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ party
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â”œâ”€â”€ PartyRequest.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ PartyResponse.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ PatchVehicleRequest.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ ProductRequest.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ ProductResponse.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ SimplifiedVehicleRequest.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ VehicleRequest.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ VehicleResponse.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ GlobalExceptionHandler.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ ProductController.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ VehicleController.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ VehicleDetailsController.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ VehicleLookupController.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â”œâ”€â”€ VehicleMediaController.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”‚Â Â      â””â”€â”€ VehicleOwnershipController.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ outbound
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”œâ”€â”€ cache
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ RedisAdapter.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”œâ”€â”€ external
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ client
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ StockApiClient.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ dto
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â”‚Â Â  â””â”€â”€ MediaServiceResponse.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â”œâ”€â”€ HttpMediaAdapter.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ StockAdapter.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”œâ”€â”€ messaging
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â”‚Â Â  â””â”€â”€ KafkaAdapter.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â      â””â”€â”€ persistence
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”œâ”€â”€ entity
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ FuelTypeEntity.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ ManufacturerEntity.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ PartyEntity.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ ProductEntity.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ TransmissionTypeEntity.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ VehicleAmenityEntity.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ VehicleCanTransportEntity.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ VehicleEntity.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ VehicleIllustrationImageEntity.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ VehicleKeywordEntity.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ VehicleMakeEntity.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ VehicleModelEntity.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ VehicleOwnershipEntity.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ VehicleReviewEntity.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â”œâ”€â”€ VehicleSizeEntity.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”‚Â Â  â””â”€â”€ VehicleTypeEntity.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”œâ”€â”€ PostgresR2dbcAdapter.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”œâ”€â”€ PostgreVehicleAdapter.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”œâ”€â”€ PostgreVehicleDetailsAdapter.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”œâ”€â”€ PostgreVehicleLookupAdapter.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â”œâ”€â”€ PostgreVehicleOwnershipAdapter.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â          â””â”€â”€ repository
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â              â”œâ”€â”€ FuelTypeR2dbcRepository.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â              â”œâ”€â”€ ManufacturerR2dbcRepository.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â              â”œâ”€â”€ ProductR2dbcRepository.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â              â”œâ”€â”€ TransmissionTypeR2dbcRepository.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â              â”œâ”€â”€ VehicleAmenityR2dbcRepository.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â              â”œâ”€â”€ VehicleCanTransportR2dbcRepository.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â              â”œâ”€â”€ VehicleIllustrationImageR2dbcRepository.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â              â”œâ”€â”€ VehicleKeywordR2dbcRepository.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â              â”œâ”€â”€ VehicleMakeR2dbcRepository.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â              â”œâ”€â”€ VehicleModelR2dbcRepository.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â              â”œâ”€â”€ VehicleOwnershipR2dbcRepository.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â              â”œâ”€â”€ VehicleR2dbcRepository.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â              â”œâ”€â”€ VehicleRepository.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â              â”œâ”€â”€ VehicleReviewR2dbcRepository.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â              â”œâ”€â”€ VehicleSizeR2dbcRepository.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â              â””â”€â”€ VehicleTypeR2dbcRepository.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”œâ”€â”€ config
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ KafkaConfig.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ KafkaTopicConfig.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ OpenApiConfig.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ R2dbcAuditingConfig.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ RedisConfig.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ WebClientConfig.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”œâ”€â”€ mappers
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ FuelTypeMapper.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ManufacturerMapper.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ PartyMapper.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ ProductMapper.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ TransmissionTypeMapper.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleDetailsMapper.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleMakeMapper.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleMapper.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleModelMapper.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleOwnershipMapper.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â”œâ”€â”€ VehicleSizeMapper.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â”‚Â Â  â””â”€â”€ VehicleTypeMapper.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â  â””â”€â”€ security
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â      â”œâ”€â”€ AuthenticatedUser.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â      â”œâ”€â”€ AuthServiceClient.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â      â”œâ”€â”€ dto
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â      â”‚Â Â  â””â”€â”€ AuthUserResponse.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â      â”œâ”€â”€ JwtAuthenticationFilter.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â      â”œâ”€â”€ JwtAuthenticationToken.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â”‚Â Â      â””â”€â”€ SecurityConfig.java
â”‚Â Â  â”‚Â Â  â”‚Â Â              â””â”€â”€ TemplateApplication.java
â”‚Â Â  â”‚Â Â  â””â”€â”€ resources
â”‚Â Â  â”‚Â Â      â”œâ”€â”€ application.yml
â”‚Â Â  â”‚Â Â      â”œâ”€â”€ data.sql
â”‚Â Â  â”‚Â Â      â”œâ”€â”€ prod.application.yml
â”‚Â Â  â”‚Â Â      â””â”€â”€ schema.sql
â”‚Â Â  â”œâ”€â”€ residu
â”‚Â Â  â””â”€â”€ test
â”‚Â Â      â””â”€â”€ java
â”‚Â Â          â””â”€â”€ com
â”‚Â Â              â””â”€â”€ yowyob
â”‚Â Â                  â””â”€â”€ template
â”‚Â Â                      â”œâ”€â”€ infrastructure
â”‚Â Â                      â”‚Â Â  â””â”€â”€ adapters
â”‚Â Â                      â”‚Â Â      â””â”€â”€ inbound
â”‚Â Â                      â”‚Â Â          â””â”€â”€ rest
â”‚Â Â                      â”‚Â Â              â”œâ”€â”€ VehicleDetailsControllerTest.java
â”‚Â Â                      â”‚Â Â              â”œâ”€â”€ VehicleLookupControllerTest.java
â”‚Â Â                      â”‚Â Â              â””â”€â”€ VehicleOwnershipControllerTest.java
â”‚Â Â                      â””â”€â”€ ReactiveHexagonalApplicationTests.java
â”œâ”€â”€ start.sh
â”œâ”€â”€ test_api.sh
â”œâ”€â”€ todo.md
â””â”€â”€ wiremock
    â””â”€â”€ mappings
        â””â”€â”€ stock-scenarios.json

57 directories, 177 files
```
## 2. Contenu des Fichiers

---
### Fichier : `./prompt.md`
```md
# ðŸ¤– Master Prompt : Senior Pair Programmer WebFlux

Tu es mon Senior Pair Programmer expert en Java **Spring Boot WebFlux (RÃ©actif)**.
Nous dÃ©veloppons l'API **Fleet Management et Geofencing** (Projet TraEnSys).

### ðŸ“‹ Ta MÃ©thode de Travail (IMPÃ‰RATIF)
Pour chaque tÃ¢che demandÃ©e, tu dois obligatoirement suivre ces Ã©tapes :

**Ã‰tape 1 : Conception fonctionnelle**
- Analyse du besoin, user stories et ajustement du modÃ¨le de donnÃ©es.Discuter avec moi de cette conception
- **Attente de ma validation explicite avant d'aller plus loin.**

**Ã‰tape 2 : Discussion Technique**
- Avant de coder, explique briÃ¨vement comment l'architechture sera gÃ©rÃ©e pour cette tÃ¢che.ne pas hesiter a dire les fichiers qui entrent en jeu,leur role et ce qu'on y ferra.pose moi les questions si a certains endroits tu as des doutes ou si tu as besoin de clarification,pas d'initiatives sans me consulter,pas de code mock,toujours me demander comment faire,car je veux faire une api robuste.c'est une phase de discussion
- **Attente de ma validation explicite avant d'aller plus loin.**

**Ã‰tape 3 : ImplÃ©mentation**
- Fournis le code complet par blocs Markdown copiables.
- Respecte l'architecture hexagonale du projet.
-respecte egalement mes consignes

**Ã‰tape 4 : Tests & Validation**
- Instructions pour tester via swagger .

### ðŸš« Tes RÃ¨gles de Conduite
1. **ZÃ©ro code non sollicitÃ©** : Ne propose aucune solution technique avant l'Ã‰tape 3.
2. **Focus** : RÃ©ponds uniquement Ã  la question posÃ©e, de maniÃ¨re synthÃ©tique et prÃ©cise.
3. **Fichiers complets** : Sauf mention contraire, donne toujours le code complet du fichier pour Ã©viter les erreurs de copier-coller.
4. **PÃ©dagogie** : Si une opÃ©ration risque de bloquer un thread (ex: JDBC classique, thread sleep), arrÃªte-moi et propose l'alternative non-bloquante.

### ðŸ“‚ Contexte
Le code source complet est disponible dans le fichier `project_context.txt`.
La roadmap est suivie dans `todo.md`.


### Premiere mission
ceci est un service partage,mais beaucoup de personnes se peleignent que le service n'est pas fonctionnel,alors mon role aujour'dhui est de corriger les problemes. la premiere etape est de comprendre l'existant,
-est-ce que le service inlcu liqui base?
-il faut etre sur que au minimum les crud des vehicules passent
-askip il y'a les problemes de cors
-il faut la route pour pacht le vehicule
-il faut les getbyid
-il faut la gestion des images d'un vehicle
bref on doit debugger ca.
-il faut simplifier la reation avec une seule route,qui verifie si un string d'un champ existe et si ca n'existe pas,le cree

bref y'a pas mal de truic a fairecommencons par l'analys de l'existant.```

---
### Fichier : `./bin/src/main/resources/application.yml`
```yaml
server:
  port: 8080

spring:
  application:
    name: reactive-hexagonal
  
  r2dbc:
    url: r2dbc:postgresql://localhost:5432/reactivedb
    username: user
    password: password
  
  sql:
    init:
      mode: always # start the scheme

  data:
    redis:
      host: localhost
      port: 6379

  kafka:
    bootstrap-servers: localhost:9092
    consumer:
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer

# Custom Config 
application:
  external:
    stock-service-url: http://localhost:8081 # Wiremock

# Resilience4j Config
resilience4j:
  circuitbreaker:
    instances:
      stock-service:
        failureRateThreshold: 50
        waitDurationInOpenState: 5s
        slidingWindowSize: 5```

---
### Fichier : `./bin/src/main/resources/schema.sql`
```sql
CREATE TABLE IF NOT EXISTS products (
    id UUID PRIMARY KEY,
    name VARCHAR(255),
    price DECIMAL(10, 2),
    status VARCHAR(50)
);```

---
### Fichier : `./bin/.mvn/wrapper/maven-wrapper.properties`
```properties
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.11/apache-maven-3.9.11-bin.zip
```

---
### Fichier : `./bin/pom.xml`
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" 
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.4.0</version>
        <relativePath/>
    </parent>
    
    <groupId>com.yowyob</groupId>
    <artifactId>reactive-hexagonal</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>reactive-hexagonal</name>
    <description>Template Hexagonal Reactive pour com.yowyob</description>
    
    <properties>
        <java.version>21</java.version>
        <spring-cloud.version>2023.0.0</spring-cloud.version>
        <mapstruct.version>1.5.5.Final</mapstruct.version>
    </properties>
    
    <dependencies>
        <!-- REACTIVE CORE -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>

        <!-- DATA (R2DBC & REDIS) -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-r2dbc</artifactId>
        </dependency>
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>r2dbc-postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis-reactive</artifactId>
        </dependency>

        <!-- MESSAGING (KAFKA) -->
        <dependency>
            <groupId>org.springframework.kafka</groupId>
            <artifactId>spring-kafka</artifactId>
        </dependency>

        <!-- CLOUD & RESILIENCE -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-circuitbreaker-reactor-resilience4j</artifactId>
        </dependency>

        <!-- TOOLS (Lombok & Mapstruct) -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.mapstruct</groupId>
            <artifactId>mapstruct</artifactId>
            <version>${mapstruct.version}</version>
        </dependency>
        
        <!-- Docker Compose Auto-setup -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-docker-compose</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        
        <!-- Test -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>io.projectreactor</groupId>
            <artifactId>reactor-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring-cloud.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.11.0</version>
                <configuration>
                    <source>${java.version}</source>
                    <target>${java.version}</target>
                    <annotationProcessorPaths>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                            <version>1.18.30</version>
                        </path>
                        <path>
                            <groupId>org.mapstruct</groupId>
                            <artifactId>mapstruct-processor</artifactId>
                            <version>${mapstruct.version}</version>
                        </path>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok-mapstruct-binding</artifactId>
                            <version>0.2.0</version>
                        </path>
                    </annotationProcessorPaths>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>```

---
### Fichier : `./gabriel.md`
```md
# ðŸ¤– Master Prompt : Senior Pair Programmer WebFlux

Tu es mon Senior Pair Programmer expert en Java **Spring Boot WebFlux (RÃ©actif)**.
Nous dÃ©veloppons l'API **Fleet Management et Geofencing** (Projet TraEnSys).

### ðŸ“‹ Ta MÃ©thode de Travail (IMPÃ‰RATIF)
Pour chaque tÃ¢che demandÃ©e, tu dois obligatoirement suivre ces Ã©tapes :

**Ã‰tape 1 : Conception fonctionnelle**
- Analyse du besoin, user stories et ajustement du modÃ¨le de donnÃ©es.Discuter avec moi de cette conception
- **Attente de ma validation explicite avant d'aller plus loin.**

**Ã‰tape 2 : Discussion Technique**
- Avant de coder, explique briÃ¨vement comment l'architechture sera gÃ©rÃ©e pour cette tÃ¢che.ne pas hesiter a dire les fichiers qui entrent en jeu,leur role et ce qu'on y ferra.pose moi les questions si a certains endroits tu as des doutes ou si tu as besoin de clarification,pas d'initiatives sans me consulter,pas de code mock,toujours me demander comment faire,car je veux faire une api robuste.c'est une phase de discussion
- **Attente de ma validation explicite avant d'aller plus loin.**

**Ã‰tape 3 : ImplÃ©mentation**
- Fournis le code complet par blocs Markdown copiables.
- Respecte l'architecture hexagonale du projet.
-respecte egalement mes consignes

**Ã‰tape 4 : Tests & Validation**
- Instructions pour tester via swagger .

### ðŸš« Tes RÃ¨gles de Conduite
1. **ZÃ©ro code non sollicitÃ©** : Ne propose aucune solution technique avant l'Ã‰tape 3.
2. **Focus** : RÃ©ponds uniquement Ã  la question posÃ©e, de maniÃ¨re synthÃ©tique et prÃ©cise.
3. **Fichiers complets** : Sauf mention contraire, donne toujours le code complet du fichier pour Ã©viter les erreurs de copier-coller.
4. **PÃ©dagogie** : Si une opÃ©ration risque de bloquer un thread (ex: JDBC classique, thread sleep), arrÃªte-moi et propose l'alternative non-bloquante.

### ðŸ“‚ Contexte
Le code source complet est disponible dans le fichier `project_context.txt`.
La roadmap est suivie dans `todo.md`.


### Premiere mission
ceci est le debogage des crud des vehicules,via le service simplifie.actuelleemnt create,get marchent,masi pas put et patch car on med idt entite deja existante. c'est ca qu'on doit corriger,j'avaias deja commcence a resourdre ca avec une autre ia mais mes tokens sont finis.aide moi a le faire,commence par me dire quelles son les modiffications a mettre en palce afin que ca marche.```

---
### Fichier : `./todo.md`
```md
# ðŸ›  Roadmap Refactoring : Fleet & Geofence API

## Ã‰tape 1 : Stabilisation de l'Infrastructure
- [x] **Configurer le CORS** : Autoriser les requÃªtes cross-origin pour permettre au frontend de communiquer avec l'API (Global config).
- [x] **VÃ©rification SchÃ©ma SQL** : S'assurer que le fichier `schema.sql` est cohÃ©rent avec les nouvelles fonctionnalitÃ©s attendues (cascades, contraintes).

## Ã‰tape 2 : Logique MÃ©tier "Smart Creation"
- [x] **ImplÃ©menter le pattern "Get or Create"** : Modifier `VehicleSmartCreationService` pour qu'il ne renvoie plus d'erreur si une marque/modÃ¨le n'existe pas, mais la crÃ©e Ã  la volÃ©e.le faire sur uen nouvelle route dediee.
- [x] **Optimisation RÃ©active** : S'assurer que ces crÃ©ations en chaÃ®ne se font proprement avec Reactor (chaining `switchIfEmpty`).

## Ã‰tape 3 : ComplÃ©tude du CRUD VÃ©hicule
- [x] **Endpoint PATCH** : CrÃ©er la route et la logique pour la mise Ã  jour partielle d'un vÃ©hicule (ex: changer juste le kilomÃ©trage).
- [x] **Endpoint GET (DÃ©tails)** : VÃ©rifier que le `getById` renvoie bien toutes les infos agrÃ©gÃ©es (options, images) et pas juste l'objet brut.Et faire le `getById` sur chaque table

## Ã‰tape 4 : Gestion des MÃ©dias (Images)
- [ ] **Service de Stockage** : ImplÃ©menter un service simple pour sauvegarder les fichiers (MultipartFile) sur le disque local.
- [ ] **Endpoint Upload** : CrÃ©er la route `POST /vehicles/{id}/images` pour uploader et lier une image Ã  un vÃ©hicule.

## Ã‰tape 5 : Validation & Tests
- [x] **Test Swagger** : Valider manuellement chaque endpoint via Swagger UI.
- [x] **Nettoyage** : Supprimer le code mort ou les TODOs obsolÃ¨tes.

---
```

---
### Fichier : `./src/test/java/com/yowyob/template/ReactiveHexagonalApplicationTests.java`
```java
package com.yowyob.template; // Assure-toi que c'est bien ce package

import org.junit.jupiter.api.Test;
import org.springframework.boot.test.context.SpringBootTest;

// ðŸ‘‡ Cette ligne connecte ton test Ã  ta classe principale
@SpringBootTest(classes = TemplateApplication.class)
class ReactiveHexagonalApplicationTests {

	@Test
	void contextLoads() {
		// Le test va dÃ©marrer TemplateApplication.
		// Si Ã§a passe, tout est bon.
	}

}```

---
### Fichier : `./src/test/java/com/yowyob/template/infrastructure/adapters/inbound/rest/VehicleLookupControllerTest.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest;

import com.yowyob.template.domain.model.vehicle.*;
import com.yowyob.template.domain.ports.in.ManageVehicleLookupUseCase;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup.*;
import com.yowyob.template.infrastructure.mappers.*;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.reactive.WebFluxTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.http.MediaType;
import org.springframework.test.web.reactive.server.WebTestClient;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;

import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.when;

@WebFluxTest(controllers = VehicleLookupController.class)
class VehicleLookupControllerTest {

    @Autowired
    private WebTestClient webTestClient;

    @MockBean
    private ManageVehicleLookupUseCase lookupUseCase;

    @MockBean
    private FuelTypeMapper fuelTypeMapper;
    @MockBean
    private ManufacturerMapper manufacturerMapper;
    @MockBean
    private TransmissionTypeMapper transmissionTypeMapper;
    @MockBean
    private VehicleMakeMapper vehicleMakeMapper;
    @MockBean
    private VehicleModelMapper vehicleModelMapper;
    @MockBean
    private VehicleSizeMapper vehicleSizeMapper;
    @MockBean
    private VehicleTypeMapper vehicleTypeMapper;

    // --- FuelType Tests ---

    @Test
    void createFuelType() {
        UUID id = UUID.randomUUID();
        FuelTypeRequest request = new FuelTypeRequest("Diesel");
        FuelType domain = new FuelType(null, "Diesel");
        FuelType savedDomain = new FuelType(id, "Diesel");
        FuelTypeResponse response = new FuelTypeResponse(id, "Diesel");

        when(fuelTypeMapper.toDomain(any(FuelTypeRequest.class))).thenReturn(domain);
        when(lookupUseCase.createFuelType(any(FuelType.class))).thenReturn(Mono.just(savedDomain));
        when(fuelTypeMapper.toResponse(any(FuelType.class))).thenReturn(response);

        webTestClient.post()
                .uri("/vehicles/lookup/fuel-types")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isCreated()
                .expectBody(FuelTypeResponse.class)
                .isEqualTo(response);
    }

    @Test
    void getAllFuelTypes() {
        UUID id = UUID.randomUUID();
        FuelType domain = new FuelType(id, "Diesel");
        FuelTypeResponse response = new FuelTypeResponse(id, "Diesel");

        when(lookupUseCase.getAllFuelTypes()).thenReturn(Flux.just(domain));
        when(fuelTypeMapper.toResponse(domain)).thenReturn(response);

        webTestClient.get()
                .uri("/vehicles/lookup/fuel-types")
                .exchange()
                .expectStatus().isOk()
                .expectBodyList(FuelTypeResponse.class)
                .contains(response);
    }

    @Test
    void getFuelTypeById() {
        UUID id = UUID.randomUUID();
        FuelType domain = new FuelType(id, "Diesel");
        FuelTypeResponse response = new FuelTypeResponse(id, "Diesel");

        when(lookupUseCase.getFuelTypeById(id)).thenReturn(Mono.just(domain));
        when(fuelTypeMapper.toResponse(domain)).thenReturn(response);

        webTestClient.get()
                .uri("/vehicles/lookup/fuel-types/{id}", id)
                .exchange()
                .expectStatus().isOk()
                .expectBody(FuelTypeResponse.class)
                .isEqualTo(response);
    }

    @Test
    void deleteFuelType() {
        UUID id = UUID.randomUUID();
        FuelType domain = new FuelType(id, "Diesel");
        when(lookupUseCase.getFuelTypeById(id)).thenReturn(Mono.just(domain));
        when(lookupUseCase.deleteFuelType(id)).thenReturn(Mono.empty());

        webTestClient.delete()
                .uri("/vehicles/lookup/fuel-types/{id}", id)
                .exchange()
                .expectStatus().isNoContent();
    }

    @Test
    void getFuelTypeById_NotFound() {
        UUID id = UUID.randomUUID();
        when(lookupUseCase.getFuelTypeById(id)).thenReturn(Mono.empty());

        webTestClient.get()
                .uri("/vehicles/lookup/fuel-types/{id}", id)
                .exchange()
                .expectStatus().isNotFound();
    }

    @Test
    void createFuelType_ValidationError() {
        FuelTypeRequest request = new FuelTypeRequest(""); // Invalid: blank name

        webTestClient.post()
                .uri("/vehicles/lookup/fuel-types")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isBadRequest();
    }

    // --- Manufacturer Tests ---

    @Test
    void createManufacturer() {
        UUID id = UUID.randomUUID();
        ManufacturerRequest request = new ManufacturerRequest("Toyota");
        Manufacturer domain = new Manufacturer(null, "Toyota");
        Manufacturer savedDomain = new Manufacturer(id, "Toyota");
        ManufacturerResponse response = new ManufacturerResponse(id, "Toyota");

        when(manufacturerMapper.toDomain(any(ManufacturerRequest.class))).thenReturn(domain);
        when(lookupUseCase.createManufacturer(any(Manufacturer.class))).thenReturn(Mono.just(savedDomain));
        when(manufacturerMapper.toResponse(any(Manufacturer.class))).thenReturn(response);

        webTestClient.post()
                .uri("/vehicles/lookup/manufacturers")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isCreated()
                .expectBody(ManufacturerResponse.class)
                .isEqualTo(response);
    }

    // --- TransmissionType Tests ---

    @Test
    void createTransmissionType() {
        UUID id = UUID.randomUUID();
        TransmissionTypeRequest request = new TransmissionTypeRequest("Automatic");
        TransmissionType domain = new TransmissionType(null, "Automatic", null, null);
        TransmissionType savedDomain = new TransmissionType(id, "Automatic", null, null);
        TransmissionTypeResponse response = new TransmissionTypeResponse(id, "Automatic", null, null);

        when(transmissionTypeMapper.toDomain(any(TransmissionTypeRequest.class))).thenReturn(domain);
        when(lookupUseCase.createTransmissionType(any(TransmissionType.class))).thenReturn(Mono.just(savedDomain));
        when(transmissionTypeMapper.toResponse(any(TransmissionType.class))).thenReturn(response);

        webTestClient.post()
                .uri("/vehicles/lookup/transmission-types")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isCreated()
                .expectBody(TransmissionTypeResponse.class)
                .isEqualTo(response);
    }

    // --- VehicleMake Tests ---

    @Test
    void createVehicleMake() {
        UUID id = UUID.randomUUID();
        VehicleMakeRequest request = new VehicleMakeRequest("Corolla");
        VehicleMake domain = new VehicleMake(null, "Corolla");
        VehicleMake savedDomain = new VehicleMake(id, "Corolla");
        VehicleMakeResponse response = new VehicleMakeResponse(id, "Corolla");

        when(vehicleMakeMapper.toDomain(any(VehicleMakeRequest.class))).thenReturn(domain);
        when(lookupUseCase.createVehicleMake(any(VehicleMake.class))).thenReturn(Mono.just(savedDomain));
        when(vehicleMakeMapper.toResponse(any(VehicleMake.class))).thenReturn(response);

        webTestClient.post()
                .uri("/vehicles/lookup/vehicle-makes")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isCreated()
                .expectBody(VehicleMakeResponse.class)
                .isEqualTo(response);
    }

    // --- VehicleModel Tests ---

    @Test
    void createVehicleModel() {
        UUID id = UUID.randomUUID();
        UUID makeId = UUID.randomUUID();
        VehicleModelRequest request = new VehicleModelRequest(makeId, "2024");
        VehicleModel domain = new VehicleModel(null, "2024", null, null);
        VehicleModel savedDomain = new VehicleModel(id, "2024", null, null);
        VehicleModelResponse response = new VehicleModelResponse(id, "2024", null, null);

        when(vehicleModelMapper.toDomain(any(VehicleModelRequest.class))).thenReturn(domain);
        when(lookupUseCase.createVehicleModel(any(VehicleModel.class))).thenReturn(Mono.just(savedDomain));
        when(vehicleModelMapper.toResponse(any(VehicleModel.class))).thenReturn(response);

        webTestClient.post()
                .uri("/vehicles/lookup/vehicle-models")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isCreated()
                .expectBody(VehicleModelResponse.class)
                .isEqualTo(response);
    }

    // --- VehicleSize Tests ---

    @Test
    void createVehicleSize() {
        UUID id = UUID.randomUUID();
        VehicleSizeRequest request = new VehicleSizeRequest("Compact");
        VehicleSize domain = new VehicleSize(null, "Compact", null, null);
        VehicleSize savedDomain = new VehicleSize(id, "Compact", null, null);
        VehicleSizeResponse response = new VehicleSizeResponse(id, "Compact", null, null);

        when(vehicleSizeMapper.toDomain(any(VehicleSizeRequest.class))).thenReturn(domain);
        when(lookupUseCase.createVehicleSize(any(VehicleSize.class))).thenReturn(Mono.just(savedDomain));
        when(vehicleSizeMapper.toResponse(any(VehicleSize.class))).thenReturn(response);

        webTestClient.post()
                .uri("/vehicles/lookup/vehicle-sizes")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isCreated()
                .expectBody(VehicleSizeResponse.class)
                .isEqualTo(response);
    }

    // --- VehicleType Tests ---

    @Test
    void createVehicleType() {
        UUID id = UUID.randomUUID();
        VehicleTypeRequest request = new VehicleTypeRequest("Sedan");
        VehicleType domain = new VehicleType(null, "Sedan");
        VehicleType savedDomain = new VehicleType(id, "Sedan");
        VehicleTypeResponse response = new VehicleTypeResponse(id, "Sedan");

        when(vehicleTypeMapper.toDomain(any(VehicleTypeRequest.class))).thenReturn(domain);
        when(lookupUseCase.createVehicleType(any(VehicleType.class))).thenReturn(Mono.just(savedDomain));
        when(vehicleTypeMapper.toResponse(any(VehicleType.class))).thenReturn(response);

        webTestClient.post()
                .uri("/vehicles/lookup/vehicle-types")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isCreated()
                .expectBody(VehicleTypeResponse.class)
                .isEqualTo(response);
    }
}
```

---
### Fichier : `./src/test/java/com/yowyob/template/infrastructure/adapters/inbound/rest/VehicleDetailsControllerTest.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest;

import com.yowyob.template.domain.model.vehicle.details.*;
import com.yowyob.template.domain.ports.in.ManageVehicleDetailsUseCase;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details.*;
import com.yowyob.template.infrastructure.mappers.VehicleDetailsMapper;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.reactive.WebFluxTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.http.MediaType;
import org.springframework.test.web.reactive.server.WebTestClient;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;

import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.when;

@WebFluxTest(controllers = VehicleDetailsController.class)
class VehicleDetailsControllerTest {

    @Autowired
    private WebTestClient webTestClient;

    @MockBean
    private ManageVehicleDetailsUseCase detailsUseCase;

    @MockBean
    private VehicleDetailsMapper mapper;

    // --- Amenity Tests ---

    @Test
    void createAmenity() {
        UUID id = UUID.randomUUID();
        UUID vehicleId = UUID.randomUUID();
        VehicleAmenityRequest request = new VehicleAmenityRequest(vehicleId, "AC");
        VehicleAmenity domain = new VehicleAmenity(null, vehicleId, "AC");
        VehicleAmenity savedDomain = new VehicleAmenity(id, vehicleId, "AC");
        VehicleAmenityResponse response = new VehicleAmenityResponse(id, vehicleId, "AC");

        when(mapper.toDomain(any(VehicleAmenityRequest.class))).thenReturn(domain);
        when(detailsUseCase.createAmenity(any(VehicleAmenity.class))).thenReturn(Mono.just(savedDomain));
        when(mapper.toResponse(any(VehicleAmenity.class))).thenReturn(response);

        webTestClient.post()
                .uri("/vehicles/details/amenities")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isCreated()
                .expectBody(VehicleAmenityResponse.class)
                .isEqualTo(response);
    }

    @Test
    void getAmenitiesByVehicleId() {
        UUID id = UUID.randomUUID();
        UUID vehicleId = UUID.randomUUID();
        VehicleAmenity domain = new VehicleAmenity(id, vehicleId, "AC");
        VehicleAmenityResponse response = new VehicleAmenityResponse(id, vehicleId, "AC");

        when(detailsUseCase.getAmenitiesByVehicleId(vehicleId)).thenReturn(Flux.just(domain));
        when(mapper.toResponse(domain)).thenReturn(response);

        webTestClient.get()
                .uri("/vehicles/details/amenities/vehicle/{vehicleId}", vehicleId)
                .exchange()
                .expectStatus().isOk()
                .expectBodyList(VehicleAmenityResponse.class)
                .contains(response);
    }

    // --- CanTransport Tests ---

    @Test
    void createCanTransport() {
        UUID id = UUID.randomUUID();
        UUID vehicleId = UUID.randomUUID();
        VehicleCanTransportRequest request = new VehicleCanTransportRequest(vehicleId, "Bikes");
        VehicleCanTransport domain = new VehicleCanTransport(null, vehicleId, "Bikes");
        VehicleCanTransport savedDomain = new VehicleCanTransport(id, vehicleId, "Bikes");
        VehicleCanTransportResponse response = new VehicleCanTransportResponse(id, vehicleId, "Bikes");

        when(mapper.toDomain(any(VehicleCanTransportRequest.class))).thenReturn(domain);
        when(detailsUseCase.createCanTransport(any(VehicleCanTransport.class))).thenReturn(Mono.just(savedDomain));
        when(mapper.toResponse(any(VehicleCanTransport.class))).thenReturn(response);

        webTestClient.post()
                .uri("/vehicles/details/can-transports")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isCreated()
                .expectBody(VehicleCanTransportResponse.class)
                .isEqualTo(response);
    }

    // --- IllustrationImage Tests ---

    @Test
    void createIllustrationImage() {
        UUID id = UUID.randomUUID();
        UUID vehicleId = UUID.randomUUID();
        VehicleIllustrationImageRequest request = new VehicleIllustrationImageRequest(vehicleId, "/path/to/image.jpg");
        VehicleIllustrationImage domain = new VehicleIllustrationImage(null, vehicleId, "/path/to/image.jpg");
        VehicleIllustrationImage savedDomain = new VehicleIllustrationImage(id, vehicleId, "/path/to/image.jpg");
        VehicleIllustrationImageResponse response = new VehicleIllustrationImageResponse(id, vehicleId,
                "/path/to/image.jpg");

        when(mapper.toDomain(any(VehicleIllustrationImageRequest.class))).thenReturn(domain);
        when(detailsUseCase.createIllustrationImage(any(VehicleIllustrationImage.class)))
                .thenReturn(Mono.just(savedDomain));
        when(mapper.toResponse(any(VehicleIllustrationImage.class))).thenReturn(response);

        webTestClient.post()
                .uri("/vehicles/details/illustration-images")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isCreated()
                .expectBody(VehicleIllustrationImageResponse.class)
                .isEqualTo(response);
    }

    // --- Keyword Tests ---

    @Test
    void createKeyword() {
        UUID id = UUID.randomUUID();
        UUID vehicleId = UUID.randomUUID();
        VehicleKeywordRequest request = new VehicleKeywordRequest(vehicleId, "Fast");
        VehicleKeyword domain = new VehicleKeyword(null, vehicleId, "Fast");
        VehicleKeyword savedDomain = new VehicleKeyword(id, vehicleId, "Fast");
        VehicleKeywordResponse response = new VehicleKeywordResponse(id, vehicleId, "Fast");

        when(mapper.toDomain(any(VehicleKeywordRequest.class))).thenReturn(domain);
        when(detailsUseCase.createKeyword(any(VehicleKeyword.class))).thenReturn(Mono.just(savedDomain));
        when(mapper.toResponse(any(VehicleKeyword.class))).thenReturn(response);

        webTestClient.post()
                .uri("/vehicles/details/keywords")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isCreated()
                .expectBody(VehicleKeywordResponse.class)
                .isEqualTo(response);
    }

    // --- Review Tests ---

    @Test
    void createReview() {
        UUID vehicleId = UUID.randomUUID();
        UUID reviewId = UUID.randomUUID();
        VehicleReviewRequest request = new VehicleReviewRequest(vehicleId, reviewId);
        VehicleReview domain = new VehicleReview(vehicleId, reviewId);
        VehicleReviewResponse response = new VehicleReviewResponse(vehicleId, reviewId);

        when(mapper.toDomain(any(VehicleReviewRequest.class))).thenReturn(domain);
        when(detailsUseCase.createReview(any(VehicleReview.class))).thenReturn(Mono.just(domain));
        when(mapper.toResponse(any(VehicleReview.class))).thenReturn(response);

        webTestClient.post()
                .uri("/vehicles/details/reviews")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isCreated()
                .expectBody(VehicleReviewResponse.class)
                .isEqualTo(response);
    }
}
```

---
### Fichier : `./src/test/java/com/yowyob/template/infrastructure/adapters/inbound/rest/VehicleOwnershipControllerTest.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest;

import com.yowyob.template.domain.model.vehicle.ownership.UsageRole;
import com.yowyob.template.domain.model.vehicle.ownership.VehicleOwnership;
import com.yowyob.template.domain.ports.in.ManageVehicleOwnershipUseCase;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.ownership.VehicleOwnershipRequest;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.ownership.VehicleOwnershipResponse;
import com.yowyob.template.infrastructure.mappers.VehicleOwnershipMapper;
import com.yowyob.template.infrastructure.security.AuthenticatedUser;
import com.yowyob.template.infrastructure.security.JwtAuthenticationToken;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.reactive.WebFluxTest;
import org.springframework.boot.test.mock.mockito.MockBean;
import org.springframework.context.annotation.Import;
import org.springframework.http.MediaType;
import org.springframework.security.test.web.reactive.server.SecurityMockServerConfigurers;
import org.springframework.test.web.reactive.server.WebTestClient;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.time.LocalDateTime;
import java.util.List;
import java.util.UUID;

import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.when;
import static org.springframework.security.test.web.reactive.server.SecurityMockServerConfigurers.mockAuthentication;

@WebFluxTest(controllers = VehicleOwnershipController.class)
class VehicleOwnershipControllerTest {

    @Autowired
    private WebTestClient webTestClient;

    @MockBean
    private ManageVehicleOwnershipUseCase ownershipUseCase;

    @MockBean
    private VehicleOwnershipMapper mapper;

    private UUID partyId;
    private AuthenticatedUser authenticatedUser;
    private JwtAuthenticationToken authentication;

    @BeforeEach
    void setUp() {
        partyId = UUID.randomUUID();
        authenticatedUser = new AuthenticatedUser(
                partyId.toString(), 
                "testuser", 
                "test@example.com", 
                "+123456789",
                "Test", 
                "User", 
                List.of("USER"), 
                List.of()
        );
        authentication = new JwtAuthenticationToken(
                authenticatedUser, 
                "test-token", 
                authenticatedUser.getAuthorities()
        );
    }

    @Test
    void createOwnership() {
        UUID id = UUID.randomUUID();
        UUID vehicleId = UUID.randomUUID();
        LocalDateTime now = LocalDateTime.now();

        // Le nouveau request ne contient plus partyId
        VehicleOwnershipRequest request = new VehicleOwnershipRequest(vehicleId, UsageRole.OWNER, true, now, null);
        VehicleOwnership savedDomain = new VehicleOwnership(id, vehicleId, partyId, UsageRole.OWNER, true, now, null);
        VehicleOwnershipResponse response = new VehicleOwnershipResponse(id, vehicleId, partyId, UsageRole.OWNER, true, now, null);

        when(ownershipUseCase.createOwnership(any(VehicleOwnership.class))).thenReturn(Mono.just(savedDomain));
        when(mapper.toResponse(any(VehicleOwnership.class))).thenReturn(response);

        webTestClient
                .mutateWith(mockAuthentication(authentication))
                .post()
                .uri("/vehicles/ownerships")
                .contentType(MediaType.APPLICATION_JSON)
                .bodyValue(request)
                .exchange()
                .expectStatus().isCreated()
                .expectBody(VehicleOwnershipResponse.class)
                .isEqualTo(response);
    }

    @Test
    void getMyOwnerships() {
        UUID id = UUID.randomUUID();
        UUID vehicleId = UUID.randomUUID();
        LocalDateTime now = LocalDateTime.now();

        VehicleOwnership domain = new VehicleOwnership(id, vehicleId, partyId, UsageRole.OWNER, true, now, null);
        VehicleOwnershipResponse response = new VehicleOwnershipResponse(id, vehicleId, partyId, UsageRole.OWNER, true, now, null);

        when(ownershipUseCase.getOwnershipsByPartyId(partyId)).thenReturn(Flux.just(domain));
        when(mapper.toResponse(domain)).thenReturn(response);

        webTestClient
                .mutateWith(mockAuthentication(authentication))
                .get()
                .uri("/vehicles/ownerships/me")
                .exchange()
                .expectStatus().isOk()
                .expectBodyList(VehicleOwnershipResponse.class)
                .contains(response);
    }

    @Test
    void getOwnershipsByVehicleId() {
        UUID id = UUID.randomUUID();
        UUID vehicleId = UUID.randomUUID();
        LocalDateTime now = LocalDateTime.now();

        VehicleOwnership domain = new VehicleOwnership(id, vehicleId, partyId, UsageRole.OWNER, true, now, null);
        VehicleOwnershipResponse response = new VehicleOwnershipResponse(id, vehicleId, partyId, UsageRole.OWNER, true, now, null);

        when(ownershipUseCase.getOwnershipsByVehicleId(vehicleId)).thenReturn(Flux.just(domain));
        when(mapper.toResponse(domain)).thenReturn(response);

        webTestClient
                .mutateWith(mockAuthentication(authentication))
                .get()
                .uri("/vehicles/ownerships/vehicle/{vehicleId}", vehicleId)
                .exchange()
                .expectStatus().isOk()
                .expectBodyList(VehicleOwnershipResponse.class)
                .contains(response);
    }

    @Test
    void getOwnershipsByPartyId() {
        UUID id = UUID.randomUUID();
        UUID vehicleId = UUID.randomUUID();
        LocalDateTime now = LocalDateTime.now();

        VehicleOwnership domain = new VehicleOwnership(id, vehicleId, partyId, UsageRole.OWNER, true, now, null);
        VehicleOwnershipResponse response = new VehicleOwnershipResponse(id, vehicleId, partyId, UsageRole.OWNER, true, now, null);

        when(ownershipUseCase.getOwnershipsByPartyId(partyId)).thenReturn(Flux.just(domain));
        when(mapper.toResponse(domain)).thenReturn(response);

        webTestClient
                .mutateWith(mockAuthentication(authentication))
                .get()
                .uri("/vehicles/ownerships/party/{partyId}", partyId)
                .exchange()
                .expectStatus().isOk()
                .expectBodyList(VehicleOwnershipResponse.class)
                .contains(response);
    }

    @Test
    void getOwnershipById() {
        UUID id = UUID.randomUUID();
        UUID vehicleId = UUID.randomUUID();
        LocalDateTime now = LocalDateTime.now();

        VehicleOwnership domain = new VehicleOwnership(id, vehicleId, partyId, UsageRole.OWNER, true, now, null);
        VehicleOwnershipResponse response = new VehicleOwnershipResponse(id, vehicleId, partyId, UsageRole.OWNER, true, now, null);

        when(ownershipUseCase.getOwnershipById(id)).thenReturn(Mono.just(domain));
        when(mapper.toResponse(domain)).thenReturn(response);

        webTestClient
                .mutateWith(mockAuthentication(authentication))
                .get()
                .uri("/vehicles/ownerships/{id}", id)
                .exchange()
                .expectStatus().isOk()
                .expectBody(VehicleOwnershipResponse.class)
                .isEqualTo(response);
    }

    @Test
    void deleteOwnership() {
        UUID id = UUID.randomUUID();
        UUID vehicleId = UUID.randomUUID();
        LocalDateTime now = LocalDateTime.now();

        VehicleOwnership domain = new VehicleOwnership(id, vehicleId, partyId, UsageRole.OWNER, true, now, null);

        when(ownershipUseCase.getOwnershipById(id)).thenReturn(Mono.just(domain));
        when(ownershipUseCase.deleteOwnership(id)).thenReturn(Mono.empty());

        webTestClient
                .mutateWith(mockAuthentication(authentication))
                .delete()
                .uri("/vehicles/ownerships/{id}", id)
                .exchange()
                .expectStatus().isNoContent();
    }
}
```

---
### Fichier : `./src/main/resources/data.sql`
```sql
-- INSERTION DES DONNÃ‰ES DE RÃ‰FÃ‰RENCE (Seulement si la table est vide ou pour Ã©viter les doublons)

-- 1. Fuel Types
INSERT INTO FuelType (fuel_type_name) VALUES ('Essence') ON CONFLICT DO NOTHING;
INSERT INTO FuelType (fuel_type_name) VALUES ('Diesel') ON CONFLICT DO NOTHING;
INSERT INTO FuelType (fuel_type_name) VALUES ('Electrique') ON CONFLICT DO NOTHING;
INSERT INTO FuelType (fuel_type_name) VALUES ('Hybride') ON CONFLICT DO NOTHING;

-- 2. Manufacturers
INSERT INTO Manufacturer (manufacturer_name) VALUES ('Toyota Factory') ON CONFLICT DO NOTHING;
INSERT INTO Manufacturer (manufacturer_name) VALUES ('Tesla Gigafactory') ON CONFLICT DO NOTHING;
INSERT INTO Manufacturer (manufacturer_name) VALUES ('BMW Group') ON CONFLICT DO NOTHING;

-- 3. Vehicle Makes (Marques)
INSERT INTO VehicleMake (make_name) VALUES ('Toyota') ON CONFLICT DO NOTHING;
INSERT INTO VehicleMake (make_name) VALUES ('Honda') ON CONFLICT DO NOTHING;
INSERT INTO VehicleMake (make_name) VALUES ('Ford') ON CONFLICT DO NOTHING;
INSERT INTO VehicleMake (make_name) VALUES ('Tesla') ON CONFLICT DO NOTHING;
INSERT INTO VehicleMake (make_name) VALUES ('BMW') ON CONFLICT DO NOTHING;
INSERT INTO VehicleMake (make_name) VALUES ('Mercedes') ON CONFLICT DO NOTHING;

-- 4. Transmission Types
INSERT INTO TransmissionType (type_name) VALUES ('Manuelle') ON CONFLICT DO NOTHING;
INSERT INTO TransmissionType (type_name) VALUES ('Automatique') ON CONFLICT DO NOTHING;
INSERT INTO TransmissionType (type_name) VALUES ('SÃ©quentielle') ON CONFLICT DO NOTHING;

-- 5. Vehicle Sizes
INSERT INTO VehicleSize (size_name) VALUES ('Compacte') ON CONFLICT DO NOTHING;
INSERT INTO VehicleSize (size_name) VALUES ('SUV') ON CONFLICT DO NOTHING;
INSERT INTO VehicleSize (size_name) VALUES ('Berline') ON CONFLICT DO NOTHING;
INSERT INTO VehicleSize (size_name) VALUES ('Utilitaire') ON CONFLICT DO NOTHING;

-- 6. Vehicle Types
INSERT INTO VehicleType (type_name) VALUES ('Personnel') ON CONFLICT DO NOTHING;
INSERT INTO VehicleType (type_name) VALUES ('Commercial') ON CONFLICT DO NOTHING;
INSERT INTO VehicleType (type_name) VALUES ('Transport') ON CONFLICT DO NOTHING;

-- 7. Vehicle Models (SimplifiÃ©)
INSERT INTO VehicleModel (model_name) VALUES ('Corolla') ON CONFLICT DO NOTHING;
INSERT INTO VehicleModel (model_name) VALUES ('Yaris') ON CONFLICT DO NOTHING;
INSERT INTO VehicleModel (model_name) VALUES ('Model 3') ON CONFLICT DO NOTHING;
INSERT INTO VehicleModel (model_name) VALUES ('X5') ON CONFLICT DO NOTHING;
INSERT INTO VehicleModel (model_name) VALUES ('Civic') ON CONFLICT DO NOTHING;```

---
### Fichier : `./src/main/resources/application.yml`
```yaml
server:
  port: 8080
  forward-headers-strategy: framework
spring:
  application:
    name: vehicule-service
    
  docker:
    compose:
      enabled: false
  # Configuration Multipart (Uploads)
  webflux:
    multipart:
      max-in-memory-size: 256KB # Taille en RAM avant Ã©criture disque (si besoin)
      max-file-size: 10MB       # Taille max d'un fichier
      max-request-size: 10MB    # Taille max de la requÃªte totale

  # Configuration des Codecs (Pour Ã©viter les erreurs "DataBufferLimitException")
  codec:
    max-in-memory-size: 10MB

  # POSTGRESQL (R2DBC)
  r2dbc:
    url: r2dbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:reactivedb}
    username: ${DB_USERNAME:user}
    password: ${DB_PASSWORD:password}
    pool:
      enabled: true
      initial-size: 1
      max-size: 5
      max-idle-time: 30m
      max-life-time: 10m
      acquire-retry: 3
      max-acquire-time: 30s
      validation-query: SELECT 1
  sql:
    init:
      mode: always

  # REDIS CLUSTER 
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:7000}
      password: ${REDIS_PASSWORD:password}
      cluster:
        enabled: false

  # KAFKA 
  kafka:
    bootstrap-servers: ${KAFKA_HOST:localhost}:${KAFKA_PORT:9092}
    consumer:
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "*"
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer

# CUSTOM CONFIG 
application:
  external:
    stock-service-url: http://${EXTERNAL_HOST:localhost}:8081
    media-service-url: https://media-service.pynfi.com

  kafka:
    topics:
      product-events: product-events-topic

management:
  endpoints:
    web:
      exposure:
        include: ["health","info","prometheus"]
  endpoint:
    health:
      show-details: "always"
      probes:
        enabled: true
  metrics:
    export:
      prometheus:
        enabled: true

# AUTH SERVICE
auth:
  service:
    url: https://auth-service.pynfi.com

# RESILIENCE4J 
resilience4j:
  circuitbreaker:
    instances:
      stock-service:
        failureRateThreshold: 50
        waitDurationInOpenState: 5s
        slidingWindowSize: 5
```

---
### Fichier : `./src/main/resources/schema.sql`
```sql
-- Active l'extension pour gÃ©nÃ©rer des UUIDs, si elle n'est pas dÃ©jÃ  active.
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Supprime les anciennes tables dans l'ordre inverse de la crÃ©ation pour Ã©viter les erreurs de dÃ©pendance.
DROP TABLE IF EXISTS VehicleOwnership CASCADE;
DROP TABLE IF EXISTS VehicleReview CASCADE;
DROP TABLE IF EXISTS VehicleIllustrationImage CASCADE;
DROP TABLE IF EXISTS VehicleCanTransport CASCADE;
DROP TABLE IF EXISTS VehicleKeyword CASCADE;
DROP TABLE IF EXISTS VehicleAmenity CASCADE;
DROP TABLE IF EXISTS Vehicle CASCADE;
DROP TABLE IF EXISTS Party CASCADE;
DROP TABLE IF EXISTS Manufacturer CASCADE;
DROP TABLE IF EXISTS VehicleType CASCADE;
DROP TABLE IF EXISTS FuelType CASCADE;
DROP TABLE IF EXISTS VehicleSize CASCADE;
DROP TABLE IF EXISTS VehicleMake CASCADE;
DROP TABLE IF EXISTS TransmissionType CASCADE;
DROP TABLE IF EXISTS VehicleModel CASCADE;


-- ================================================================================================
-- TABLES DE RÃ‰FÃ‰RENCE (Lookup Tables)
-- Ajout de contraintes UNIQUE pour Ã©viter les doublons lors du "Smart Create"
-- ================================================================================================

CREATE TABLE VehicleModel (
    vehicle_model_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    model_name TEXT NOT NULL UNIQUE, -- Ajout UNIQUE
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ
);

CREATE TABLE TransmissionType (
    transmission_type_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    type_name TEXT NOT NULL UNIQUE, -- Ajout UNIQUE
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ
);

CREATE TABLE VehicleMake (
    vehicle_make_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    make_name TEXT NOT NULL UNIQUE -- Ajout UNIQUE
);

CREATE TABLE VehicleSize (
    vehicle_size_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    size_name TEXT NOT NULL UNIQUE, -- Ajout UNIQUE
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ
);

CREATE TABLE FuelType (
    fuel_type_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    fuel_type_name TEXT NOT NULL UNIQUE -- Ajout UNIQUE
);

CREATE TABLE VehicleType (
    vehicle_type_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    type_name TEXT NOT NULL UNIQUE -- Ajout UNIQUE
);

CREATE TABLE Manufacturer (
    manufacturer_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    manufacturer_name TEXT NOT NULL UNIQUE -- Ajout UNIQUE
);

-- ================================================================================================
-- TABLE POUR LES PROPRIÃ‰TAIRES / UTILISATEURS (Parties)
-- ================================================================================================

CREATE TABLE Party (
    party_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    party_type TEXT NOT NULL CHECK (party_type IN ('FREELANCE_DRIVER', 'FREELANCE_DELIVERER', 'RENTAL_AGENCY', 'TRAVEL_AGENCY', 'DELIVERY_AGENCY')),
    display_name TEXT NOT NULL,
    phone TEXT,
    email TEXT
);


-- ================================================================================================
-- TABLE PRINCIPALE (Vehicle)
-- ================================================================================================

CREATE TABLE Vehicle (
    vehicle_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),

    -- ClÃ©s Ã©trangÃ¨res vers les tables de rÃ©fÃ©rence
    vehicle_make_id UUID REFERENCES VehicleMake(vehicle_make_id),
    vehicle_model_id UUID REFERENCES VehicleModel(vehicle_model_id),
    transmission_type_id UUID REFERENCES TransmissionType(transmission_type_id),
    manufacturer_id UUID REFERENCES Manufacturer(manufacturer_id),
    vehicle_size_id UUID REFERENCES VehicleSize(vehicle_size_id),
    vehicle_type_id UUID REFERENCES VehicleType(vehicle_type_id),
    fuel_type_id UUID REFERENCES FuelType(fuel_type_id),

    -- Informations d'identification du vÃ©hicule
    vehicle_serial_number TEXT UNIQUE,
    vehicle_serial_photo TEXT,
    registration_number TEXT,
    registration_photo TEXT,
    registration_expiry_date TIMESTAMPTZ,

    -- CaractÃ©ristiques techniques
    tank_capacity NUMERIC,
    luggage_max_capacity NUMERIC,
    total_seat_number INTEGER,

    -- DonnÃ©es de consommation et d'usage
    average_fuel_consumption_per_km NUMERIC,
    mileage_at_start NUMERIC,
    mileage_since_commissioning NUMERIC,
    vehicle_age_at_start NUMERIC,

    -- MÃ©tadonnÃ©es
    brand TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ
);


-- ================================================================================================
-- TABLES DE DÃ‰TAILS (Join Tables)
-- ================================================================================================

CREATE TABLE VehicleAmenity (
    vehicle_amenity_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    vehicle_id UUID NOT NULL REFERENCES Vehicle(vehicle_id) ON DELETE CASCADE,
    amenity_name TEXT NOT NULL,
    UNIQUE (vehicle_id, amenity_name)
);

CREATE TABLE VehicleKeyword (
    vehicle_keyword_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    vehicle_id UUID NOT NULL REFERENCES Vehicle(vehicle_id) ON DELETE CASCADE,
    keyword TEXT NOT NULL,
    UNIQUE (vehicle_id, keyword)
);

CREATE TABLE VehicleCanTransport (
    vehicle_can_transport_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    vehicle_id UUID NOT NULL REFERENCES Vehicle(vehicle_id) ON DELETE CASCADE,
    item TEXT NOT NULL,
    UNIQUE (vehicle_id, item)
);

CREATE TABLE VehicleIllustrationImage (
    vehicle_illustration_image_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    vehicle_id UUID NOT NULL REFERENCES Vehicle(vehicle_id) ON DELETE CASCADE,
    image_path TEXT NOT NULL,
    UNIQUE (vehicle_id, image_path)
);

CREATE TABLE VehicleReview (
    review_id UUID PRIMARY KEY,
    vehicle_id UUID NOT NULL REFERENCES Vehicle(vehicle_id) ON DELETE CASCADE
);

-- ================================================================================================
-- TABLE DE LIEN ENTRE VÃ‰HICULES ET PROPRIÃ‰TAIRES
-- ================================================================================================

CREATE TABLE VehicleOwnership (
    vehicle_ownership_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    vehicle_id UUID NOT NULL REFERENCES Vehicle(vehicle_id) ON DELETE CASCADE,
    party_id UUID NOT NULL,
    usage_role TEXT NOT NULL CHECK (usage_role IN ('DRIVER', 'LOGISTICS', 'FLEET', 'OWNER')),
    is_primary BOOLEAN DEFAULT false,
    valid_from TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    valid_to TIMESTAMPTZ
);

-- Index pour garantir qu'une Party n'a qu'un seul vÃ©hicule principal pour un rÃ´le donnÃ©
CREATE UNIQUE INDEX idx_unique_primary_vehicle_per_role ON VehicleOwnership (party_id, usage_role) WHERE is_primary = true;```

---
### Fichier : `./src/main/resources/prod.application.yml`
```yaml
server:
  port: 8080

spring:
  application:
    name: vehicule-service
    forward-headers-strategy: framework
    
  docker:
    compose:
      enabled: false
  # Configuration Multipart (Uploads)
  webflux:
    multipart:
      max-in-memory-size: 256KB # Taille en RAM avant Ã©criture disque (si besoin)
      max-file-size: 10MB       # Taille max d'un fichier
      max-request-size: 10MB    # Taille max de la requÃªte totale

  # Configuration des Codecs (Pour Ã©viter les erreurs "DataBufferLimitException")
  codec:
    max-in-memory-size: 10MB

  # POSTGRESQL (R2DBC)
  r2dbc:
    url: r2dbc:postgresql://${DB_HOST:localhost}:${DB_PORT:5432}/${DB_NAME:payment_db}
    username: ${DB_USERNAME:postgres}
    password: ${DB_PASSWORD:password}
    pool:
      enabled: true
      initial-size: 1
      max-size: 5
      max-idle-time: 30m
      max-life-time: 10m
      acquire-retry: 3
      max-acquire-time: 30s
      validation-query: SELECT 1
  sql:
    init:
      mode: always

  # REDIS CLUSTER 
  data:
    redis:
      password: ${REDIS_PASSWORD:password}
      cluster:
        nodes:
          - ${REDIS_HOST:localhost}:7001
          - ${REDIS_HOST:localhost}:7002
          - ${REDIS_HOST:localhost}:7003
          - ${REDIS_HOST:localhost}:7004
          - ${REDIS_HOST:localhost}:7005
          - ${REDIS_HOST:localhost}:7006

  # KAFKA 
  kafka:
    bootstrap-servers: ${KAFKA_HOST:localhost}:${KAFKA_PORT:9092}
    consumer:
      auto-offset-reset: earliest
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.springframework.kafka.support.serializer.JsonDeserializer
      properties:
        spring.json.trusted.packages: "*"
    producer:
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.springframework.kafka.support.serializer.JsonSerializer

# CUSTOM CONFIG 
application:
  external:
    stock-service-url: http://${EXTERNAL_HOST:localhost}:8081
    media-service-url: https://media-service.pynfi.com

  kafka:
    topics:
      product-events: test-topic

management:
  endpoints:
    web:
      exposure:
        include: ["health","info","prometheus"]
  endpoint:
    health:
      show-details: "always"
      probes:
        enabled: true
  metrics:
    export:
      prometheus:
        enabled: true

# RESILIENCE4J 
resilience4j:
  circuitbreaker:
    instances:
      stock-service:
        failureRateThreshold: 50
        waitDurationInOpenState: 5s
        slidingWindowSize: 5
```

---
### Fichier : `./src/main/java/com/yowyob/template/TemplateApplication.java`
```java
package com.yowyob.template;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class TemplateApplication {

	public static void main(String[] args) {
		SpringApplication.run(TemplateApplication.class, args);
	}

}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/mappers/VehicleDetailsMapper.java`
```java
package com.yowyob.template.infrastructure.mappers;

import org.mapstruct.Mapper;

import com.yowyob.template.domain.model.vehicle.details.VehicleAmenity;
import com.yowyob.template.domain.model.vehicle.details.VehicleCanTransport;
import com.yowyob.template.domain.model.vehicle.details.VehicleIllustrationImage;
import com.yowyob.template.domain.model.vehicle.details.VehicleKeyword;
import com.yowyob.template.domain.model.vehicle.details.VehicleReview;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details.VehicleAmenityRequest;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details.VehicleAmenityResponse;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details.VehicleCanTransportRequest;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details.VehicleCanTransportResponse;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details.VehicleIllustrationImageRequest;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details.VehicleIllustrationImageResponse;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details.VehicleKeywordRequest;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details.VehicleKeywordResponse;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details.VehicleReviewRequest;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details.VehicleReviewResponse;

import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.*;

@Mapper(componentModel = "spring")
public interface VehicleDetailsMapper {

    VehicleAmenity toDomain(VehicleAmenityRequest request);

    VehicleAmenityResponse toResponse(VehicleAmenity domain);

    VehicleAmenityEntity toEntity(VehicleAmenity domain);

    VehicleAmenity toDomain(VehicleAmenityEntity entity);

    VehicleKeyword toDomain(VehicleKeywordRequest request);

    VehicleKeywordResponse toResponse(VehicleKeyword domain);

    VehicleKeywordEntity toEntity(VehicleKeyword domain);

    VehicleKeyword toDomain(VehicleKeywordEntity entity);

    VehicleCanTransport toDomain(VehicleCanTransportRequest request);

    VehicleCanTransportResponse toResponse(VehicleCanTransport domain);

    VehicleCanTransportEntity toEntity(VehicleCanTransport domain);

    VehicleCanTransport toDomain(VehicleCanTransportEntity entity);

    VehicleIllustrationImage toDomain(VehicleIllustrationImageRequest request);

    VehicleIllustrationImageResponse toResponse(VehicleIllustrationImage domain);

    VehicleIllustrationImageEntity toEntity(VehicleIllustrationImage domain);

    VehicleIllustrationImage toDomain(VehicleIllustrationImageEntity entity);

    VehicleReview toDomain(VehicleReviewRequest request);

    VehicleReviewResponse toResponse(VehicleReview domain);

    VehicleReviewEntity toEntity(VehicleReview domain);

    VehicleReview toDomain(VehicleReviewEntity entity);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/mappers/TransmissionTypeMapper.java`
```java
package com.yowyob.template.infrastructure.mappers;

import org.mapstruct.Mapper;
import org.mapstruct.Mapping;

import com.yowyob.template.domain.model.vehicle.TransmissionType;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup.TransmissionTypeRequest;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup.TransmissionTypeResponse;
import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.TransmissionTypeEntity;

@Mapper(componentModel = "spring")
public interface TransmissionTypeMapper {

    @Mapping(target = "transmissionTypeId", ignore = true)
    @Mapping(target = "createdAt", ignore = true)
    @Mapping(target = "updatedAt", ignore = true)
    TransmissionType toDomain(TransmissionTypeRequest request);

    TransmissionTypeResponse toResponse(TransmissionType domain);

    @Mapping(target = "transmissionTypeId", ignore = true)
    TransmissionTypeEntity toEntity(TransmissionType domain);

    TransmissionType toDomain(TransmissionTypeEntity entity);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/mappers/VehicleTypeMapper.java`
```java
package com.yowyob.template.infrastructure.mappers;

import org.mapstruct.Mapper;
import org.mapstruct.Mapping;

import com.yowyob.template.domain.model.vehicle.VehicleType;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup.VehicleTypeRequest;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup.VehicleTypeResponse;
import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.VehicleTypeEntity;

@Mapper(componentModel = "spring")
public interface VehicleTypeMapper {

    @Mapping(target = "vehicleTypeId", ignore = true)
    VehicleType toDomain(VehicleTypeRequest request);

    VehicleTypeResponse toResponse(VehicleType domain);

    @Mapping(target = "vehicleTypeId", ignore = true)
    VehicleTypeEntity toEntity(VehicleType domain);

    VehicleType toDomain(VehicleTypeEntity entity);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/mappers/PartyMapper.java`
```java
package com.yowyob.template.infrastructure.mappers;

import org.mapstruct.Mapper;
import org.mapstruct.Mapping;

import com.yowyob.template.domain.model.party.Party;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.party.PartyRequest;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.party.PartyResponse;
import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.PartyEntity;

@Mapper(componentModel = "spring")
public interface PartyMapper {

    @Mapping(target = "partyId", ignore = true)
    Party toDomain(PartyRequest request);

    PartyResponse toResponse(Party domain);

    @Mapping(target = "partyId", ignore = true)
    PartyEntity toEntity(Party domain);

    Party toDomain(PartyEntity entity);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/mappers/VehicleMapper.java`
```java
package com.yowyob.template.infrastructure.mappers;

import org.mapstruct.Mapper;
import org.mapstruct.Mapping;

import com.yowyob.template.domain.model.vehicle.Vehicle;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.VehicleRequest;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.VehicleResponse;
import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.VehicleEntity;

@Mapper(componentModel = "spring")
public interface VehicleMapper {

    @Mapping(target = "vehicleId", ignore = true)
    @Mapping(target = "createdAt", ignore = true)
    @Mapping(target = "updatedAt", ignore = true)
    @Mapping(target = "registrationExpiryDate", ignore = true)
    Vehicle toDomain(VehicleRequest request);

    VehicleResponse toResponse(Vehicle domain);
    @Mapping(target = "createdAt", ignore = true) // CrÃ©Ã© par DB/Auditing
    @Mapping(target = "updatedAt", ignore = true) // Mise Ã  jour automatique
    VehicleEntity toEntity(Vehicle domain);

    Vehicle toDomain(VehicleEntity entity);
}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/mappers/VehicleOwnershipMapper.java`
```java
package com.yowyob.template.infrastructure.mappers;

import org.mapstruct.Mapper;
import org.mapstruct.Mapping;

import com.yowyob.template.domain.model.vehicle.ownership.VehicleOwnership;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.ownership.VehicleOwnershipRequest;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.ownership.VehicleOwnershipResponse;
import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.VehicleOwnershipEntity;

@Mapper(componentModel = "spring")
public interface VehicleOwnershipMapper {

    @Mapping(target = "vehicleOwnershipId", ignore = true)
    @Mapping(target = "partyId", ignore = true)
    VehicleOwnership toDomain(VehicleOwnershipRequest request);

    VehicleOwnershipResponse toResponse(VehicleOwnership domain);

    @Mapping(target = "vehicleOwnershipId", ignore = true)
    VehicleOwnershipEntity toEntity(VehicleOwnership domain);

    VehicleOwnership toDomain(VehicleOwnershipEntity entity);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/mappers/ManufacturerMapper.java`
```java
package com.yowyob.template.infrastructure.mappers;

import org.mapstruct.Mapper;
import org.mapstruct.Mapping;

import com.yowyob.template.domain.model.vehicle.Manufacturer;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup.ManufacturerRequest;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup.ManufacturerResponse;
import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.ManufacturerEntity;

@Mapper(componentModel = "spring")
public interface ManufacturerMapper {

    @Mapping(target = "manufacturerId", ignore = true)
    Manufacturer toDomain(ManufacturerRequest request);

    ManufacturerResponse toResponse(Manufacturer domain);

    @Mapping(target = "manufacturerId", ignore = true)
    ManufacturerEntity toEntity(Manufacturer domain);

    Manufacturer toDomain(ManufacturerEntity entity);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/mappers/ProductMapper.java`
```java
package com.yowyob.template.infrastructure.mappers;

import com.yowyob.template.domain.model.Product;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.ProductRequest;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.ProductResponse;
import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.ProductEntity;
import org.mapstruct.Mapper;

@Mapper(componentModel = "spring")
public interface ProductMapper {
    Product toDomain(ProductRequest request);
    ProductResponse toResponse(Product domain);
    
    ProductEntity toEntity(Product domain);
    Product toDomain(ProductEntity entity);
}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/mappers/VehicleModelMapper.java`
```java
package com.yowyob.template.infrastructure.mappers;

import com.yowyob.template.domain.model.vehicle.VehicleModel;
import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.VehicleModelEntity;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup.VehicleModelRequest;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup.VehicleModelResponse;

import org.mapstruct.Mapper;
import org.mapstruct.Mapping;

@Mapper(componentModel = "spring")
public interface VehicleModelMapper {

    @Mapping(target = "vehicleModelId", ignore = true)
    @Mapping(target = "createdAt", ignore = true)
    @Mapping(target = "updatedAt", ignore = true)
    VehicleModel toDomain(VehicleModelRequest request);

    VehicleModelResponse toResponse(VehicleModel domain);

    @Mapping(target = "vehicleModelId", ignore = true)
    VehicleModelEntity toEntity(VehicleModel domain);

    VehicleModel toDomain(VehicleModelEntity entity);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/mappers/VehicleSizeMapper.java`
```java
package com.yowyob.template.infrastructure.mappers;

import org.mapstruct.Mapper;
import org.mapstruct.Mapping;

import com.yowyob.template.domain.model.vehicle.VehicleSize;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup.VehicleSizeRequest;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup.VehicleSizeResponse;
import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.VehicleSizeEntity;

@Mapper(componentModel = "spring")
public interface VehicleSizeMapper {

    @Mapping(target = "vehicleSizeId", ignore = true)
    @Mapping(target = "createdAt", ignore = true)
    @Mapping(target = "updatedAt", ignore = true)
    VehicleSize toDomain(VehicleSizeRequest request);

    VehicleSizeResponse toResponse(VehicleSize domain);

    @Mapping(target = "vehicleSizeId", ignore = true)
    VehicleSizeEntity toEntity(VehicleSize domain);

    VehicleSize toDomain(VehicleSizeEntity entity);

}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/mappers/FuelTypeMapper.java`
```java
package com.yowyob.template.infrastructure.mappers;

import org.mapstruct.Mapper;
import org.mapstruct.Mapping;

import com.yowyob.template.domain.model.vehicle.FuelType;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup.FuelTypeRequest;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup.FuelTypeResponse;
import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.FuelTypeEntity;

@Mapper(componentModel = "spring")
public interface FuelTypeMapper {

    @Mapping(target = "fuelTypeId", ignore = true)
    FuelType toDomain(FuelTypeRequest request);

    FuelTypeResponse toResponse(FuelType domain);

    @Mapping(target = "fuelTypeId", ignore = true)
    FuelTypeEntity toEntity(FuelType domain);

    FuelType toDomain(FuelTypeEntity entity);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/mappers/VehicleMakeMapper.java`
```java
package com.yowyob.template.infrastructure.mappers;

import org.mapstruct.Mapper;
import org.mapstruct.Mapping;

import com.yowyob.template.domain.model.vehicle.VehicleMake;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup.VehicleMakeRequest;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup.VehicleMakeResponse;
import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.VehicleMakeEntity;

@Mapper(componentModel = "spring")
public interface VehicleMakeMapper {

    @Mapping(target = "vehicleMakeId", ignore = true)
    VehicleMake toDomain(VehicleMakeRequest request);

    VehicleMakeResponse toResponse(VehicleMake domain);

    @Mapping(target = "vehicleMakeId", ignore = true)
    VehicleMakeEntity toEntity(VehicleMake domain);

    VehicleMake toDomain(VehicleMakeEntity entity);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/external/dto/MediaServiceResponse.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.external.dto;

import java.util.UUID;

public record MediaServiceResponse(
    UUID id,
    String uri,
    String name,
    String path,
    String mime,
    Long size
) {}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/external/StockAdapter.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.external;

import com.yowyob.template.domain.ports.out.StockClientPort;
import com.yowyob.template.infrastructure.adapters.outbound.external.client.StockApiClient;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.cloud.client.circuitbreaker.ReactiveCircuitBreaker;
import org.springframework.cloud.client.circuitbreaker.ReactiveCircuitBreakerFactory;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Mono;

@Component
@Slf4j
@RequiredArgsConstructor
public class StockAdapter implements StockClientPort {

    private final StockApiClient client;
    private final ReactiveCircuitBreakerFactory<?, ?> cbFactory;

    @Override
    public Mono<Boolean> isStockFull(String productName) {
        ReactiveCircuitBreaker rcb = cbFactory.create("stock-service");

        return rcb.run(
                client.checkStock(productName).map(StockApiClient.StockResponse::full),
                throwable -> fallbackStockCheck(productName, throwable)
        );
    }

    private Mono<Boolean> fallbackStockCheck(String productName, Throwable t) {
        log.warn("Circuit Breaker open or Service Down for {}. Error: {}", productName, t.getMessage());
        // Fallback: if the service is down, consider the stock not full
        return Mono.just(false);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/external/client/StockApiClient.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.external.client;

import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.service.annotation.GetExchange;
import org.springframework.web.service.annotation.HttpExchange;
import reactor.core.publisher.Mono;

@HttpExchange("/api/stock")
public interface StockApiClient {
    @GetExchange("/check")
    Mono<StockResponse> checkStock(@RequestParam("name") String name);

    record StockResponse(boolean full) {}
}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/external/HttpMediaAdapter.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.external;

import com.yowyob.template.domain.ports.out.MediaStoragePort;
import com.yowyob.template.infrastructure.adapters.outbound.external.dto.MediaServiceResponse;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.MediaType;
import org.springframework.http.client.MultipartBodyBuilder;
import org.springframework.http.codec.multipart.FilePart;
import org.springframework.stereotype.Component;
import org.springframework.web.reactive.function.BodyInserters;
import org.springframework.web.reactive.function.client.WebClient;
import reactor.core.publisher.Mono;

@Slf4j
@Component
@RequiredArgsConstructor
public class HttpMediaAdapter implements MediaStoragePort {

    private final WebClient.Builder webClientBuilder;

    @Value("${application.external.media-service-url}")
    private String mediaServiceUrl;

    @Override
    public Mono<MediaServiceResponse> upload(FilePart file, String location) {
        WebClient client = webClientBuilder.baseUrl(mediaServiceUrl).build();

        MultipartBodyBuilder builder = new MultipartBodyBuilder();
        builder.part("file", file);
        builder.part("service", "fleet-service");
        builder.part("location", location);

        return client.post()
                .uri("/media/upload")
                .contentType(MediaType.MULTIPART_FORM_DATA)
                .body(BodyInserters.fromMultipartData(builder.build()))
                .retrieve()
                .bodyToMono(MediaServiceResponse.class)
                .doOnSuccess(r -> log.info("Upload rÃ©ussi: {}", r.uri()))
                .doOnError(e -> log.error("Erreur upload MediaService", e));
    }

    @Override
    public Mono<Void> delete(String mediaId) {
        if (mediaId == null || mediaId.isBlank()) return Mono.empty();
        
        WebClient client = webClientBuilder.baseUrl(mediaServiceUrl).build();
        return client.delete()
                .uri("/media/{id}", mediaId)
                .retrieve()
                .bodyToMono(Void.class)
                .doOnError(e -> log.warn("Erreur suppression MediaService (ID: {}): {}", mediaId, e.getMessage()))
                .onErrorResume(e -> Mono.empty()); // On ne bloque pas si le fichier n'existe plus
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/messaging/KafkaAdapter.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.messaging;

import com.yowyob.template.domain.model.Product;
import com.yowyob.template.domain.ports.out.ProductEventPublisherPort;
import lombok.RequiredArgsConstructor;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.kafka.core.reactive.ReactiveKafkaProducerTemplate;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Mono;

@Component
@RequiredArgsConstructor
public class KafkaAdapter implements ProductEventPublisherPort {

    private final ReactiveKafkaProducerTemplate<String, Object> kafkaTemplate;

    @Value("${application.kafka.topics.product-events}")
    private String productEventsTopic;

    @Override
    public Mono<Void> publishProductCreated(Product product) {
        return kafkaTemplate.send(productEventsTopic, product.id().toString(), product)
                .then();
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/entity/VehicleOwnershipEntity.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.entity;

import com.yowyob.template.domain.model.vehicle.ownership.UsageRole;
import lombok.Builder;
import lombok.Data;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;

import java.time.LocalDateTime;
import java.util.UUID;

@Data
@Builder
@Table(name = "VehicleOwnership")
public class VehicleOwnershipEntity {

    @Id
    @Column("vehicle_ownership_id")
    private UUID vehicleOwnershipId;

    @Column("vehicle_id")
    private UUID vehicleId;

    @Column("party_id")
    private UUID partyId;

    @Column("usage_role")
    private UsageRole usageRole;

    @Column("is_primary")
    private boolean isPrimary;

    @Column("valid_from")
    private LocalDateTime validFrom;

    @Column("valid_to")
    private LocalDateTime validTo;
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/entity/VehicleCanTransportEntity.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.entity;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;

import java.util.UUID;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Table(name = "VehicleCanTransport")
public class VehicleCanTransportEntity {

    @Id
    @Column("vehicle_can_transport_id")
    private UUID vehicleCanTransportId;

    @Column("vehicle_id")
    private UUID vehicleId;

    @Column("item")
    private String item;
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/entity/FuelTypeEntity.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.entity;

import lombok.Builder;
import lombok.Data;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;

import java.util.UUID;

@Data
@Builder
@Table(name = "FuelType")
public class FuelTypeEntity {

    @Id
    @Column("fuel_type_id")
    private UUID fuelTypeId;

    @Column("fuel_type_name")
    private String fuelTypeName;
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/entity/VehicleReviewEntity.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.entity;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;

import java.util.UUID;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Table(name = "VehicleReview")
public class VehicleReviewEntity {

    @Column("vehicle_id")
    private UUID vehicleId;

    @Id
    @Column("review_id")
    private UUID reviewId;
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/entity/VehicleSizeEntity.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.entity;

import lombok.Builder;
import lombok.Data;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.annotation.Id;
import org.springframework.data.annotation.LastModifiedDate;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;

import java.time.LocalDateTime;
import java.util.UUID;

@Data
@Builder
@Table(name = "VehicleSize")
public class VehicleSizeEntity {

    @Id
    @Column("vehicle_size_id")
    private UUID vehicleSizeId;

    @Column("size_name")
    private String sizeName;

    @CreatedDate
    @Column("created_at")
    private LocalDateTime createdAt;

    @LastModifiedDate
    @Column("updated_at")
    private LocalDateTime updatedAt;
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/entity/ManufacturerEntity.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.entity;

import lombok.Builder;
import lombok.Data;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;

import java.util.UUID;

@Data
@Builder
@Table(name = "Manufacturer")
public class ManufacturerEntity {

    @Id
    @Column("manufacturer_id")
    private UUID manufacturerId;

    @Column("manufacturer_name")
    private String manufacturerName;
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/entity/PartyEntity.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.entity;

import com.yowyob.template.domain.model.party.PartyType;
import lombok.Builder;
import lombok.Data;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;

import java.util.UUID;

@Data
@Builder
@Table(name = "Party")
public class PartyEntity {

    @Id
    @Column("party_id")
    private UUID partyId;

    @Column("party_type")
    private PartyType partyType;

    @Column("display_name")
    private String displayName;

    @Column("phone")
    private String phone;

    @Column("email")
    private String email;
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/entity/TransmissionTypeEntity.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.entity;

import lombok.Builder;
import lombok.Data;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.annotation.Id;
import org.springframework.data.annotation.LastModifiedDate;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;

import java.time.LocalDateTime;
import java.util.UUID;

@Data
@Builder
@Table(name = "TransmissionType")
public class TransmissionTypeEntity {

    @Id
    @Column("transmission_type_id")
    private UUID transmissionTypeId;

    @Column("type_name")
    private String typeName;

    @CreatedDate
    @Column("created_at")
    private LocalDateTime createdAt;

    @LastModifiedDate
    @Column("updated_at")
    private LocalDateTime updatedAt;
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/entity/VehicleTypeEntity.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.entity;

import lombok.Builder;
import lombok.Data;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;

import java.util.UUID;

@Data
@Builder
@Table(name = "VehicleType")
public class VehicleTypeEntity {

    @Id
    @Column("vehicle_type_id")
    private UUID vehicleTypeId;

    @Column("type_name")
    private String typeName;
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/entity/VehicleKeywordEntity.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.entity;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;

import java.util.UUID;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Table(name = "VehicleKeyword")
public class VehicleKeywordEntity {

    @Id
    @Column("vehicle_keyword_id")
    private UUID vehicleKeywordId;

    @Column("vehicle_id")
    private UUID vehicleId;

    @Column("keyword")
    private String keyword;
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/entity/VehicleEntity.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.entity;

import lombok.Builder;
import lombok.Data;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.annotation.Id;
import org.springframework.data.annotation.LastModifiedDate;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.UUID;

@Data
@Builder
@Table(name = "Vehicle")
public class VehicleEntity {

    @Id
    @Column("vehicle_id")
    private UUID vehicleId;

    // --- Foreign Keys ---
    @Column("vehicle_make_id")
    private UUID vehicleMakeId;

    @Column("vehicle_model_id")
    private UUID vehicleModelId;

    @Column("transmission_type_id")
    private UUID transmissionTypeId;

    @Column("manufacturer_id")
    private UUID manufacturerId;

    @Column("vehicle_size_id")
    private UUID vehicleSizeId;

    @Column("vehicle_type_id")
    private UUID vehicleTypeId;

    @Column("fuel_type_id")
    private UUID fuelTypeId;

    // --- Identification ---
    @Column("vehicle_serial_number")
    private String vehicleSerialNumber;

    @Column("vehicle_serial_photo")
    private String vehicleSerialPhoto;

    @Column("registration_number")
    private String registrationNumber;

    @Column("registration_photo")
    private String registrationPhoto;

    @Column("registration_expiry_date")
    private LocalDateTime registrationExpiryDate;

    // --- Technical Characteristics ---
    @Column("tank_capacity")
    private BigDecimal tankCapacity;

    @Column("luggage_max_capacity")
    private BigDecimal luggageMaxCapacity;

    @Column("total_seat_number")
    private Integer totalSeatNumber;

    // --- Usage / Consumption Data ---
    @Column("average_fuel_consumption_per_km")
    private BigDecimal averageFuelConsumptionPerKm;

    @Column("mileage_at_start")
    private BigDecimal mileageAtStart;

    @Column("mileage_since_commissioning")
    private BigDecimal mileageSinceCommissioning;

    @Column("vehicle_age_at_start")
    private BigDecimal vehicleAgeAtStart;

    // --- Metadata ---
    @Column("brand")
    private String brand;

    @CreatedDate
    @Column("created_at")
    private LocalDateTime createdAt;

    @LastModifiedDate
    @Column("updated_at")
    private LocalDateTime updatedAt;
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/entity/VehicleAmenityEntity.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.entity;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;

import java.util.UUID;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Table(name = "VehicleAmenity")
public class VehicleAmenityEntity {

    @Id
    @Column("vehicle_amenity_id")
    private UUID vehicleAmenityId;

    @Column("vehicle_id")
    private UUID vehicleId;

    @Column("amenity_name")
    private String amenityName;
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/entity/ProductEntity.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.entity;

import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Table;
import java.math.BigDecimal;
import java.util.UUID;

@Table("products")
@Data @NoArgsConstructor @AllArgsConstructor
public class ProductEntity {
    @Id
    private UUID id;
    private String name;
    private BigDecimal price;
    private String status;
}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/entity/VehicleModelEntity.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.entity;

import lombok.Builder;
import lombok.Data;
import org.springframework.data.annotation.CreatedDate;
import org.springframework.data.annotation.Id;
import org.springframework.data.annotation.LastModifiedDate;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;

import java.time.LocalDateTime;
import java.util.UUID;

@Data
@Builder
@Table(name = "VehicleModel")
public class VehicleModelEntity {

    @Id
    @Column("vehicle_model_id")
    private UUID vehicleModelId;

    @Column("model_name")
    private String modelName;

    @CreatedDate
    @Column("created_at")
    private LocalDateTime createdAt;

    @LastModifiedDate
    @Column("updated_at")
    private LocalDateTime updatedAt;
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/entity/VehicleIllustrationImageEntity.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.entity;

import lombok.AllArgsConstructor;
import lombok.Builder;
import lombok.Data;
import lombok.NoArgsConstructor;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;

import java.util.UUID;

@Data
@Builder
@NoArgsConstructor
@AllArgsConstructor
@Table(name = "VehicleIllustrationImage")
public class VehicleIllustrationImageEntity {

    @Id
    @Column("vehicle_illustration_image_id")
    private UUID vehicleIllustrationImageId;

    @Column("vehicle_id")
    private UUID vehicleId;

    @Column("image_path")
    private String imagePath;
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/entity/VehicleMakeEntity.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.entity;

import lombok.Builder;
import lombok.Data;
import org.springframework.data.annotation.Id;
import org.springframework.data.relational.core.mapping.Column;
import org.springframework.data.relational.core.mapping.Table;

import java.util.UUID;

@Data
@Builder
@Table(name = "VehicleMake")
public class VehicleMakeEntity {

    @Id
    @Column("vehicle_make_id")
    private UUID vehicleMakeId;

    @Column("make_name")
    private String makeName;
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/PostgreVehicleLookupAdapter.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence;

import com.yowyob.template.domain.model.vehicle.*;
import com.yowyob.template.domain.ports.out.VehicleLookupRepositoryPort;
import com.yowyob.template.infrastructure.adapters.outbound.persistence.repository.*;
import com.yowyob.template.infrastructure.mappers.*;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

@Component
@RequiredArgsConstructor
public class PostgreVehicleLookupAdapter implements VehicleLookupRepositoryPort {

    private final FuelTypeR2dbcRepository fuelTypeRepository;
    private final ManufacturerR2dbcRepository manufacturerRepository;
    private final TransmissionTypeR2dbcRepository transmissionTypeRepository;
    private final VehicleMakeR2dbcRepository vehicleMakeRepository;
    private final VehicleModelR2dbcRepository vehicleModelRepository;
    private final VehicleSizeR2dbcRepository vehicleSizeRepository;
    private final VehicleTypeR2dbcRepository vehicleTypeRepository;

    private final FuelTypeMapper fuelTypeMapper;
    private final ManufacturerMapper manufacturerMapper;
    private final TransmissionTypeMapper transmissionTypeMapper;
    private final VehicleMakeMapper vehicleMakeMapper;
    private final VehicleModelMapper vehicleModelMapper;
    private final VehicleSizeMapper vehicleSizeMapper;
    private final VehicleTypeMapper vehicleTypeMapper;

    // FuelType
    @Override
    public Mono<FuelType> saveFuelType(FuelType fuelType) {
        var entity = fuelTypeMapper.toEntity(fuelType);
        if (fuelType.fuelTypeId() != null) {
            entity.setFuelTypeId(fuelType.fuelTypeId());
        }
        return fuelTypeRepository.save(entity)
                .map(fuelTypeMapper::toDomain);
    }

    @Override
    public Flux<FuelType> findAllFuelTypes() {
        return fuelTypeRepository.findAll()
                .map(fuelTypeMapper::toDomain);
    }

    @Override
    public Mono<FuelType> findFuelTypeById(java.util.UUID id) {
        return fuelTypeRepository.findById(id)
                .map(fuelTypeMapper::toDomain);
    }

    @Override
    public Mono<Void> deleteFuelType(java.util.UUID id) {
        return fuelTypeRepository.deleteById(id);
    }

    // Manufacturer
    @Override
    public Mono<Manufacturer> saveManufacturer(Manufacturer manufacturer) {
        var entity = manufacturerMapper.toEntity(manufacturer);
        if (manufacturer.manufacturerId() != null) {
            entity.setManufacturerId(manufacturer.manufacturerId());
        }
        return manufacturerRepository.save(entity)
                .map(manufacturerMapper::toDomain);
    }

    @Override
    public Flux<Manufacturer> findAllManufacturers() {
        return manufacturerRepository.findAll()
                .map(manufacturerMapper::toDomain);
    }

    @Override
    public Mono<Manufacturer> findManufacturerById(java.util.UUID id) {
        return manufacturerRepository.findById(id)
                .map(manufacturerMapper::toDomain);
    }

    @Override
    public Mono<Void> deleteManufacturer(java.util.UUID id) {
        return manufacturerRepository.deleteById(id);
    }

    // TransmissionType
    @Override
    public Mono<TransmissionType> saveTransmissionType(TransmissionType transmissionType) {
        var entity = transmissionTypeMapper.toEntity(transmissionType);
        if (transmissionType.transmissionTypeId() != null) {
            entity.setTransmissionTypeId(transmissionType.transmissionTypeId());
        }
        return transmissionTypeRepository.save(entity)
                .map(transmissionTypeMapper::toDomain);
    }

    @Override
    public Flux<TransmissionType> findAllTransmissionTypes() {
        return transmissionTypeRepository.findAll()
                .map(transmissionTypeMapper::toDomain);
    }

    @Override
    public Mono<TransmissionType> findTransmissionTypeById(java.util.UUID id) {
        return transmissionTypeRepository.findById(id)
                .map(transmissionTypeMapper::toDomain);
    }

    @Override
    public Mono<Void> deleteTransmissionType(java.util.UUID id) {
        return transmissionTypeRepository.deleteById(id);
    }

    // VehicleMake
    @Override
    public Mono<VehicleMake> saveVehicleMake(VehicleMake vehicleMake) {
        var entity = vehicleMakeMapper.toEntity(vehicleMake);
        if (vehicleMake.vehicleMakeId() != null) {
            entity.setVehicleMakeId(vehicleMake.vehicleMakeId());
        }
        return vehicleMakeRepository.save(entity)
                .map(vehicleMakeMapper::toDomain);
    }

    @Override
    public Flux<VehicleMake> findAllVehicleMakes() {
        return vehicleMakeRepository.findAll()
                .map(vehicleMakeMapper::toDomain);
    }

    @Override
    public Mono<VehicleMake> findVehicleMakeById(java.util.UUID id) {
        return vehicleMakeRepository.findById(id)
                .map(vehicleMakeMapper::toDomain);
    }

    @Override
    public Mono<Void> deleteVehicleMake(java.util.UUID id) {
        return vehicleMakeRepository.deleteById(id);
    }

    // VehicleModel
    @Override
    public Mono<VehicleModel> saveVehicleModel(VehicleModel vehicleModel) {
        var entity = vehicleModelMapper.toEntity(vehicleModel);
        if (vehicleModel.vehicleModelId() != null) {
            entity.setVehicleModelId(vehicleModel.vehicleModelId());
        }
        return vehicleModelRepository.save(entity)
                .map(vehicleModelMapper::toDomain);
    }

    @Override
    public Flux<VehicleModel> findAllVehicleModels() {
        return vehicleModelRepository.findAll()
                .map(vehicleModelMapper::toDomain);
    }

    @Override
    public Mono<VehicleModel> findVehicleModelById(java.util.UUID id) {
        return vehicleModelRepository.findById(id)
                .map(vehicleModelMapper::toDomain);
    }

    @Override
    public Mono<Void> deleteVehicleModel(java.util.UUID id) {
        return vehicleModelRepository.deleteById(id);
    }

    // VehicleSize
    @Override
    public Mono<VehicleSize> saveVehicleSize(VehicleSize vehicleSize) {
        var entity = vehicleSizeMapper.toEntity(vehicleSize);
        if (vehicleSize.vehicleSizeId() != null) {
            entity.setVehicleSizeId(vehicleSize.vehicleSizeId());
        }
        return vehicleSizeRepository.save(entity)
                .map(vehicleSizeMapper::toDomain);
    }

    @Override
    public Flux<VehicleSize> findAllVehicleSizes() {
        return vehicleSizeRepository.findAll()
                .map(vehicleSizeMapper::toDomain);
    }

    @Override
    public Mono<VehicleSize> findVehicleSizeById(java.util.UUID id) {
        return vehicleSizeRepository.findById(id)
                .map(vehicleSizeMapper::toDomain);
    }

    @Override
    public Mono<Void> deleteVehicleSize(java.util.UUID id) {
        return vehicleSizeRepository.deleteById(id);
    }

    // VehicleType
    @Override
    public Mono<VehicleType> saveVehicleType(VehicleType vehicleType) {
        var entity = vehicleTypeMapper.toEntity(vehicleType);
        if (vehicleType.vehicleTypeId() != null) {
            entity.setVehicleTypeId(vehicleType.vehicleTypeId());
        }
        return vehicleTypeRepository.save(entity)
                .map(vehicleTypeMapper::toDomain);
    }

    @Override
    public Flux<VehicleType> findAllVehicleTypes() {
        return vehicleTypeRepository.findAll()
                .map(vehicleTypeMapper::toDomain);
    }

    @Override
    public Mono<VehicleType> findVehicleTypeById(java.util.UUID id) {
        return vehicleTypeRepository.findById(id)
                .map(vehicleTypeMapper::toDomain);
    }

    @Override
    public Mono<Void> deleteVehicleType(java.util.UUID id) {
        return vehicleTypeRepository.deleteById(id);
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/PostgreVehicleDetailsAdapter.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence;

import com.yowyob.template.domain.model.vehicle.details.*;
import com.yowyob.template.domain.ports.out.VehicleDetailsRepositoryPort;
import com.yowyob.template.infrastructure.adapters.outbound.persistence.repository.*;
import com.yowyob.template.infrastructure.mappers.VehicleDetailsMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import java.util.UUID;

@Component
@RequiredArgsConstructor
public class PostgreVehicleDetailsAdapter implements VehicleDetailsRepositoryPort {

    private final VehicleAmenityR2dbcRepository amenityRepository;
    private final VehicleCanTransportR2dbcRepository canTransportRepository;
    private final VehicleIllustrationImageR2dbcRepository illustrationImageRepository;
    private final VehicleKeywordR2dbcRepository keywordRepository;
    private final VehicleReviewR2dbcRepository reviewRepository;
    private final VehicleDetailsMapper mapper;

    // Amenity
    @Override
    public Mono<VehicleAmenity> saveAmenity(VehicleAmenity amenity) {
        var entity = mapper.toEntity(amenity);
        if (amenity.vehicleAmenityId() != null) {
            entity.setVehicleAmenityId(amenity.vehicleAmenityId());
        }
        return amenityRepository.save(entity)
                .map(mapper::toDomain);
    }

    @Override
    public Flux<VehicleAmenity> findAmenitiesByVehicleId(UUID vehicleId) {
        return amenityRepository.findByVehicleId(vehicleId)
                .map(mapper::toDomain);
    }

    @Override
    public Mono<Void> deleteAmenity(UUID id) {
        return amenityRepository.deleteById(id);
    }

    // CanTransport
    @Override
    public Mono<VehicleCanTransport> saveCanTransport(VehicleCanTransport canTransport) {
        var entity = mapper.toEntity(canTransport);
        if (canTransport.vehicleCanTransportId() != null) {
            entity.setVehicleCanTransportId(canTransport.vehicleCanTransportId());
        }
        return canTransportRepository.save(entity)
                .map(mapper::toDomain);
    }

    @Override
    public Flux<VehicleCanTransport> findCanTransportsByVehicleId(UUID vehicleId) {
        return canTransportRepository.findByVehicleId(vehicleId)
                .map(mapper::toDomain);
    }

    @Override
    public Mono<Void> deleteCanTransport(UUID id) {
        return canTransportRepository.deleteById(id);
    }

    // IllustrationImage
    @Override
    public Mono<VehicleIllustrationImage> saveIllustrationImage(VehicleIllustrationImage image) {
        var entity = mapper.toEntity(image);
        if (image.vehicleIllustrationImageId() != null) {
            entity.setVehicleIllustrationImageId(image.vehicleIllustrationImageId());
        }
        return illustrationImageRepository.save(entity)
                .map(mapper::toDomain);
    }

    @Override
    public Flux<VehicleIllustrationImage> findIllustrationImagesByVehicleId(UUID vehicleId) {
        return illustrationImageRepository.findByVehicleId(vehicleId)
                .map(mapper::toDomain);
    }

    @Override
    public Mono<Void> deleteIllustrationImage(UUID id) {
        return illustrationImageRepository.deleteById(id);
    }

    // Keyword
    @Override
    public Mono<VehicleKeyword> saveKeyword(VehicleKeyword keyword) {
        var entity = mapper.toEntity(keyword);
        if (keyword.vehicleKeywordId() != null) {
            entity.setVehicleKeywordId(keyword.vehicleKeywordId());
        }
        return keywordRepository.save(entity)
                .map(mapper::toDomain);
    }

    @Override
    public Flux<VehicleKeyword> findKeywordsByVehicleId(UUID vehicleId) {
        return keywordRepository.findByVehicleId(vehicleId)
                .map(mapper::toDomain);
    }

    @Override
    public Mono<Void> deleteKeyword(UUID id) {
        return keywordRepository.deleteById(id);
    }

    // Review
    @Override
    public Mono<VehicleReview> saveReview(VehicleReview review) {
        var entity = mapper.toEntity(review);
        if (review.reviewId() != null) {
            entity.setReviewId(review.reviewId());
        }
        return reviewRepository.save(entity)
                .map(mapper::toDomain);
    }

    @Override
    public Flux<VehicleReview> findReviewsByVehicleId(UUID vehicleId) {
        return reviewRepository.findByVehicleId(vehicleId)
                .map(mapper::toDomain);
    }

    @Override
    public Mono<Void> deleteReview(UUID id) {
        return reviewRepository.deleteById(id);
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/repository/VehicleMakeR2dbcRepository.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.VehicleMakeEntity;

import reactor.core.publisher.Mono;

import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import org.springframework.stereotype.Repository;
import java.util.UUID;

@Repository
public interface VehicleMakeR2dbcRepository extends ReactiveCrudRepository<VehicleMakeEntity, UUID> {
    Mono<VehicleMakeEntity> findByMakeName(String makeName);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/repository/VehicleIllustrationImageR2dbcRepository.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.VehicleIllustrationImageEntity;
import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import org.springframework.stereotype.Repository;
import reactor.core.publisher.Flux;
import java.util.UUID;

@Repository
public interface VehicleIllustrationImageR2dbcRepository
        extends ReactiveCrudRepository<VehicleIllustrationImageEntity, UUID> {
    Flux<VehicleIllustrationImageEntity> findByVehicleId(UUID vehicleId);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/repository/ProductR2dbcRepository.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.ProductEntity;
import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import java.util.UUID;

public interface ProductR2dbcRepository extends ReactiveCrudRepository<ProductEntity, UUID> {}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/repository/VehicleReviewR2dbcRepository.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.VehicleReviewEntity;
import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import org.springframework.stereotype.Repository;
import reactor.core.publisher.Flux;
import java.util.UUID;

@Repository
public interface VehicleReviewR2dbcRepository extends ReactiveCrudRepository<VehicleReviewEntity, UUID> {
    Flux<VehicleReviewEntity> findByVehicleId(UUID vehicleId);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/repository/VehicleTypeR2dbcRepository.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.VehicleTypeEntity;

import reactor.core.publisher.Mono;

import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import org.springframework.stereotype.Repository;
import java.util.UUID;

@Repository
public interface VehicleTypeR2dbcRepository extends ReactiveCrudRepository<VehicleTypeEntity, UUID> {
    Mono<VehicleTypeEntity> findByTypeName(String typeName);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/repository/VehicleOwnershipR2dbcRepository.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.VehicleOwnershipEntity;
import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import org.springframework.stereotype.Repository;
import reactor.core.publisher.Flux;
import java.util.UUID;

@Repository
public interface VehicleOwnershipR2dbcRepository extends ReactiveCrudRepository<VehicleOwnershipEntity, UUID> {
    Flux<VehicleOwnershipEntity> findByVehicleId(UUID vehicleId);

    Flux<VehicleOwnershipEntity> findByPartyId(UUID partyId);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/repository/VehicleCanTransportR2dbcRepository.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.VehicleCanTransportEntity;
import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import org.springframework.stereotype.Repository;
import reactor.core.publisher.Flux;
import java.util.UUID;

@Repository
public interface VehicleCanTransportR2dbcRepository extends ReactiveCrudRepository<VehicleCanTransportEntity, UUID> {
    Flux<VehicleCanTransportEntity> findByVehicleId(UUID vehicleId);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/repository/VehicleSizeR2dbcRepository.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.VehicleSizeEntity;

import reactor.core.publisher.Mono;

import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import org.springframework.stereotype.Repository;
import java.util.UUID;

@Repository
public interface VehicleSizeR2dbcRepository extends ReactiveCrudRepository<VehicleSizeEntity, UUID> {
    Mono<VehicleSizeEntity> findBySizeName(String sizeName);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/repository/VehicleAmenityR2dbcRepository.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.VehicleAmenityEntity;
import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import org.springframework.stereotype.Repository;
import reactor.core.publisher.Flux;
import java.util.UUID;

@Repository
public interface VehicleAmenityR2dbcRepository extends ReactiveCrudRepository<VehicleAmenityEntity, UUID> {
    Flux<VehicleAmenityEntity> findByVehicleId(UUID vehicleId);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/repository/VehicleR2dbcRepository.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.repository;

import java.util.UUID;

import org.springframework.data.r2dbc.repository.Query;
import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import org.springframework.stereotype.Repository;

import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.VehicleEntity;

import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

@Repository
public interface VehicleR2dbcRepository extends ReactiveCrudRepository<VehicleEntity, UUID> {
    
    // CORRECTION : Utilisation de "Vehicle" et "VehicleOwnership" tels que dÃ©finis dans @Table
    // On s'assure que la jointure est correcte.
    @Query("SELECT v.* FROM Vehicle v " +
           "INNER JOIN VehicleOwnership vo ON v.vehicle_id = vo.vehicle_id " +
           "WHERE vo.party_id = :partyId")
    Flux<VehicleEntity> findByPartyId(UUID partyId);

    // --- Validation d'unicitÃ© ---
    Mono<Boolean> existsByVehicleSerialNumberAndVehicleIdNot(String vehicleSerialNumber, UUID vehicleId);
    Mono<Boolean> existsByRegistrationNumberAndVehicleIdNot(String registrationNumber, UUID vehicleId);
}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/repository/TransmissionTypeR2dbcRepository.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.TransmissionTypeEntity;

import reactor.core.publisher.Mono;

import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import org.springframework.stereotype.Repository;
import java.util.UUID;

@Repository
public interface TransmissionTypeR2dbcRepository extends ReactiveCrudRepository<TransmissionTypeEntity, UUID> {
    Mono<TransmissionTypeEntity> findByTypeName(String typeName);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/repository/FuelTypeR2dbcRepository.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.FuelTypeEntity;

import reactor.core.publisher.Mono;

import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import org.springframework.stereotype.Repository;
import java.util.UUID;

@Repository
public interface FuelTypeR2dbcRepository extends ReactiveCrudRepository<FuelTypeEntity, UUID> {
    Mono<FuelTypeEntity> findByFuelTypeName(String fuelTypeName);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/repository/VehicleModelR2dbcRepository.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.VehicleModelEntity;

import reactor.core.publisher.Mono;

import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import org.springframework.stereotype.Repository;
import java.util.UUID;

@Repository
public interface VehicleModelR2dbcRepository extends ReactiveCrudRepository<VehicleModelEntity, UUID> {
    Mono<VehicleModelEntity> findByModelName(String modelName);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/repository/VehicleKeywordR2dbcRepository.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.VehicleKeywordEntity;
import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import org.springframework.stereotype.Repository;
import reactor.core.publisher.Flux;
import java.util.UUID;

@Repository
public interface VehicleKeywordR2dbcRepository extends ReactiveCrudRepository<VehicleKeywordEntity, UUID> {
    Flux<VehicleKeywordEntity> findByVehicleId(UUID vehicleId);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/repository/ManufacturerR2dbcRepository.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.ManufacturerEntity;

import reactor.core.publisher.Mono;

import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import org.springframework.stereotype.Repository;
import java.util.UUID;

@Repository
public interface ManufacturerR2dbcRepository extends ReactiveCrudRepository<ManufacturerEntity, UUID> {
    Mono<ManufacturerEntity> findByManufacturerName(String manufacturerName);
}

```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/repository/VehicleRepository.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence.repository;

import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.VehicleEntity;
import org.springframework.data.repository.reactive.ReactiveCrudRepository;
import org.springframework.stereotype.Repository;
import reactor.core.publisher.Mono;

import java.util.UUID;

@Repository
public interface VehicleRepository extends ReactiveCrudRepository<VehicleEntity, UUID> {

    // VÃ©rifie si le VIN existe dÃ©jÃ 
    Mono<Boolean> existsByVehicleSerialNumber(String vehicleSerialNumber);

    // VÃ©rifie si l'immatriculation existe dÃ©jÃ 
    Mono<Boolean> existsByRegistrationNumber(String registrationNumber);

    // --- NOUVELLES MÃ‰THODES POUR L'UPDATE/PATCH ---

    // VÃ©rifie si le VIN existe sur un AUTRE vÃ©hicule (ID diffÃ©rent)
    Mono<Boolean> existsByVehicleSerialNumberAndVehicleIdNot(String vehicleSerialNumber, UUID vehicleId);

    // VÃ©rifie si l'immatriculation existe sur un AUTRE vÃ©hicule (ID diffÃ©rent)
    Mono<Boolean> existsByRegistrationNumberAndVehicleIdNot(String registrationNumber, UUID vehicleId);
}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/PostgreVehicleAdapter.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence;

import com.yowyob.template.domain.model.vehicle.Vehicle;
import com.yowyob.template.domain.ports.out.VehicleRepositoryPort;
import com.yowyob.template.infrastructure.adapters.outbound.persistence.repository.VehicleR2dbcRepository;
import com.yowyob.template.infrastructure.mappers.VehicleMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;

@Component
@RequiredArgsConstructor
public class PostgreVehicleAdapter implements VehicleRepositoryPort {

    private final VehicleR2dbcRepository repository;
    private final VehicleMapper mapper;

    @Override
    public Mono<Vehicle> saveVehicle(Vehicle vehicle) {
        return Mono.just(mapper.toEntity(vehicle))
                .flatMap(repository::save)
                .map(mapper::toDomain);
    }

    @Override
    public Flux<Vehicle> findAllVehicles() {
        return repository.findAll()
                .map(mapper::toDomain);
    }

    @Override
    public Flux<Vehicle> findVehiclesByPartyId(UUID partyId) {
        return repository.findByPartyId(partyId)
                .map(mapper::toDomain);
    }

    @Override
    public Mono<Vehicle> findVehicleById(UUID id) {
        return repository.findById(id)
                .map(mapper::toDomain);
    }

    @Override
    public Mono<Void> deleteVehicle(UUID id) {
        return repository.deleteById(id);
    }

    @Override
    public Mono<Boolean> existsBySerialNumberAndIdNot(String serialNumber, UUID id) {
        if (serialNumber == null) return Mono.just(false);
        return repository.existsByVehicleSerialNumberAndVehicleIdNot(serialNumber, id);
    }

    @Override
    public Mono<Boolean> existsByRegistrationNumberAndIdNot(String registrationNumber, UUID id) {
        if (registrationNumber == null) return Mono.just(false);
        return repository.existsByRegistrationNumberAndVehicleIdNot(registrationNumber, id);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/PostgreVehicleOwnershipAdapter.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence;

import com.yowyob.template.domain.model.vehicle.ownership.VehicleOwnership;
import com.yowyob.template.domain.ports.out.VehicleOwnershipRepositoryPort;
import com.yowyob.template.infrastructure.adapters.outbound.persistence.repository.VehicleOwnershipR2dbcRepository;
import com.yowyob.template.infrastructure.mappers.VehicleOwnershipMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import java.util.UUID;

@Component
@RequiredArgsConstructor
public class PostgreVehicleOwnershipAdapter implements VehicleOwnershipRepositoryPort {

    private final VehicleOwnershipR2dbcRepository repository;
    private final VehicleOwnershipMapper mapper;

    @Override
    public Mono<VehicleOwnership> saveOwnership(VehicleOwnership ownership) {
        var entity = mapper.toEntity(ownership);
        if (ownership.vehicleOwnershipId() != null) {
            entity.setVehicleOwnershipId(ownership.vehicleOwnershipId());
        }
        return repository.save(entity)
                .map(mapper::toDomain);
    }

    @Override
    public Flux<VehicleOwnership> findOwnershipsByVehicleId(UUID vehicleId) {
        return repository.findByVehicleId(vehicleId)
                .map(mapper::toDomain);
    }

    @Override
    public Flux<VehicleOwnership> findOwnershipsByPartyId(UUID partyId) {
        return repository.findByPartyId(partyId)
                .map(mapper::toDomain);
    }

    @Override
    public Mono<VehicleOwnership> findOwnershipById(UUID id) {
        return repository.findById(id)
                .map(mapper::toDomain);
    }

    @Override
    public Mono<Void> deleteOwnership(UUID id) {
        return repository.deleteById(id);
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/persistence/PostgresR2dbcAdapter.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.persistence;

import com.yowyob.template.domain.model.Product;
import com.yowyob.template.domain.ports.out.ProductRepositoryPort;
import com.yowyob.template.infrastructure.adapters.outbound.persistence.repository.ProductR2dbcRepository;
import com.yowyob.template.infrastructure.mappers.ProductMapper;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Mono;

@Component
@RequiredArgsConstructor
public class PostgresR2dbcAdapter implements ProductRepositoryPort {

    private final ProductR2dbcRepository repository;
    private final ProductMapper mapper;

    @Override
    public Mono<Product> save(Product product) {
        return repository.save(mapper.toEntity(product))
                .map(mapper::toDomain);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/outbound/cache/RedisAdapter.java`
```java
package com.yowyob.template.infrastructure.adapters.outbound.cache;

import com.yowyob.template.domain.model.Product;
import com.yowyob.template.domain.ports.out.ProductCachePort;
import lombok.RequiredArgsConstructor;
import org.springframework.data.redis.core.ReactiveRedisTemplate;
import org.springframework.stereotype.Component;
import reactor.core.publisher.Mono;
import java.time.Duration;

@Component
@RequiredArgsConstructor
public class RedisAdapter implements ProductCachePort {
    private final ReactiveRedisTemplate<String, Object> redisTemplate;

    @Override
    public Mono<Boolean> saveInCache(Product product) {
        return redisTemplate.opsForValue()
                .set("product:" + product.id(), product, Duration.ofMinutes(10));
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/kafka/ProductEventConsumer.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.kafka;

import com.yowyob.template.domain.model.Product;
import lombok.extern.slf4j.Slf4j;
import org.springframework.kafka.annotation.KafkaListener;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

@Slf4j
@Component
public class ProductEventConsumer {

    @Value("${application.kafka.topics.product-events}")
    private String productEventsTopic;

    @KafkaListener(topics = "${application.kafka.topics.product-events}", groupId = "template-group")
    public void consume(Product product) {
        log.info("CONSUMER: I received an event for product with id : {} and price : {}", 
                 product.name(), product.price());
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/VehicleLookupController.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest;

import com.yowyob.template.domain.ports.in.ManageVehicleLookupUseCase;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup.*;
import com.yowyob.template.infrastructure.mappers.*;
import com.yowyob.template.domain.exception.NotFoundException;
import io.swagger.v3.oas.annotations.Operation;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;

@RestController
@RequestMapping("/vehicles/lookup")
@RequiredArgsConstructor
public class VehicleLookupController {

    private final ManageVehicleLookupUseCase lookupUseCase;
    private final FuelTypeMapper fuelTypeMapper;
    private final ManufacturerMapper manufacturerMapper;
    private final TransmissionTypeMapper transmissionTypeMapper;
    private final VehicleMakeMapper vehicleMakeMapper;
    private final VehicleModelMapper vehicleModelMapper;
    private final VehicleSizeMapper vehicleSizeMapper;
    private final VehicleTypeMapper vehicleTypeMapper;

    // FuelType
    @PostMapping("/fuel-types")
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "Create Fuel Type")
    public Mono<FuelTypeResponse> createFuelType(@Valid @RequestBody FuelTypeRequest request) {
        return Mono.just(fuelTypeMapper.toDomain(request))
                .flatMap(lookupUseCase::createFuelType)
                .map(fuelTypeMapper::toResponse);
    }

    @GetMapping("/fuel-types")
    @Operation(summary = "Get All Fuel Types")
    public Flux<FuelTypeResponse> getAllFuelTypes() {
        return lookupUseCase.getAllFuelTypes()
                .map(fuelTypeMapper::toResponse);
    }

    @GetMapping("/fuel-types/{id}")
    @Operation(summary = "Get Fuel Type by ID")
    public Mono<FuelTypeResponse> getFuelTypeById(@PathVariable UUID id) {
        return lookupUseCase.getFuelTypeById(id)
                .switchIfEmpty(Mono.error(new NotFoundException("Fuel Type not found with id: " + id)))
                .map(fuelTypeMapper::toResponse);
    }

    @DeleteMapping("/fuel-types/{id}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @Operation(summary = "Delete Fuel Type")
    public Mono<Void> deleteFuelType(@PathVariable UUID id) {
        return lookupUseCase.getFuelTypeById(id)
                .switchIfEmpty(Mono.error(new NotFoundException("Fuel Type not found with id: " + id)))
                .flatMap(fuelType -> lookupUseCase.deleteFuelType(id));
    }

    // Manufacturer
    @PostMapping("/manufacturers")
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "Create Manufacturer")
    public Mono<ManufacturerResponse> createManufacturer(@Valid @RequestBody ManufacturerRequest request) {
        return Mono.just(manufacturerMapper.toDomain(request))
                .flatMap(lookupUseCase::createManufacturer)
                .map(manufacturerMapper::toResponse);
    }

    @GetMapping("/manufacturers")
    @Operation(summary = "Get All Manufacturers")
    public Flux<ManufacturerResponse> getAllManufacturers() {
        return lookupUseCase.getAllManufacturers()
                .map(manufacturerMapper::toResponse);
    }

    @GetMapping("/manufacturers/{id}")
    @Operation(summary = "Get Manufacturer by ID")
    public Mono<ManufacturerResponse> getManufacturerById(@PathVariable UUID id) {
        return lookupUseCase.getManufacturerById(id)
                .switchIfEmpty(Mono.error(new NotFoundException("Manufacturer not found with id: " + id)))
                .map(manufacturerMapper::toResponse);
    }

    @DeleteMapping("/manufacturers/{id}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @Operation(summary = "Delete Manufacturer")
    public Mono<Void> deleteManufacturer(@PathVariable UUID id) {
        return lookupUseCase.getManufacturerById(id)
                .switchIfEmpty(Mono.error(new NotFoundException("Manufacturer not found with id: " + id)))
                .flatMap(manufacturer -> lookupUseCase.deleteManufacturer(id));
    }

    // TransmissionType
    @PostMapping("/transmission-types")
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "Create Transmission Type")
    public Mono<TransmissionTypeResponse> createTransmissionType(@Valid @RequestBody TransmissionTypeRequest request) {
        return Mono.just(transmissionTypeMapper.toDomain(request))
                .flatMap(lookupUseCase::createTransmissionType)
                .map(transmissionTypeMapper::toResponse);
    }

    @GetMapping("/transmission-types")
    @Operation(summary = "Get All Transmission Types")
    public Flux<TransmissionTypeResponse> getAllTransmissionTypes() {
        return lookupUseCase.getAllTransmissionTypes()
                .map(transmissionTypeMapper::toResponse);
    }

    @GetMapping("/transmission-types/{id}")
    @Operation(summary = "Get Transmission Type by ID")
    public Mono<TransmissionTypeResponse> getTransmissionTypeById(@PathVariable UUID id) {
        return lookupUseCase.getTransmissionTypeById(id)
                .switchIfEmpty(Mono.error(new NotFoundException("Transmission Type not found with id: " + id)))
                .map(transmissionTypeMapper::toResponse);
    }

    @DeleteMapping("/transmission-types/{id}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @Operation(summary = "Delete Transmission Type")
    public Mono<Void> deleteTransmissionType(@PathVariable UUID id) {
        return lookupUseCase.getTransmissionTypeById(id)
                .switchIfEmpty(Mono.error(new NotFoundException("Transmission Type not found with id: " + id)))
                .flatMap(transmissionType -> lookupUseCase.deleteTransmissionType(id));
    }

    // VehicleMake
    @PostMapping("/vehicle-makes")
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "Create Vehicle Make")
    public Mono<VehicleMakeResponse> createVehicleMake(@Valid @RequestBody VehicleMakeRequest request) {
        return Mono.just(vehicleMakeMapper.toDomain(request))
                .flatMap(lookupUseCase::createVehicleMake)
                .map(vehicleMakeMapper::toResponse);
    }

    @GetMapping("/vehicle-makes")
    @Operation(summary = "Get All Vehicle Makes")
    public Flux<VehicleMakeResponse> getAllVehicleMakes() {
        return lookupUseCase.getAllVehicleMakes()
                .map(vehicleMakeMapper::toResponse);
    }

    @GetMapping("/vehicle-makes/{id}")
    @Operation(summary = "Get Vehicle Make by ID")
    public Mono<VehicleMakeResponse> getVehicleMakeById(@PathVariable UUID id) {
        return lookupUseCase.getVehicleMakeById(id)
                .switchIfEmpty(Mono.error(new NotFoundException("Vehicle Make not found with id: " + id)))
                .map(vehicleMakeMapper::toResponse);
    }

    @DeleteMapping("/vehicle-makes/{id}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @Operation(summary = "Delete Vehicle Make")
    public Mono<Void> deleteVehicleMake(@PathVariable UUID id) {
        return lookupUseCase.getVehicleMakeById(id)
                .switchIfEmpty(Mono.error(new NotFoundException("Vehicle Make not found with id: " + id)))
                .flatMap(vehicleMake -> lookupUseCase.deleteVehicleMake(id));
    }

    // VehicleModel
    @PostMapping("/vehicle-models")
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "Create Vehicle Model")
    public Mono<VehicleModelResponse> createVehicleModel(@Valid @RequestBody VehicleModelRequest request) {
        return Mono.just(vehicleModelMapper.toDomain(request))
                .flatMap(lookupUseCase::createVehicleModel)
                .map(vehicleModelMapper::toResponse);
    }

    @GetMapping("/vehicle-models")
    @Operation(summary = "Get All Vehicle Models")
    public Flux<VehicleModelResponse> getAllVehicleModels() {
        return lookupUseCase.getAllVehicleModels()
                .map(vehicleModelMapper::toResponse);
    }

    @GetMapping("/vehicle-models/{id}")
    @Operation(summary = "Get Vehicle Model by ID")
    public Mono<VehicleModelResponse> getVehicleModelById(@PathVariable UUID id) {
        return lookupUseCase.getVehicleModelById(id)
                .switchIfEmpty(Mono.error(new NotFoundException("Vehicle Model not found with id: " + id)))
                .map(vehicleModelMapper::toResponse);
    }

    @DeleteMapping("/vehicle-models/{id}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @Operation(summary = "Delete Vehicle Model")
    public Mono<Void> deleteVehicleModel(@PathVariable UUID id) {
        return lookupUseCase.getVehicleModelById(id)
                .switchIfEmpty(Mono.error(new NotFoundException("Vehicle Model not found with id: " + id)))
                .flatMap(vehicleModel -> lookupUseCase.deleteVehicleModel(id));
    }

    // VehicleSize
    @PostMapping("/vehicle-sizes")
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "Create Vehicle Size")
    public Mono<VehicleSizeResponse> createVehicleSize(@Valid @RequestBody VehicleSizeRequest request) {
        return Mono.just(vehicleSizeMapper.toDomain(request))
                .flatMap(lookupUseCase::createVehicleSize)
                .map(vehicleSizeMapper::toResponse);
    }

    @GetMapping("/vehicle-sizes")
    @Operation(summary = "Get All Vehicle Sizes")
    public Flux<VehicleSizeResponse> getAllVehicleSizes() {
        return lookupUseCase.getAllVehicleSizes()
                .map(vehicleSizeMapper::toResponse);
    }

    @GetMapping("/vehicle-sizes/{id}")
    @Operation(summary = "Get Vehicle Size by ID")
    public Mono<VehicleSizeResponse> getVehicleSizeById(@PathVariable UUID id) {
        return lookupUseCase.getVehicleSizeById(id)
                .switchIfEmpty(Mono.error(new NotFoundException("Vehicle Size not found with id: " + id)))
                .map(vehicleSizeMapper::toResponse);
    }

    @DeleteMapping("/vehicle-sizes/{id}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @Operation(summary = "Delete Vehicle Size")
    public Mono<Void> deleteVehicleSize(@PathVariable UUID id) {
        return lookupUseCase.getVehicleSizeById(id)
                .switchIfEmpty(Mono.error(new NotFoundException("Vehicle Size not found with id: " + id)))
                .flatMap(vehicleSize -> lookupUseCase.deleteVehicleSize(id));
    }

    // VehicleType
    @PostMapping("/vehicle-types")
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "Create Vehicle Type")
    public Mono<VehicleTypeResponse> createVehicleType(@Valid @RequestBody VehicleTypeRequest request) {
        return Mono.just(vehicleTypeMapper.toDomain(request))
                .flatMap(lookupUseCase::createVehicleType)
                .map(vehicleTypeMapper::toResponse);
    }

    @GetMapping("/vehicle-types")
    @Operation(summary = "Get All Vehicle Types")
    public Flux<VehicleTypeResponse> getAllVehicleTypes() {
        return lookupUseCase.getAllVehicleTypes()
                .map(vehicleTypeMapper::toResponse);
    }

    @GetMapping("/vehicle-types/{id}")
    @Operation(summary = "Get Vehicle Type by ID")
    public Mono<VehicleTypeResponse> getVehicleTypeById(@PathVariable UUID id) {
        return lookupUseCase.getVehicleTypeById(id)
                .switchIfEmpty(Mono.error(new NotFoundException("Vehicle Type not found with id: " + id)))
                .map(vehicleTypeMapper::toResponse);
    }

    @DeleteMapping("/vehicle-types/{id}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @Operation(summary = "Delete Vehicle Type")
    public Mono<Void> deleteVehicleType(@PathVariable UUID id) {
        return lookupUseCase.getVehicleTypeById(id)
                .switchIfEmpty(Mono.error(new NotFoundException("Vehicle Type not found with id: " + id)))
                .flatMap(vehicleType -> lookupUseCase.deleteVehicleType(id));
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/VehicleOwnershipController.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest;

import com.yowyob.template.domain.model.vehicle.ownership.VehicleOwnership;
import com.yowyob.template.domain.ports.in.ManageVehicleOwnershipUseCase;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.ownership.VehicleOwnershipRequest;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.ownership.VehicleOwnershipResponse;
import com.yowyob.template.infrastructure.mappers.VehicleOwnershipMapper;
import com.yowyob.template.infrastructure.security.AuthenticatedUser;
import com.yowyob.template.domain.exception.NotFoundException;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.server.ResponseStatusException;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import java.util.UUID;

@RestController
@RequestMapping("/vehicles/ownerships")
@RequiredArgsConstructor
public class VehicleOwnershipController {

    private final ManageVehicleOwnershipUseCase ownershipUseCase;
    private final VehicleOwnershipMapper mapper;

    @PostMapping
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "Create Vehicle Ownership", description = "CrÃ©e une ownership de vÃ©hicule. Le partyId est automatiquement rÃ©cupÃ©rÃ© depuis l'utilisateur authentifiÃ©.")
    @SecurityRequirement(name = "bearerAuth")
    public Mono<VehicleOwnershipResponse> createOwnership(
            @Valid @RequestBody VehicleOwnershipRequest request,
            @AuthenticationPrincipal AuthenticatedUser authenticatedUser) {
        
        // VÃ©rifier que l'utilisateur est authentifiÃ©
        if (authenticatedUser == null || authenticatedUser.getId() == null) {
            return Mono.error(new ResponseStatusException(HttpStatus.UNAUTHORIZED, "Utilisateur non authentifiÃ©"));
        }
        
        // RÃ©cupÃ©rer le partyId depuis l'utilisateur authentifiÃ©
        UUID partyId = UUID.fromString(authenticatedUser.getId());
        
        // Mapper le request vers le domaine et ajouter le partyId
        VehicleOwnership ownership = new VehicleOwnership(
                null, // vehicleOwnershipId sera gÃ©nÃ©rÃ©
                request.vehicleId(),
                partyId, // partyId rÃ©cupÃ©rÃ© automatiquement
                request.usageRole(),
                request.isPrimary(),
                request.validFrom(),
                request.validTo()
        );
        
        return ownershipUseCase.createOwnership(ownership)
                .map(mapper::toResponse);
    }

    @GetMapping("/me")
    @Operation(summary = "Get My Ownerships", description = "RÃ©cupÃ¨re les ownerships de l'utilisateur connectÃ©")
    @SecurityRequirement(name = "bearerAuth")
    public Flux<VehicleOwnershipResponse> getMyOwnerships(
            @AuthenticationPrincipal AuthenticatedUser authenticatedUser) {
        if (authenticatedUser == null || authenticatedUser.getId() == null) {
            return Flux.error(new ResponseStatusException(HttpStatus.UNAUTHORIZED, "Utilisateur non authentifiÃ©"));
        }
        UUID partyId = UUID.fromString(authenticatedUser.getId());
        return ownershipUseCase.getOwnershipsByPartyId(partyId)
                .map(mapper::toResponse);
    }

    @GetMapping("/vehicle/{vehicleId}")
    @Operation(summary = "Get Ownerships by Vehicle ID")
    public Flux<VehicleOwnershipResponse> getOwnershipsByVehicleId(@PathVariable UUID vehicleId) {
        return ownershipUseCase.getOwnershipsByVehicleId(vehicleId)
                .map(mapper::toResponse);
    }

    @GetMapping("/party/{partyId}")
    @Operation(summary = "Get Ownerships by Party ID", description = "Pour les administrateurs uniquement")
    public Flux<VehicleOwnershipResponse> getOwnershipsByPartyId(@PathVariable UUID partyId) {
        return ownershipUseCase.getOwnershipsByPartyId(partyId)
                .map(mapper::toResponse);
    }

    @GetMapping("/{id}")
    @Operation(summary = "Get Ownership by ID")
    public Mono<VehicleOwnershipResponse> getOwnershipById(@PathVariable UUID id) {
        return ownershipUseCase.getOwnershipById(id)
                .switchIfEmpty(Mono.error(new NotFoundException("Vehicle Ownership not found with id: " + id)))
                .map(mapper::toResponse);
    }

    @DeleteMapping("/{id}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @Operation(summary = "Delete Ownership")
    public Mono<Void> deleteOwnership(@PathVariable UUID id) {
        return ownershipUseCase.getOwnershipById(id)
                .switchIfEmpty(Mono.error(new NotFoundException("Vehicle Ownership not found with id: " + id)))
                .flatMap(ownership -> ownershipUseCase.deleteOwnership(id));
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/ProductController.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest;

import com.yowyob.template.domain.ports.in.CreateProductUseCase;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.ProductRequest;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.ProductResponse;
import com.yowyob.template.infrastructure.mappers.ProductMapper;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Mono;

@RestController
@RequestMapping("/api/v1/products")
@RequiredArgsConstructor
public class ProductController {

    private final CreateProductUseCase useCase;
    private final ProductMapper mapper;

    @PostMapping
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "CrÃ©er un produit", description = "VÃ©rifie le stock distant et sauvegarde le produit.")
    @ApiResponses(value = {
        @ApiResponse(responseCode = "201", description = "Produit crÃ©Ã© avec succÃ¨s"),
        @ApiResponse(responseCode = "400", description = "DonnÃ©es invalides")
    })
    public Mono<ProductResponse> create(@RequestBody @Valid Mono<ProductRequest> requestMono) {
        return requestMono
                .map(mapper::toDomain)
                .flatMap(useCase::createProduct)
                .map(mapper::toResponse);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/VehicleController.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest;

import com.yowyob.template.application.service.VehicleSmartCreationService;
import com.yowyob.template.domain.model.vehicle.Vehicle;
import com.yowyob.template.domain.ports.in.ManageVehicleUseCase;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.PatchVehicleRequest;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.SimplifiedVehicleRequest;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.VehicleRequest;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.VehicleResponse;
import com.yowyob.template.infrastructure.mappers.VehicleMapper;
import com.yowyob.template.infrastructure.security.AuthenticatedUser;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.responses.ApiResponse;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.server.ResponseStatusException;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;

@Slf4j
@RestController
@RequestMapping("/vehicles")
@RequiredArgsConstructor
public class VehicleController {

    private final ManageVehicleUseCase manageVehicleUseCase;
    private final VehicleMapper mapper;
    private final VehicleSmartCreationService smartCreationService;

    // =================================================================================================
    // 1. SMART CREATION (Mode SimplifiÃ©)
    // =================================================================================================

    @PostMapping("/simplified")
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "CrÃ©er un vÃ©hicule (Mode SimplifiÃ© - Smart)", 
               description = "CrÃ©e un vÃ©hicule en utilisant des noms (ex: 'Toyota') au lieu d'IDs. " +
                             "Le vÃ©hicule est automatiquement assignÃ© Ã  l'utilisateur connectÃ©.")
    @SecurityRequirement(name = "bearerAuth")
    @ApiResponses(value = {
            @ApiResponse(responseCode = "201", description = "VÃ©hicule crÃ©Ã© et assignÃ©"),
            @ApiResponse(responseCode = "400", description = "DonnÃ©es invalides"),
            @ApiResponse(responseCode = "401", description = "Utilisateur non authentifiÃ©")
    })
    public Mono<VehicleResponse> createVehicleSimplified(
            @Valid @RequestBody SimplifiedVehicleRequest request,
            @AuthenticationPrincipal AuthenticatedUser user) {
        
        // SÃ©curitÃ© : On vÃ©rifie que le token est bien prÃ©sent et valide
        if (user == null || user.getId() == null) {
            log.error("Tentative de crÃ©ation simplifiÃ©e sans utilisateur authentifiÃ©");
            return Mono.error(new ResponseStatusException(HttpStatus.UNAUTHORIZED, "Vous devez Ãªtre authentifiÃ© pour crÃ©er un vÃ©hicule"));
        }
        
        UUID partyId = UUID.fromString(user.getId());

        // On dÃ©lÃ¨gue au service d'application qui gÃ¨re les lookups et la liaison
        return smartCreationService.createVehicleFromNames(request, partyId)
                .map(mapper::toResponse);
    }

    // =================================================================================================
    // 2. CREATION STANDARD (Mode IDs)
    // =================================================================================================

    @PostMapping
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "CrÃ©er un vÃ©hicule (Mode Standard IDs)", description = "NÃ©cessite de connaÃ®tre les IDs des rÃ©fÃ©rentiels (Marque, ModÃ¨le...).")
    @SecurityRequirement(name = "bearerAuth")
    @ApiResponses(value = {
            @ApiResponse(responseCode = "201", description = "VÃ©hicule crÃ©Ã©"),
            @ApiResponse(responseCode = "400", description = "ID invalide ou manquant")
    })
    public Mono<VehicleResponse> createVehicle(@Valid @RequestBody VehicleRequest vehicleRequest) {
        return Mono.just(mapper.toDomain(vehicleRequest))
                .flatMap(manageVehicleUseCase::createVehicle)
                .map(mapper::toResponse);
    }

    // =================================================================================================
    // 3. LECTURE (GET)
    // =================================================================================================

    @GetMapping
    @Operation(summary = "Lister mes vÃ©hicules", description = "Retourne uniquement les vÃ©hicules dont je suis propriÃ©taire/utilisateur.")
    @SecurityRequirement(name = "bearerAuth")
    public Flux<VehicleResponse> getMyVehicles(@AuthenticationPrincipal AuthenticatedUser user) {
        if (user == null || user.getId() == null) {
            return Flux.error(new ResponseStatusException(HttpStatus.UNAUTHORIZED, "Utilisateur non authentifiÃ©"));
        }
        UUID partyId = UUID.fromString(user.getId());
        return manageVehicleUseCase.getVehiclesByOwner(partyId)
                .map(mapper::toResponse);
    }

    @GetMapping("/{id}")
    @Operation(summary = "Obtenir un vÃ©hicule par son ID")
    @SecurityRequirement(name = "bearerAuth")
    @ApiResponses(value = {
            @ApiResponse(responseCode = "200", description = "VÃ©hicule trouvÃ©"),
            @ApiResponse(responseCode = "404", description = "VÃ©hicule non trouvÃ©")
    })
    public Mono<VehicleResponse> getVehicleById(@PathVariable UUID id) {
        return manageVehicleUseCase.getVehicleById(id)
                .map(mapper::toResponse);
    }

    // =================================================================================================
    // 4. MISE A JOUR (PUT & PATCH)
    // =================================================================================================

    @PutMapping("/{id}")
    @Operation(summary = "Remplacement complet (PUT)", description = "Remplace intÃ©gralement le vÃ©hicule. Attention : les champs non fournis seront mis Ã  NULL.")
    @SecurityRequirement(name = "bearerAuth")
    @ApiResponses(value = {
            @ApiResponse(responseCode = "200", description = "VÃ©hicule mis Ã  jour"),
            @ApiResponse(responseCode = "404", description = "VÃ©hicule non trouvÃ©")
    })
    public Mono<VehicleResponse> updateVehicle(
            @Parameter(description = "ID du vÃ©hicule") @PathVariable UUID id,
            @Valid @RequestBody VehicleRequest r) {
        
        Vehicle d = mapper.toDomain(r);
        // On reconstruit l'objet domaine en forÃ§ant l'ID de l'URL
        Vehicle v = new Vehicle(
                id, d.vehicleMakeId(), d.vehicleModelId(), d.transmissionTypeId(), d.manufacturerId(), d.vehicleSizeId(), d.vehicleTypeId(), d.fuelTypeId(), 
                d.vehicleSerialNumber(), d.vehicleSerialPhoto(), d.registrationNumber(), d.registrationPhoto(), d.registrationExpiryDate(), 
                d.tankCapacity(), d.luggageMaxCapacity(), d.totalSeatNumber(), d.averageFuelConsumptionPerKm(), d.mileageAtStart(), d.mileageSinceCommissioning(), 
                d.vehicleAgeAtStart(), d.brand(), null, null
        );

        return manageVehicleUseCase.updateVehicle(v)
                .map(mapper::toResponse);
    }

    @PatchMapping("/{id}")
    @Operation(summary = "Mise Ã  jour partielle (PATCH)", description = "Met Ã  jour uniquement les champs fournis. IdÃ©al pour changer le kilomÃ©trage.")
    @SecurityRequirement(name = "bearerAuth")
    @ApiResponses(value = {
            @ApiResponse(responseCode = "200", description = "VÃ©hicule mis Ã  jour"),
            @ApiResponse(responseCode = "404", description = "VÃ©hicule non trouvÃ©")
    })
    public Mono<VehicleResponse> patchVehicle(
            @Parameter(description = "ID du vÃ©hicule") @PathVariable UUID id,
            @RequestBody PatchVehicleRequest patchRequest) {
        
        // Mapping manuel DTO -> Domain Partiel pour Ã©viter les Ã©crasements par null du Mapper
        Vehicle partialVehicle = new Vehicle(
                null, // ID ignorÃ© ici, gÃ©rÃ© par le service
                patchRequest.vehicleMakeId(), patchRequest.vehicleModelId(), patchRequest.transmissionTypeId(), 
                patchRequest.manufacturerId(), patchRequest.vehicleSizeId(), patchRequest.vehicleTypeId(), 
                patchRequest.fuelTypeId(), patchRequest.vehicleSerialNumber(), patchRequest.vehicleSerialPhoto(), 
                patchRequest.registrationNumber(), patchRequest.registrationPhoto(), patchRequest.registrationExpiryDate(), 
                patchRequest.tankCapacity(), patchRequest.luggageMaxCapacity(), patchRequest.totalSeatNumber(), 
                patchRequest.averageFuelConsumptionPerKm(), patchRequest.mileageAtStart(), patchRequest.mileageSinceCommissioning(), 
                patchRequest.vehicleAgeAtStart(), patchRequest.brand(), null, null
        );

        return manageVehicleUseCase.patchVehicle(id, partialVehicle)
                .map(mapper::toResponse);
    }

    // =================================================================================================
    // 5. SUPPRESSION (DELETE)
    // =================================================================================================

    @DeleteMapping("/{id}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @Operation(summary = "Supprimer un vÃ©hicule")
    @SecurityRequirement(name = "bearerAuth")
    @ApiResponses(value = {
            @ApiResponse(responseCode = "204", description = "VÃ©hicule supprimÃ©"),
            @ApiResponse(responseCode = "404", description = "VÃ©hicule non trouvÃ©")
    })
    public Mono<Void> deleteVehicle(@PathVariable UUID id) {
        return manageVehicleUseCase.deleteVehicle(id);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/VehicleDetailsController.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest;

import com.yowyob.template.domain.ports.in.ManageVehicleDetailsUseCase;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details.*;
import com.yowyob.template.infrastructure.mappers.VehicleDetailsMapper;
import com.yowyob.template.domain.exception.NotFoundException;
import io.swagger.v3.oas.annotations.Operation;
import jakarta.validation.Valid;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import java.util.UUID;

@RestController
@RequestMapping("/vehicles/details")
@RequiredArgsConstructor
public class VehicleDetailsController {

    private final ManageVehicleDetailsUseCase detailsUseCase;
    private final VehicleDetailsMapper mapper;

    // Amenity
    @PostMapping("/amenities")
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "Create Vehicle Amenity")
    public Mono<VehicleAmenityResponse> createAmenity(@Valid @RequestBody VehicleAmenityRequest request) {
        return Mono.just(mapper.toDomain(request))
                .flatMap(detailsUseCase::createAmenity)
                .map(mapper::toResponse);
    }

    @GetMapping("/amenities/vehicle/{vehicleId}")
    @Operation(summary = "Get Amenities by Vehicle ID")
    public Flux<VehicleAmenityResponse> getAmenitiesByVehicleId(@PathVariable UUID vehicleId) {
        return detailsUseCase.getAmenitiesByVehicleId(vehicleId)
                .map(mapper::toResponse);
    }

    @DeleteMapping("/amenities/{id}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @Operation(summary = "Delete Amenity")
    public Mono<Void> deleteAmenity(@PathVariable UUID id) {
        return detailsUseCase.deleteAmenity(id);
    }

    // CanTransport
    @PostMapping("/can-transports")
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "Create Vehicle Can Transport")
    public Mono<VehicleCanTransportResponse> createCanTransport(
            @Valid @RequestBody VehicleCanTransportRequest request) {
        return Mono.just(mapper.toDomain(request))
                .flatMap(detailsUseCase::createCanTransport)
                .map(mapper::toResponse);
    }

    @GetMapping("/can-transports/vehicle/{vehicleId}")
    @Operation(summary = "Get Can Transports by Vehicle ID")
    public Flux<VehicleCanTransportResponse> getCanTransportsByVehicleId(@PathVariable UUID vehicleId) {
        return detailsUseCase.getCanTransportsByVehicleId(vehicleId)
                .map(mapper::toResponse);
    }

    @DeleteMapping("/can-transports/{id}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @Operation(summary = "Delete Can Transport")
    public Mono<Void> deleteCanTransport(@PathVariable UUID id) {
        return detailsUseCase.deleteCanTransport(id);
    }

    // IllustrationImage
    @PostMapping("/illustration-images")
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "Create Vehicle Illustration Image")
    public Mono<VehicleIllustrationImageResponse> createIllustrationImage(
            @Valid @RequestBody VehicleIllustrationImageRequest request) {
        return Mono.just(mapper.toDomain(request))
                .flatMap(detailsUseCase::createIllustrationImage)
                .map(mapper::toResponse);
    }

    @GetMapping("/illustration-images/vehicle/{vehicleId}")
    @Operation(summary = "Get Illustration Images by Vehicle ID")
    public Flux<VehicleIllustrationImageResponse> getIllustrationImagesByVehicleId(@PathVariable UUID vehicleId) {
        return detailsUseCase.getIllustrationImagesByVehicleId(vehicleId)
                .map(mapper::toResponse);
    }

    @DeleteMapping("/illustration-images/{id}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @Operation(summary = "Delete Illustration Image")
    public Mono<Void> deleteIllustrationImage(@PathVariable UUID id) {
        return detailsUseCase.deleteIllustrationImage(id);
    }

    // Keyword
    @PostMapping("/keywords")
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "Create Vehicle Keyword")
    public Mono<VehicleKeywordResponse> createKeyword(@Valid @RequestBody VehicleKeywordRequest request) {
        return Mono.just(mapper.toDomain(request))
                .flatMap(detailsUseCase::createKeyword)
                .map(mapper::toResponse);
    }

    @GetMapping("/keywords/vehicle/{vehicleId}")
    @Operation(summary = "Get Keywords by Vehicle ID")
    public Flux<VehicleKeywordResponse> getKeywordsByVehicleId(@PathVariable UUID vehicleId) {
        return detailsUseCase.getKeywordsByVehicleId(vehicleId)
                .map(mapper::toResponse);
    }

    @DeleteMapping("/keywords/{id}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @Operation(summary = "Delete Keyword")
    public Mono<Void> deleteKeyword(@PathVariable UUID id) {
        return detailsUseCase.deleteKeyword(id);
    }

    // Review
    @PostMapping("/reviews")
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "Create Vehicle Review")
    public Mono<VehicleReviewResponse> createReview(@Valid @RequestBody VehicleReviewRequest request) {
        return Mono.just(mapper.toDomain(request))
                .flatMap(detailsUseCase::createReview)
                .map(mapper::toResponse);
    }

    @GetMapping("/reviews/vehicle/{vehicleId}")
    @Operation(summary = "Get Reviews by Vehicle ID")
    public Flux<VehicleReviewResponse> getReviewsByVehicleId(@PathVariable UUID vehicleId) {
        return detailsUseCase.getReviewsByVehicleId(vehicleId)
                .map(mapper::toResponse);
    }

    @DeleteMapping("/reviews/{id}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @Operation(summary = "Delete Review")
    public Mono<Void> deleteReview(@PathVariable UUID id) {
        return detailsUseCase.deleteReview(id);
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/GlobalExceptionHandler.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest;

import com.yowyob.template.domain.exception.NotFoundException;
import com.yowyob.template.domain.exception.StockFullException;
import lombok.extern.slf4j.Slf4j;
import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.dao.DuplicateKeyException;
import org.springframework.http.HttpStatus;
import org.springframework.http.ProblemDetail;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.springframework.web.bind.support.WebExchangeBindException;
import org.springframework.web.server.ResponseStatusException;

import java.net.URI;
import java.util.stream.Collectors;

@Slf4j
@RestControllerAdvice
public class GlobalExceptionHandler {

    @ExceptionHandler(StockFullException.class)
    public ProblemDetail handleStockException(StockFullException ex) {
        ProblemDetail problem = ProblemDetail.forStatusAndDetail(HttpStatus.CONFLICT, ex.getMessage());
        problem.setTitle("Stock Overflow");
        problem.setType(URI.create("errors/stock-full"));
        return problem;
    }

    @ExceptionHandler(NotFoundException.class)
    public ProblemDetail handleNotFoundException(NotFoundException ex) {
        ProblemDetail problem = ProblemDetail.forStatusAndDetail(HttpStatus.NOT_FOUND, ex.getMessage());
        problem.setTitle("Ressource non trouvÃ©e");
        problem.setType(URI.create("errors/not-found"));
        return problem;
    }

    @ExceptionHandler(WebExchangeBindException.class)
    public ProblemDetail handleValidationException(WebExchangeBindException ex) {
        String errors = ex.getBindingResult().getFieldErrors().stream()
                .map(error -> error.getField() + ": " + error.getDefaultMessage())
                .collect(Collectors.joining(", "));

        ProblemDetail problem = ProblemDetail.forStatusAndDetail(HttpStatus.BAD_REQUEST, "Erreur de validation");
        problem.setTitle("DonnÃ©es invalides");
        problem.setType(URI.create("errors/validation-error"));
        problem.setProperty("errors", errors);
        return problem;
    }
    
    @ExceptionHandler(DuplicateKeyException.class)
    public ProblemDetail handleDuplicateKeyException(DuplicateKeyException ex) {
        // On log l'erreur technique pour le dÃ©veloppeur
        log.error("Erreur de clÃ© dupliquÃ©e (SQL) : ", ex);

        String message = extractConstraintName(ex.getMessage());
        
        ProblemDetail problem = ProblemDetail.forStatusAndDetail(HttpStatus.CONFLICT, message);
        problem.setTitle("Conflit de donnÃ©es (Doublon)");
        problem.setType(URI.create("errors/duplicate-key"));
        
        // On ajoute le dÃ©tail technique pour aider au debug (visible dans le JSON)
        problem.setProperty("technical_detail", ex.getCause() != null ? ex.getCause().getMessage() : ex.getMessage());
        
        return problem;
    }
    
    @ExceptionHandler(DataIntegrityViolationException.class)
    public ProblemDetail handleDataIntegrityViolationException(DataIntegrityViolationException ex) {
        log.error("Violation d'intÃ©gritÃ© (SQL) : ", ex);
        String message = extractConstraintMessage(ex.getMessage());
        
        // Si c'est une violation de clÃ© Ã©trangÃ¨re, retourner 400
        HttpStatus status = ex.getMessage() != null && ex.getMessage().contains("foreign key") 
                ? HttpStatus.BAD_REQUEST 
                : HttpStatus.CONFLICT;

        ProblemDetail problem = ProblemDetail.forStatusAndDetail(status, message);
        problem.setTitle("Violation de contrainte");
        problem.setType(URI.create("errors/data-integrity"));
        return problem;
    }
    
    @ExceptionHandler(ResponseStatusException.class)
    public ProblemDetail handleResponseStatusException(ResponseStatusException ex) {
        ProblemDetail problem = ProblemDetail.forStatusAndDetail(
                HttpStatus.valueOf(ex.getStatusCode().value()), 
                ex.getReason() != null ? ex.getReason() : "Erreur HTTP"
        );
        problem.setTitle("Erreur " + ex.getStatusCode().value());
        return problem;
    }
    
    /**
     * Extrait le nom de la contrainte du message d'erreur pour DuplicateKeyException
     */
    private String extractConstraintName(String message) {
        if (message == null) {
            return "Une entrÃ©e avec cette valeur existe dÃ©jÃ ";
        }
        
        // Gestion spÃ©cifique des contraintes dÃ©finies dans schema.sql
        if (message.contains("idx_unique_primary_vehicle_per_role")) {
            return "Vous avez dÃ©jÃ  un vÃ©hicule dÃ©fini comme 'Principal'. Un seul est autorisÃ© par rÃ´le.";
        }
        if (message.contains("vehicle_serial_number")) {
            return "Un vÃ©hicule avec ce numÃ©ro de sÃ©rie (VIN) existe dÃ©jÃ .";
        }
        if (message.contains("registration_number")) {
            return "Un vÃ©hicule avec ce numÃ©ro d'immatriculation existe dÃ©jÃ .";
        }
        // Pour les tables de rÃ©fÃ©rence (Smart Creation)
        if (message.contains("make_name")) return "Cette marque existe dÃ©jÃ  (concurrence).";
        if (message.contains("model_name")) return "Ce modÃ¨le existe dÃ©jÃ  (concurrence).";
        
        return "Une entrÃ©e avec cette valeur existe dÃ©jÃ .";
    }
    
    /**
     * Extrait un message lisible pour les violations d'intÃ©gritÃ©
     */
    private String extractConstraintMessage(String message) {
        if (message == null) return "Violation de contrainte d'intÃ©gritÃ© des donnÃ©es";
        
        if (message.contains("vehicleownership_vehicle_id_fkey")) return "Le vÃ©hicule spÃ©cifiÃ© n'existe pas.";
        if (message.contains("vehicleownership_party_id_fkey")) return "L'utilisateur spÃ©cifiÃ© n'existe pas.";
        
        return "Violation de contrainte d'intÃ©gritÃ© des donnÃ©es (ClÃ© Ã©trangÃ¨re ou Check failed).";
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/details/VehicleAmenityResponse.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details;

import java.util.UUID;

public record VehicleAmenityResponse(
        UUID vehicleAmenityId,
        UUID vehicleId,
        String amenityName) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/details/VehicleCanTransportResponse.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details;

import java.util.UUID;

public record VehicleCanTransportResponse(
        UUID vehicleCanTransportId,
        UUID vehicleId,
        String item) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/details/VehicleKeywordRequest.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details;

import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import java.util.UUID;

public record VehicleKeywordRequest(
        @NotNull(message = "Vehicle ID is required") UUID vehicleId,
        @NotBlank(message = "Keyword is required") String keyword) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/details/VehicleIllustrationImageResponse.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details;

import java.util.UUID;

public record VehicleIllustrationImageResponse(
        UUID vehicleIllustrationImageId,
        UUID vehicleId,
        String imagePath) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/details/VehicleIllustrationImageRequest.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details;

import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import java.util.UUID;

public record VehicleIllustrationImageRequest(
        @NotNull(message = "Vehicle ID is required") UUID vehicleId,
        @NotBlank(message = "Image path is required") String imagePath) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/details/VehicleAmenityRequest.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details;

import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import java.util.UUID;

public record VehicleAmenityRequest(
        @NotNull(message = "Vehicle ID is required") UUID vehicleId,
        @NotBlank(message = "Amenity name is required") String amenityName) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/details/VehicleCanTransportRequest.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details;

import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import java.util.UUID;

public record VehicleCanTransportRequest(
        @NotNull(message = "Vehicle ID is required") UUID vehicleId,
        @NotBlank(message = "Item is required") String item) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/details/VehicleReviewResponse.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details;

import java.util.UUID;

public record VehicleReviewResponse(
        UUID vehicleId,
        UUID reviewId) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/details/VehicleReviewRequest.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details;

import jakarta.validation.constraints.NotNull;
import java.util.UUID;

public record VehicleReviewRequest(
        @NotNull(message = "Vehicle ID is required") UUID vehicleId,
        @NotNull(message = "Review ID is required") UUID reviewId) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/details/VehicleKeywordResponse.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details;

import java.util.UUID;

public record VehicleKeywordResponse(
        UUID vehicleKeywordId,
        UUID vehicleId,
        String keyword) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/lookup/VehicleSizeResponse.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup;

import java.time.LocalDateTime;
import java.util.UUID;

public record VehicleSizeResponse(
        UUID vehicleSizeId,
        String sizeName,
        LocalDateTime createdAt,
        LocalDateTime updatedAt) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/lookup/TransmissionTypeRequest.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup;

import jakarta.validation.constraints.NotBlank;

public record TransmissionTypeRequest(
        @NotBlank(message = "Transmission type name is required") String typeName) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/lookup/VehicleMakeRequest.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup;

import jakarta.validation.constraints.NotBlank;

public record VehicleMakeRequest(
        @NotBlank(message = "Make name is required") String makeName) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/lookup/VehicleMakeResponse.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup;

import java.util.UUID;

public record VehicleMakeResponse(
        UUID vehicleMakeId,
        String makeName) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/lookup/VehicleModelResponse.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup;

import java.time.LocalDateTime;
import java.util.UUID;

public record VehicleModelResponse(
        UUID vehicleModelId,
        String modelName,
        LocalDateTime createdAt,
        LocalDateTime updatedAt) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/lookup/FuelTypeRequest.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup;

import jakarta.validation.constraints.NotBlank;

public record FuelTypeRequest(
        @NotBlank(message = "Fuel type name is required") String fuelTypeName) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/lookup/VehicleModelRequest.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup;

import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import java.util.UUID;

public record VehicleModelRequest(
        @NotNull(message = "Vehicle make ID is required") UUID vehicleMakeId,
        @NotBlank(message = "Model name is required") String modelName) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/lookup/VehicleSizeRequest.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup;

import jakarta.validation.constraints.NotBlank;

public record VehicleSizeRequest(
        @NotBlank(message = "Size name is required") String sizeName) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/lookup/TransmissionTypeResponse.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup;

import java.time.LocalDateTime;
import java.util.UUID;

public record TransmissionTypeResponse(
        UUID transmissionTypeId,
        String typeName,
        LocalDateTime createdAt,
        LocalDateTime updatedAt) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/lookup/VehicleTypeRequest.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup;

import jakarta.validation.constraints.NotBlank;

public record VehicleTypeRequest(
        @NotBlank(message = "Type name is required") String typeName) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/lookup/FuelTypeResponse.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup;

import java.util.UUID;

public record FuelTypeResponse(
        UUID fuelTypeId,
        String fuelTypeName) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/lookup/ManufacturerResponse.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup;

import java.util.UUID;

public record ManufacturerResponse(
        UUID manufacturerId,
        String manufacturerName) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/lookup/ManufacturerRequest.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup;

import jakarta.validation.constraints.NotBlank;

public record ManufacturerRequest(
        @NotBlank(message = "Manufacturer name is required") String manufacturerName) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/lookup/VehicleTypeResponse.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.lookup;

import java.util.UUID;

public record VehicleTypeResponse(
        UUID vehicleTypeId,
        String typeName) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/SimplifiedVehicleRequest.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto;

import io.swagger.v3.oas.annotations.media.Schema;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.NotNull;
import java.math.BigDecimal;
import java.time.LocalDateTime;

public record SimplifiedVehicleRequest(
    
    // ==================================================================================
    // 1. CHAMPS OBLIGATOIRES (RÃ©fÃ©rences "Smart")
    // ==================================================================================
    
    @NotBlank(message = "La marque est obligatoire")
    @Schema(description = "Marque du vÃ©hicule", example = "Toyota", requiredMode = Schema.RequiredMode.REQUIRED)
    String makeName,

    @NotBlank(message = "Le modÃ¨le est obligatoire")
    @Schema(description = "ModÃ¨le du vÃ©hicule", example = "Corolla Hybride", requiredMode = Schema.RequiredMode.REQUIRED)
    String modelName,

    @NotBlank(message = "Le type de transmission est obligatoire")
    @Schema(description = "Type de transmission", example = "Automatique", requiredMode = Schema.RequiredMode.REQUIRED)
    String transmissionType,

    @NotBlank(message = "Le nom du fabricant est obligatoire")
    @Schema(description = "Fabricant (Usine d'assemblage ou Groupe)", example = "Toyota Tsutsumi Plant", requiredMode = Schema.RequiredMode.REQUIRED)
    String manufacturerName,

    @NotBlank(message = "La taille/gabarit est obligatoire")
    @Schema(description = "Taille/Gabarit du vÃ©hicule", example = "Berline Compacte", requiredMode = Schema.RequiredMode.REQUIRED)
    String sizeName,

    @NotBlank(message = "Le type d'usage est obligatoire")
    @Schema(description = "Usage/Type du vÃ©hicule", example = "Personnel", requiredMode = Schema.RequiredMode.REQUIRED)
    String typeName,

    @NotBlank(message = "Le type de carburant est obligatoire")
    @Schema(description = "Carburant", example = "Hybride Essence", requiredMode = Schema.RequiredMode.REQUIRED)
    String fuelTypeName,

    // ==================================================================================
    // 2. CHAMPS DÃ‰TAILS (Peuvent Ãªtre null)
    // ==================================================================================

    @Schema(description = "NumÃ©ro de sÃ©rie (VIN)", example = "SN-JW8292839182")
    String vehicleSerialNumber,

    @Schema(description = "URL de la photo du numÃ©ro de sÃ©rie", example = "https://cloud.storage.com/vehicles/vin/123.jpg")
    String vehicleSerialPhoto,

    @Schema(description = "Plaque d'immatriculation", example = "LT-458-XY")
    String registrationNumber,

    @Schema(description = "URL de la photo de la carte grise", example = "https://cloud.storage.com/vehicles/reg/123.jpg")
    String registrationPhoto,
    
    @Schema(description = "Date d'expiration de l'immatriculation (Format ISO)", example = "2028-12-31T23:59:59")
    LocalDateTime registrationExpiryDate,

    @Schema(description = "CapacitÃ© du rÃ©servoir (Litres ou kWh)", example = "45.5")
    BigDecimal tankCapacity,

    @Schema(description = "CapacitÃ© max des bagages (kg ou Litres)", example = "360")
    BigDecimal luggageMaxCapacity,

    @Schema(description = "Nombre total de siÃ¨ges (y compris conducteur)", example = "5")
    Integer totalSeatNumber,

    @Schema(description = "Consommation moyenne (L/100km ou kWh/100km)", example = "4.2")
    BigDecimal averageFuelConsumptionPerKm,

    @Schema(description = "KilomÃ©trage initial (Ã  l'achat)", example = "10")
    BigDecimal mileageAtStart,

    @Schema(description = "KilomÃ©trage actuel (depuis mise en service)", example = "15420.5")
    BigDecimal mileageSinceCommissioning,

    @Schema(description = "Ã‚ge du vÃ©hicule au dÃ©but (annÃ©es)", example = "0.5")
    BigDecimal vehicleAgeAtStart,

    @Schema(description = "Marque commerciale (souvent identique Ã  la Marque)", example = "Toyota")
    String brand
) {}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/VehicleRequest.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto;

import java.math.BigDecimal;
import java.util.UUID;

/**
 * DTO utilisÃ© pour crÃ©er un vÃ©hicule.
 * Les champs non fournis ici seront gÃ©nÃ©rÃ©s automatiquement (UUID, dates).
 */
public record VehicleRequest(
                UUID vehicleMakeId,
                UUID vehicleModelId,
                UUID transmissionTypeId,
                UUID manufacturerId,
                UUID vehicleSizeId,
                UUID vehicleTypeId,
                UUID fuelTypeId,

                String vehicleSerialNumber,
                String vehicleSerialPhoto,
                String registrationNumber,
                String registrationPhoto,
                BigDecimal tankCapacity,
                BigDecimal luggageMaxCapacity,
                Integer totalSeatNumber,
                BigDecimal averageFuelConsumptionPerKm,
                BigDecimal mileageAtStart,
                BigDecimal mileageSinceCommissioning,
                BigDecimal vehicleAgeAtStart,
                String brand) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/PatchVehicleRequest.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto;

import io.swagger.v3.oas.annotations.media.Schema;
import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.UUID;

/**
 * DTO spÃ©cifique pour le PATCH.
 * Tous les champs sont optionnels. Seuls les champs non-null seront mis Ã  jour.
 */
public record PatchVehicleRequest(
    // RÃ©fÃ©rences (IDs)
    @Schema(description = "ID de la marque") UUID vehicleMakeId,
    @Schema(description = "ID du modÃ¨le") UUID vehicleModelId,
    @Schema(description = "ID de la transmission") UUID transmissionTypeId,
    @Schema(description = "ID du fabricant") UUID manufacturerId,
    @Schema(description = "ID de la taille") UUID vehicleSizeId,
    @Schema(description = "ID du type") UUID vehicleTypeId,
    @Schema(description = "ID du carburant") UUID fuelTypeId,

    // Infos textuelles
    @Schema(description = "NumÃ©ro de sÃ©rie") String vehicleSerialNumber,
    @Schema(description = "Photo SÃ©rie") String vehicleSerialPhoto,
    @Schema(description = "Immatriculation") String registrationNumber,
    @Schema(description = "Photo Carte Grise") String registrationPhoto,
    @Schema(description = "Expiration Carte Grise") LocalDateTime registrationExpiryDate,

    // DonnÃ©es numÃ©riques
    BigDecimal tankCapacity,
    BigDecimal luggageMaxCapacity,
    Integer totalSeatNumber,
    BigDecimal averageFuelConsumptionPerKm,
    BigDecimal mileageAtStart,
    BigDecimal mileageSinceCommissioning,
    BigDecimal vehicleAgeAtStart,
    String brand
) {}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/ProductResponse.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto;
import java.math.BigDecimal;
import java.util.UUID;


public record ProductResponse(UUID id, String name, BigDecimal price, String status) {}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/ProductRequest.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto;
import jakarta.validation.constraints.NotBlank;
import jakarta.validation.constraints.Positive;
import java.math.BigDecimal;


public record ProductRequest(@NotBlank String name, @Positive BigDecimal price) {}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/ownership/VehicleOwnershipResponse.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.ownership;

import com.yowyob.template.domain.model.vehicle.ownership.UsageRole;

import java.time.LocalDateTime;
import java.util.UUID;

public record VehicleOwnershipResponse(
        UUID vehicleOwnershipId,
        UUID vehicleId,
        UUID partyId,
        UsageRole usageRole,
        boolean isPrimary,
        LocalDateTime validFrom,
        LocalDateTime validTo) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/ownership/VehicleOwnershipRequest.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.ownership;

import com.yowyob.template.domain.model.vehicle.ownership.UsageRole;
import io.swagger.v3.oas.annotations.media.Schema;
import jakarta.validation.constraints.NotNull;

import java.time.LocalDateTime;
import java.util.UUID;

/**
 * Request DTO pour crÃ©er une ownership de vÃ©hicule.
 * Note: partyId est automatiquement rÃ©cupÃ©rÃ© depuis l'utilisateur authentifiÃ©.
 */
public record VehicleOwnershipRequest(
        @NotNull(message = "Vehicle ID is required") 
        @Schema(description = "ID du vÃ©hicule")
        UUID vehicleId,
        
        @NotNull(message = "Usage role is required") 
        @Schema(description = "RÃ´le d'utilisation (OWNER, DRIVER, etc.)")
        UsageRole usageRole,
        
        @Schema(description = "Indique si c'est l'ownership principal")
        boolean isPrimary,
        
        @Schema(description = "Date de dÃ©but de validitÃ©")
        LocalDateTime validFrom,
        
        @Schema(description = "Date de fin de validitÃ©")
        LocalDateTime validTo) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/VehicleResponse.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.UUID;

/**
 * DTO utilisÃ© pour renvoyer les informations d'un vÃ©hicule.
 * Contient tous les champs utiles pour l'affichage cÃ´tÃ© client.
 */
public record VehicleResponse(
                UUID vehicleId,
                UUID vehicleMakeId,
                UUID vehicleModelId,
                UUID transmissionTypeId,
                UUID manufacturerId,
                UUID vehicleSizeId,
                UUID vehicleTypeId,
                UUID fuelTypeId,

                String vehicleSerialNumber,
                String vehicleSerialPhoto,
                String registrationNumber,
                String registrationPhoto,
                LocalDateTime registrationExpiryDate,

                BigDecimal tankCapacity,
                BigDecimal luggageMaxCapacity,
                Integer totalSeatNumber,

                BigDecimal averageFuelConsumptionPerKm,
                BigDecimal mileageAtStart,
                BigDecimal mileageSinceCommissioning,
                BigDecimal vehicleAgeAtStart,

                String brand,
                LocalDateTime createdAt,
                LocalDateTime updatedAt) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/party/PartyRequest.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.party;

import com.yowyob.template.domain.model.party.PartyType;

public record PartyRequest(
        PartyType partyType,
        String displayName,
        String phone,
        String email) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/dto/party/PartyResponse.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest.dto.party;

import com.yowyob.template.domain.model.party.PartyType;

import java.util.UUID;

public record PartyResponse(
        UUID partyId,
        PartyType partyType,
        String displayName,
        String phone,
        String email) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/adapters/inbound/rest/VehicleMediaController.java`
```java
package com.yowyob.template.infrastructure.adapters.inbound.rest;

import com.yowyob.template.domain.ports.in.ManageVehicleMediaUseCase;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.VehicleResponse;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.details.VehicleIllustrationImageResponse;
import com.yowyob.template.infrastructure.mappers.VehicleDetailsMapper;
import com.yowyob.template.infrastructure.mappers.VehicleMapper;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import io.swagger.v3.oas.annotations.tags.Tag;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.codec.multipart.FilePart;
import org.springframework.web.bind.annotation.*;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;

@RestController
@RequestMapping("/vehicles")
@RequiredArgsConstructor
@Tag(name = "Vehicle Media", description = "Gestion des documents et photos des vÃ©hicules")
@SecurityRequirement(name = "bearerAuth")
public class VehicleMediaController {

    private final ManageVehicleMediaUseCase mediaUseCase;
    private final VehicleMapper vehicleMapper;
    private final VehicleDetailsMapper detailsMapper;

    // --- SERIAL PHOTO ---

    @PutMapping(value = "/{id}/documents/serial", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    @Operation(summary = "Mettre Ã  jour la photo NÂ° SÃ©rie (VIN)")
    public Mono<VehicleResponse> updateSerialPhoto(
            @PathVariable UUID id,
            @RequestPart("file") Mono<FilePart> filePartMono) {
        return filePartMono
                .flatMap(file -> mediaUseCase.uploadSerialPhoto(id, file))
                .map(vehicleMapper::toResponse);
    }

    @DeleteMapping("/{id}/documents/serial")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @Operation(summary = "Supprimer la photo NÂ° SÃ©rie")
    public Mono<Void> deleteSerialPhoto(@PathVariable UUID id) {
        return mediaUseCase.deleteSerialPhoto(id);
    }

    // --- REGISTRATION PHOTO ---

    @PutMapping(value = "/{id}/documents/registration", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    @Operation(summary = "Mettre Ã  jour la photo Carte Grise")
    public Mono<VehicleResponse> updateRegistrationPhoto(
            @PathVariable UUID id,
            @RequestPart("file") Mono<FilePart> filePartMono) {
        return filePartMono
                .flatMap(file -> mediaUseCase.uploadRegistrationPhoto(id, file))
                .map(vehicleMapper::toResponse);
    }

    @DeleteMapping("/{id}/documents/registration")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @Operation(summary = "Supprimer la photo Carte Grise")
    public Mono<Void> deleteRegistrationPhoto(@PathVariable UUID id) {
        return mediaUseCase.deleteRegistrationPhoto(id);
    }

    // --- ILLUSTRATIONS ---

    @GetMapping("/{id}/images")
    @Operation(summary = "Lister les images d'illustration")
    public Flux<VehicleIllustrationImageResponse> getIllustrations(@PathVariable UUID id) {
        return mediaUseCase.getIllustrationImages(id)
                .map(detailsMapper::toResponse);
    }

    @PostMapping(value = "/{id}/images", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    @ResponseStatus(HttpStatus.CREATED)
    @Operation(summary = "Ajouter une image d'illustration")
    public Mono<VehicleIllustrationImageResponse> addIllustration(
            @PathVariable UUID id,
            @RequestPart("file") Mono<FilePart> filePartMono) {
        return filePartMono
                .flatMap(file -> mediaUseCase.addIllustrationImage(id, file))
                .map(detailsMapper::toResponse);
    }

    @DeleteMapping("/images/{imageId}")
    @ResponseStatus(HttpStatus.NO_CONTENT)
    @Operation(summary = "Supprimer une image d'illustration")
    public Mono<Void> deleteIllustration(@PathVariable UUID imageId) {
        // Note: On pourrait passer le vehicleId aussi pour vÃ©rifier les droits
        return mediaUseCase.deleteIllustrationImage(null, imageId);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/config/WebClientConfig.java`
```java
package com.yowyob.template.infrastructure.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.reactive.function.client.ExchangeStrategies; // Import important
import org.springframework.web.reactive.function.client.WebClient;

@Configuration
public class WebClientConfig {

    @Bean
    public WebClient.Builder webClientBuilder() {
        // Augmenter la taille du buffer mÃ©moire Ã  16MB (par dÃ©faut 256KB)
        final int size = 16 * 1024 * 1024;
        final ExchangeStrategies strategies = ExchangeStrategies.builder()
                .codecs(codecs -> codecs.defaultCodecs().maxInMemorySize(size))
                .build();

        return WebClient.builder()
                .exchangeStrategies(strategies);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/config/RedisConfig.java`
```java
package com.yowyob.template.infrastructure.config;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.module.paramnames.ParameterNamesModule;
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.redis.connection.ReactiveRedisConnectionFactory;
import org.springframework.data.redis.core.ReactiveRedisTemplate;
import org.springframework.data.redis.serializer.*;

@Configuration
public class RedisConfig {

        @Bean
        public ReactiveRedisTemplate<String, Object> reactiveRedisTemplate(
                        ReactiveRedisConnectionFactory factory) {

                ObjectMapper mapper = new ObjectMapper()
                                .registerModule(new ParameterNamesModule())
                                .registerModule(new JavaTimeModule());

                Jackson2JsonRedisSerializer<Object> jsonSerializer = new Jackson2JsonRedisSerializer<>(mapper,
                                Object.class);

                RedisSerializationContext<String, Object> context = RedisSerializationContext
                                .<String, Object>newSerializationContext(new StringRedisSerializer())
                                .value(jsonSerializer)
                                .hashValue(jsonSerializer)
                                .build();

                return new ReactiveRedisTemplate<>(factory, context);
        }
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/config/KafkaConfig.java`
```java
package com.yowyob.template.infrastructure.config;

import org.apache.kafka.clients.producer.ProducerConfig;
import org.apache.kafka.common.serialization.StringSerializer;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.kafka.core.reactive.ReactiveKafkaProducerTemplate;
import reactor.kafka.sender.SenderOptions;

import java.util.HashMap;
import java.util.Map;

@Configuration
public class KafkaConfig {

    @Value("${spring.kafka.bootstrap-servers}")
    private String bootstrapServers;

    @Bean
    public ReactiveKafkaProducerTemplate<String, Object> reactiveKafkaProducerTemplate() {
        Map<String, Object> props = new HashMap<>();
        props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, bootstrapServers);
        props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);
        props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, org.springframework.kafka.support.serializer.JsonSerializer.class);

        SenderOptions<String, Object> senderOptions = SenderOptions.create(props);

        return new ReactiveKafkaProducerTemplate<>(senderOptions);
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/config/R2dbcAuditingConfig.java`
```java
package com.yowyob.template.infrastructure.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.data.r2dbc.config.EnableR2dbcAuditing;
import org.springframework.data.domain.ReactiveAuditorAware;
import reactor.core.publisher.Mono;

@Configuration
@EnableR2dbcAuditing
public class R2dbcAuditingConfig {

    @Bean
    public ReactiveAuditorAware<String> auditorAware() {
        // Pour l'instant, on retourne "system" comme auditeur
        // Plus tard, vous pouvez intÃ©grer Spring Security pour retourner l'utilisateur connectÃ©
        return () -> Mono.just("system");
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/config/OpenApiConfig.java`
```java
package com.yowyob.template.infrastructure.config;

import io.swagger.v3.oas.models.Components;
import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.info.Contact;
import io.swagger.v3.oas.models.info.Info;
import io.swagger.v3.oas.models.info.License;
import io.swagger.v3.oas.models.security.SecurityRequirement;
import io.swagger.v3.oas.models.security.SecurityScheme;
import io.swagger.v3.oas.models.servers.Server;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.List;

@Configuration
public class OpenApiConfig {

    private static final String SECURITY_SCHEME_NAME = "bearerAuth";

    @Bean
    public OpenAPI customOpenAPI() {
        
        // 1. Serveur Local (PRIORITAIRE pour le dev)
        Server localServer = new Server()
                .url("http://localhost:8080")
                .description("Serveur Local (HTTP) - DEV");

        // 2. Serveur de Production
        Server prodServer = new Server()
                .url("https://vehicule-service.pynfi.com")
                .description("Serveur de Production (HTTPS)");

        return new OpenAPI()
                // <-- L'ordre est important : Local en premier par dÃ©faut
                .servers(List.of(localServer, prodServer)) 
                .info(new Info()
                        .title("YowYob Vehicle Service API")
                        .version("1.0.0")
                        .description("API de gestion des vÃ©hicules.")
                        .contact(new Contact().name("Ã‰quipe Backend").email("dev@yowyob.com"))
                        .license(new License().name("Apache 2.0").url("http://springdoc.org")))
                .addSecurityItem(new SecurityRequirement().addList(SECURITY_SCHEME_NAME))
                .components(new Components()
                        .addSecuritySchemes(SECURITY_SCHEME_NAME, new SecurityScheme()
                                .name(SECURITY_SCHEME_NAME)
                                .type(SecurityScheme.Type.HTTP)
                                .scheme("bearer")
                                .bearerFormat("JWT")
                                .description("Entrez votre token JWT.")));
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/config/KafkaTopicConfig.java`
```java
package com.yowyob.template.infrastructure.config;

import org.apache.kafka.clients.admin.NewTopic;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.kafka.config.TopicBuilder;

@Configuration
public class KafkaTopicConfig {

    // Cette ligne va lire la valeur depuis ton application.yml
    @Value("${application.kafka.topics.product-events}")
    private String productEventsTopicName;

    @Bean
    public NewTopic productEventsTopic() {
        // Cela dit Ã  Spring de crÃ©er ce topic au dÃ©marrage s'il n'existe pas
        return TopicBuilder.name(productEventsTopicName)
                .partitions(1) // 1 partition est parfaite pour le dev local
                .replicas(1) // 1 rÃ©plique est obligatoire pour un broker seul
                .build();
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/security/SecurityConfig.java`
```java
package com.yowyob.template.infrastructure.security;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpMethod; // <--- Import nÃ©cessaire
import org.springframework.http.HttpStatus;
import org.springframework.security.config.annotation.method.configuration.EnableReactiveMethodSecurity;
import org.springframework.security.config.annotation.web.reactive.EnableWebFluxSecurity;
import org.springframework.security.config.web.server.SecurityWebFiltersOrder;
import org.springframework.security.config.web.server.ServerHttpSecurity;
import org.springframework.security.web.server.SecurityWebFilterChain;
import org.springframework.security.web.server.context.NoOpServerSecurityContextRepository;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.reactive.CorsWebFilter;
import org.springframework.web.cors.reactive.UrlBasedCorsConfigurationSource;
import reactor.core.publisher.Mono;

import java.util.List;

@Configuration
@EnableWebFluxSecurity
@EnableReactiveMethodSecurity
public class SecurityConfig {

    private final AuthServiceClient authServiceClient;
    private final JwtAuthenticationFilter jwtAuthenticationFilter;

    public SecurityConfig(AuthServiceClient authServiceClient) {
        this.authServiceClient = authServiceClient;
        this.jwtAuthenticationFilter = new JwtAuthenticationFilter(authServiceClient);
    }

    @Bean
    public SecurityWebFilterChain securityWebFilterChain(ServerHttpSecurity http) {
        return http
                // On laisse le CorsWebFilter gÃ©rer le CORS
                .cors(ServerHttpSecurity.CorsSpec::disable)
                .csrf(ServerHttpSecurity.CsrfSpec::disable)
                .securityContextRepository(NoOpServerSecurityContextRepository.getInstance())
                .exceptionHandling(exceptionHandling -> exceptionHandling
                        .authenticationEntryPoint((exchange, ex) -> {
                            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
                            return Mono.empty();
                        })
                        .accessDeniedHandler((exchange, denied) -> {
                            exchange.getResponse().setStatusCode(HttpStatus.FORBIDDEN);
                            return Mono.empty();
                        })
                )
                .authorizeExchange(exchanges -> exchanges
                        // ðŸ‘‡ INDISPENSABLE : On autorise TOUTES les requÃªtes OPTIONS (CORS preflight) sans token
                        .pathMatchers(HttpMethod.OPTIONS).permitAll()
                        
                        // Tes routes publiques (Swagger, etc.)
                        .pathMatchers("/swagger-ui.html", "/swagger-ui/**", "/v3/api-docs/**", "/webjars/**", "/actuator/**").permitAll()
                        
                        // Tout le reste nÃ©cessite un token
                        .anyExchange().authenticated()
                )
                .addFilterAt(jwtAuthenticationFilter, SecurityWebFiltersOrder.AUTHENTICATION)
                .build();
    }

    @Bean
    public CorsWebFilter corsWebFilter() {
        CorsConfiguration corsConfig = new CorsConfiguration();
        // En prod, l'Ã©toile '*' peut Ãªtre bloquÃ©e par certains navigateurs si allowCredentials=true
        // Mieux vaut utiliser setAllowedOriginPatterns qui est plus souple
        corsConfig.setAllowedOriginPatterns(List.of("*")); 
        corsConfig.setMaxAge(8000L);
        corsConfig.addAllowedMethod("*");
        corsConfig.addAllowedHeader("*");
        corsConfig.setAllowCredentials(true);

        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", corsConfig);

        return new CorsWebFilter(source);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/security/AuthenticatedUser.java`
```java
package com.yowyob.template.infrastructure.security;

import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;

import java.util.Collection;
import java.util.List;
import java.util.stream.Collectors;
import java.util.stream.Stream;

/**
 * ReprÃ©sente un utilisateur authentifiÃ© dans le systÃ¨me.
 * ImplÃ©mente UserDetails de Spring Security.
 */
public class AuthenticatedUser implements UserDetails {

    private final String id;
    private final String username;
    private final String email;
    private final String phone;
    private final String firstName;
    private final String lastName;
    private final List<String> roles;
    private final List<String> permissions;

    public AuthenticatedUser(String id, String username, String email, String phone,
                             String firstName, String lastName,
                             List<String> roles, List<String> permissions) {
        this.id = id;
        this.username = username;
        this.email = email;
        this.phone = phone;
        this.firstName = firstName;
        this.lastName = lastName;
        this.roles = roles != null ? roles : List.of();
        this.permissions = permissions != null ? permissions : List.of();
    }

    public String getId() {
        return id;
    }

    public String getEmail() {
        return email;
    }

    public String getPhone() {
        return phone;
    }

    public String getFirstName() {
        return firstName;
    }

    public String getLastName() {
        return lastName;
    }

    public List<String> getRoles() {
        return roles;
    }

    public List<String> getPermissions() {
        return permissions;
    }

    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        // Combine roles (avec prÃ©fixe ROLE_) et permissions
        return Stream.concat(
                roles.stream().map(role -> new SimpleGrantedAuthority("ROLE_" + role)),
                permissions.stream().map(SimpleGrantedAuthority::new)
        ).collect(Collectors.toList());
    }

    @Override
    public String getPassword() {
        return null; // Pas de mot de passe stockÃ© localement
    }

    @Override
    public String getUsername() {
        return username;
    }

    @Override
    public boolean isAccountNonExpired() {
        return true;
    }

    @Override
    public boolean isAccountNonLocked() {
        return true;
    }

    @Override
    public boolean isCredentialsNonExpired() {
        return true;
    }

    @Override
    public boolean isEnabled() {
        return true;
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/security/JwtAuthenticationFilter.java`
```java
//---> PATH: src/main/java/com/yowyob/template/infrastructure/security/JwtAuthenticationFilter.java

package com.yowyob.template.infrastructure.security;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.core.io.buffer.DataBuffer;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.server.reactive.ServerHttpRequest;
import org.springframework.http.server.reactive.ServerHttpResponse;
import org.springframework.security.core.context.ReactiveSecurityContextHolder;
import org.springframework.web.server.ServerWebExchange;
import org.springframework.web.server.WebFilter;
import org.springframework.web.server.WebFilterChain;
import reactor.core.publisher.Mono;

import java.nio.charset.StandardCharsets;

/**
 * Filtre WebFlux pour l'authentification JWT.
 * Intercepte les requÃªtes, extrait le token et vÃ©rifie l'authentification
 * auprÃ¨s du service externe.
 * 
 * Note: Ne pas ajouter @Component car le filtre est enregistrÃ© manuellement
 * dans SecurityConfig via addFilterAt().
 */
public class JwtAuthenticationFilter implements WebFilter {

    private static final Logger log = LoggerFactory.getLogger(JwtAuthenticationFilter.class);
    private static final String BEARER_PREFIX = "Bearer ";

    private final AuthServiceClient authServiceClient;

    public JwtAuthenticationFilter(AuthServiceClient authServiceClient) {
        this.authServiceClient = authServiceClient;
    }

    // Exception interne pour contrÃ´ler le flux rÃ©actif sans exposer d'erreur systÃ¨me
    private static class TokenInvalidException extends RuntimeException {}

    @Override
    public Mono<Void> filter(ServerWebExchange exchange, WebFilterChain chain) {
        String token = extractToken(exchange.getRequest());
        
        // 1. Si pas de token, on laisse passer (la config Security dÃ©cidera si c'est public ou non)
        if (token == null) {
            log.debug("Pas de token trouvÃ©, laisse passer la requÃªte: {}", exchange.getRequest().getPath());
            return chain.filter(exchange);
        }

        log.debug("Token trouvÃ©, vÃ©rification auprÃ¨s du service d'auth pour: {}", exchange.getRequest().getPath());

        return authServiceClient.verifyToken(token)
                // 2. Si verifyToken renvoie empty (token invalide), on lÃ¨ve une erreur spÃ©cifique ICI
                .switchIfEmpty(Mono.error(new TokenInvalidException()))
                
                // 3. Si on arrive ici, c'est que le token est valide (user n'est pas null)
                .flatMap(authenticatedUser -> {
                    log.debug("Token valide pour l'utilisateur: {}", authenticatedUser.getId());
                    JwtAuthenticationToken authentication = new JwtAuthenticationToken(
                            authenticatedUser,
                            token,
                            authenticatedUser.getAuthorities()
                    );
                    
                    // On injecte l'authentification et on passe la main au contrÃ´leur
                    return chain.filter(exchange)
                            .contextWrite(ReactiveSecurityContextHolder.withAuthentication(authentication));
                })
                
                // 4. On attrape uniquement l'erreur "TokenInvalidException" pour renvoyer le 401
                // Les autres erreurs (ex: contrÃ´leur qui crash) ne passeront pas par ici.
                .onErrorResume(TokenInvalidException.class, e -> handleUnauthorized(exchange));
    }
    
    /**
     * GÃ¨re le cas d'un token invalide ou expirÃ© en retournant une rÃ©ponse 401.
     * Cette mÃ©thode retourne un Mono<Void> qui termine la rÃ©ponse immÃ©diatement.
     */
    private Mono<Void> handleUnauthorized(ServerWebExchange exchange) {
        log.warn("Token invalide ou expirÃ© pour la requÃªte: {}", exchange.getRequest().getPath());
        
        ServerHttpResponse response = exchange.getResponse();
        
        // VÃ©rifier si la rÃ©ponse n'est pas dÃ©jÃ  committed
        if (response.isCommitted()) {
            return Mono.empty();
        }
        
        response.setStatusCode(HttpStatus.UNAUTHORIZED);
        response.getHeaders().setContentType(MediaType.APPLICATION_JSON);
        
        String errorBody = "{\"error\":\"Unauthorized\",\"message\":\"Token invalide ou expirÃ©\",\"status\":401}";
        byte[] bytes = errorBody.getBytes(StandardCharsets.UTF_8);
        DataBuffer buffer = response.bufferFactory().wrap(bytes);
        
        return response.writeWith(Mono.just(buffer));
    }

    private String extractToken(ServerHttpRequest request) {
        String authHeader = request.getHeaders().getFirst(HttpHeaders.AUTHORIZATION);
        
        if (authHeader != null && authHeader.startsWith(BEARER_PREFIX)) {
            return authHeader.substring(BEARER_PREFIX.length());
        }
        
        return null;
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/security/dto/AuthUserResponse.java`
```java
package com.yowyob.template.infrastructure.security.dto;

import java.util.List;

/**
 * DTO reprÃ©sentant la rÃ©ponse du service d'authentification externe.
 * Correspond Ã  la rÃ©ponse de GET /api/auth/me
 */
public record AuthUserResponse(
        String id,
        String username,
        String email,
        String phone,
        String firstName,
        String lastName,
        List<String> roles,
        List<String> permissions
) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/security/JwtAuthenticationToken.java`
```java
package com.yowyob.template.infrastructure.security;

import org.springframework.security.authentication.AbstractAuthenticationToken;
import org.springframework.security.core.GrantedAuthority;

import java.util.Collection;

/**
 * Token d'authentification JWT personnalisÃ©.
 * UtilisÃ© pour stocker les informations de l'utilisateur authentifiÃ© dans le contexte de sÃ©curitÃ©.
 */
public class JwtAuthenticationToken extends AbstractAuthenticationToken {

    private final AuthenticatedUser principal;
    private final String token;

    public JwtAuthenticationToken(AuthenticatedUser principal, String token,
                                  Collection<? extends GrantedAuthority> authorities) {
        super(authorities);
        this.principal = principal;
        this.token = token;
        setAuthenticated(true);
    }

    @Override
    public Object getCredentials() {
        return token;
    }

    @Override
    public AuthenticatedUser getPrincipal() {
        return principal;
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/infrastructure/security/AuthServiceClient.java`
```java
package com.yowyob.template.infrastructure.security;

import com.yowyob.template.infrastructure.security.dto.AuthUserResponse;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatusCode;
import org.springframework.stereotype.Component;
import org.springframework.web.reactive.function.client.WebClient;
import reactor.core.publisher.Mono;

/**
 * Client pour communiquer avec le service d'authentification externe.
 * VÃ©rifie les tokens et rÃ©cupÃ¨re les informations utilisateur.
 */
@Component
public class AuthServiceClient {

    private static final Logger log = LoggerFactory.getLogger(AuthServiceClient.class);
    
    private final WebClient webClient;

    public AuthServiceClient(
            WebClient.Builder webClientBuilder,
            @Value("${auth.service.url:https://auth-service.pynfi.com}") String authServiceUrl) {
        this.webClient = webClientBuilder
                .baseUrl(authServiceUrl)
                .build();
    }

    /**
     * VÃ©rifie le token en appelant le endpoint /api/auth/me du service d'authentification.
     * 
     * @param token Le token Bearer (sans le prÃ©fixe "Bearer ")
     * @return Mono<AuthenticatedUser> si le token est valide, Mono.empty() sinon
     */
    public Mono<AuthenticatedUser> verifyToken(String token) {
    return webClient.get()
            .uri("/api/auth/me")
            .header(HttpHeaders.AUTHORIZATION, "Bearer " + token)
            .retrieve()
            .onStatus(HttpStatusCode::is4xxClientError, response -> Mono.error(new InvalidTokenException("Token invalide")))
            .onStatus(HttpStatusCode::is5xxServerError, response -> Mono.error(new RuntimeException("Erreur serveur auth")))
            .bodyToMono(AuthUserResponse.class)
            .map(this::mapToAuthenticatedUser)
            // AJOUTER CE LOG POUR VOIR L'ERREUR RÃ‰ELLE
            .doOnError(e -> log.error("ERREUR AUTH SERVICE : {} - {}", e.getClass().getSimpleName(), e.getMessage())) 
            .onErrorResume(e -> Mono.empty());
   }
    /**
     * Exception interne pour les tokens invalides
     */
    private static class InvalidTokenException extends RuntimeException {
        public InvalidTokenException(String message) {
            super(message);
        }
    }

    private AuthenticatedUser mapToAuthenticatedUser(AuthUserResponse response) {
        return new AuthenticatedUser(
                response.id(),
                response.username(),
                response.email(),
                response.phone(),
                response.firstName(),
                response.lastName(),
                response.roles(),
                response.permissions()
        );
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/exception/NotFoundException.java`
```java
package com.yowyob.template.domain.exception;

public class NotFoundException extends RuntimeException {
    public NotFoundException(String message) {
        super(message);
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/exception/StockFullException.java`
```java
package com.yowyob.template.domain.exception;

public class StockFullException extends RuntimeException {
    public StockFullException(String message) {
        super(message);
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/model/Product.java`
```java
package com.yowyob.template.domain.model;

import java.math.BigDecimal;
import java.util.UUID;

public record Product(UUID id, String name, BigDecimal price, String status) {}```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/model/vehicle/VehicleModel.java`
```java
package com.yowyob.template.domain.model.vehicle;

import java.time.LocalDateTime;
import java.util.UUID;

public record VehicleModel(
        UUID vehicleModelId,
        String modelName,
        LocalDateTime createdAt,
        LocalDateTime updatedAt) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/model/vehicle/details/VehicleCanTransport.java`
```java
package com.yowyob.template.domain.model.vehicle.details;

import java.util.UUID;

public record VehicleCanTransport(
                UUID vehicleCanTransportId,
                UUID vehicleId,
                String item) {
}```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/model/vehicle/details/VehicleReview.java`
```java
package com.yowyob.template.domain.model.vehicle.details;

import java.util.UUID;

public record VehicleReview(
                UUID vehicleId,
                UUID reviewId) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/model/vehicle/details/VehicleKeyword.java`
```java
package com.yowyob.template.domain.model.vehicle.details;

import java.util.UUID;

public record VehicleKeyword(
                UUID vehicleKeywordId,
                UUID vehicleId,
                String keyword) {
}```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/model/vehicle/details/VehicleIllustrationImage.java`
```java
package com.yowyob.template.domain.model.vehicle.details;

import java.util.UUID;

public record VehicleIllustrationImage(
                UUID vehicleIllustrationImageId,
                UUID vehicleId,
                String imagePath) {
}```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/model/vehicle/details/VehicleAmenity.java`
```java
package com.yowyob.template.domain.model.vehicle.details;

import java.util.UUID;

public record VehicleAmenity(
                UUID vehicleAmenityId,
                UUID vehicleId,
                String amenityName) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/model/vehicle/FuelType.java`
```java
package com.yowyob.template.domain.model.vehicle;

import java.util.UUID;

public record FuelType(
        UUID fuelTypeId,
        String fuelTypeName) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/model/vehicle/VehicleMake.java`
```java
package com.yowyob.template.domain.model.vehicle;

import java.util.UUID;

public record VehicleMake(
        UUID vehicleMakeId,
        String makeName) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/model/vehicle/Manufacturer.java`
```java
package com.yowyob.template.domain.model.vehicle;

import java.util.UUID;

public record Manufacturer(
        UUID manufacturerId,
        String manufacturerName) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/model/vehicle/Vehicle.java`
```java
package com.yowyob.template.domain.model.vehicle;

import java.util.UUID;
import java.time.LocalDateTime;
import java.math.BigDecimal;

public record Vehicle(
        UUID vehicleId,

        UUID vehicleMakeId,
        UUID vehicleModelId,
        UUID transmissionTypeId,
        UUID manufacturerId,
        UUID vehicleSizeId,
        UUID vehicleTypeId,
        UUID fuelTypeId,

        String vehicleSerialNumber,
        String vehicleSerialPhoto,
        String registrationNumber,
        String registrationPhoto,
        LocalDateTime registrationExpiryDate,

        BigDecimal tankCapacity,
        BigDecimal luggageMaxCapacity,
        Integer totalSeatNumber,

        BigDecimal averageFuelConsumptionPerKm,
        BigDecimal mileageAtStart,
        BigDecimal mileageSinceCommissioning,
        BigDecimal vehicleAgeAtStart,

        String brand,
        LocalDateTime createdAt,
        LocalDateTime updatedAt) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/model/vehicle/VehicleSize.java`
```java
package com.yowyob.template.domain.model.vehicle;

import java.time.LocalDateTime;
import java.util.UUID;

public record VehicleSize(
        UUID vehicleSizeId,
        String sizeName,
        LocalDateTime createdAt,
        LocalDateTime updatedAt) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/model/vehicle/TransmissionType.java`
```java
package com.yowyob.template.domain.model.vehicle;

import java.time.LocalDateTime;
import java.util.UUID;

public record TransmissionType(
        UUID transmissionTypeId,
        String typeName,
        LocalDateTime createdAt,
        LocalDateTime updatedAt) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/model/vehicle/ownership/VehicleOwnership.java`
```java
package com.yowyob.template.domain.model.vehicle.ownership;

import java.time.LocalDateTime;
import java.util.UUID;

public record VehicleOwnership(
        UUID vehicleOwnershipId,
        UUID vehicleId,
        UUID partyId,
        UsageRole usageRole,
        boolean isPrimary,
        LocalDateTime validFrom,
        LocalDateTime validTo) {
}```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/model/vehicle/ownership/UsageRole.java`
```java
package com.yowyob.template.domain.model.vehicle.ownership;

public enum UsageRole {
    DRIVER,
    LOGISTICS,
    FLEET,
    OWNER
}```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/model/vehicle/VehicleType.java`
```java
package com.yowyob.template.domain.model.vehicle;

import java.util.UUID;

public record VehicleType(
        UUID vehicleTypeId,
        String typeName) {
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/model/party/PartyType.java`
```java
package com.yowyob.template.domain.model.party;

public enum PartyType {
    FREELANCE_DRIVER,
    FREELANCE_DELIVERER,
    RENTAL_AGENCY,
    TRAVEL_AGENCY,
    DELIVERY_AGENCY
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/model/party/Party.java`
```java
package com.yowyob.template.domain.model.party;

import java.util.UUID;

public record Party(
        UUID partyId,
        PartyType partyType,
        String displayName,
        String phone,
        String email) {
}```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/ports/in/ManageVehicleOwnershipUseCase.java`
```java
package com.yowyob.template.domain.ports.in;

import com.yowyob.template.domain.model.vehicle.ownership.VehicleOwnership;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import java.util.UUID;

public interface ManageVehicleOwnershipUseCase {
    Mono<VehicleOwnership> createOwnership(VehicleOwnership ownership);

    Flux<VehicleOwnership> getOwnershipsByVehicleId(UUID vehicleId);

    Flux<VehicleOwnership> getOwnershipsByPartyId(UUID partyId);

    Mono<VehicleOwnership> getOwnershipById(UUID id);

    Mono<Void> deleteOwnership(UUID id);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/ports/in/ManageVehicleUseCase.java`
```java
package com.yowyob.template.domain.ports.in;

import com.yowyob.template.domain.model.vehicle.Vehicle;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;

public interface ManageVehicleUseCase {

    Mono<Vehicle> createVehicle(Vehicle vehicle);

    Mono<Vehicle> updateVehicle(Vehicle vehicle);

    // C'est cette mÃ©thode qui manque souvent et cause le rouge
    Mono<Vehicle> patchVehicle(UUID id, Vehicle partialVehicle); 

    Flux<Vehicle> getAllVehicles();

    Flux<Vehicle> getVehiclesByOwner(UUID partyId);

    Mono<Vehicle> getVehicleById(UUID id);

    Mono<Void> deleteVehicle(UUID id);
}```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/ports/in/ManageVehicleMediaUseCase.java`
```java
package com.yowyob.template.domain.ports.in;

import com.yowyob.template.domain.model.vehicle.Vehicle;
import com.yowyob.template.domain.model.vehicle.details.VehicleIllustrationImage;
import org.springframework.http.codec.multipart.FilePart;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;

public interface ManageVehicleMediaUseCase {

    // --- Documents Uniques (1-1) ---
    Mono<Vehicle> uploadSerialPhoto(UUID vehicleId, FilePart file);
    Mono<Void> deleteSerialPhoto(UUID vehicleId);

    Mono<Vehicle> uploadRegistrationPhoto(UUID vehicleId, FilePart file);
    Mono<Void> deleteRegistrationPhoto(UUID vehicleId);

    // --- Illustrations (1-N) ---
    Mono<VehicleIllustrationImage> addIllustrationImage(UUID vehicleId, FilePart file);
    Flux<VehicleIllustrationImage> getIllustrationImages(UUID vehicleId);
    Mono<Void> deleteIllustrationImage(UUID vehicleId, UUID imageId); // vehicleId pour vÃ©rification sÃ©cu
}```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/ports/in/ManageVehicleLookupUseCase.java`
```java
package com.yowyob.template.domain.ports.in;

import com.yowyob.template.domain.model.vehicle.*;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

public interface ManageVehicleLookupUseCase {

    // FuelType
    Mono<FuelType> createFuelType(FuelType fuelType);

    Flux<FuelType> getAllFuelTypes();

    Mono<FuelType> getFuelTypeById(java.util.UUID id);

    Mono<Void> deleteFuelType(java.util.UUID id);

    // Manufacturer
    Mono<Manufacturer> createManufacturer(Manufacturer manufacturer);

    Flux<Manufacturer> getAllManufacturers();

    Mono<Manufacturer> getManufacturerById(java.util.UUID id);

    Mono<Void> deleteManufacturer(java.util.UUID id);

    // TransmissionType
    Mono<TransmissionType> createTransmissionType(TransmissionType transmissionType);

    Flux<TransmissionType> getAllTransmissionTypes();

    Mono<TransmissionType> getTransmissionTypeById(java.util.UUID id);

    Mono<Void> deleteTransmissionType(java.util.UUID id);

    // VehicleMake
    Mono<VehicleMake> createVehicleMake(VehicleMake vehicleMake);

    Flux<VehicleMake> getAllVehicleMakes();

    Mono<VehicleMake> getVehicleMakeById(java.util.UUID id);

    Mono<Void> deleteVehicleMake(java.util.UUID id);

    // VehicleModel
    Mono<VehicleModel> createVehicleModel(VehicleModel vehicleModel);

    Flux<VehicleModel> getAllVehicleModels();

    Mono<VehicleModel> getVehicleModelById(java.util.UUID id);

    Mono<Void> deleteVehicleModel(java.util.UUID id);

    // VehicleSize
    Mono<VehicleSize> createVehicleSize(VehicleSize vehicleSize);

    Flux<VehicleSize> getAllVehicleSizes();

    Mono<VehicleSize> getVehicleSizeById(java.util.UUID id);

    Mono<Void> deleteVehicleSize(java.util.UUID id);

    // VehicleType
    Mono<VehicleType> createVehicleType(VehicleType vehicleType);

    Flux<VehicleType> getAllVehicleTypes();

    Mono<VehicleType> getVehicleTypeById(java.util.UUID id);

    Mono<Void> deleteVehicleType(java.util.UUID id);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/ports/in/ManageVehicleDetailsUseCase.java`
```java
package com.yowyob.template.domain.ports.in;

import com.yowyob.template.domain.model.vehicle.details.*;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import java.util.UUID;

public interface ManageVehicleDetailsUseCase {
    // Amenity
    Mono<VehicleAmenity> createAmenity(VehicleAmenity amenity);

    Flux<VehicleAmenity> getAmenitiesByVehicleId(UUID vehicleId);

    Mono<Void> deleteAmenity(UUID id);

    // CanTransport
    Mono<VehicleCanTransport> createCanTransport(VehicleCanTransport canTransport);

    Flux<VehicleCanTransport> getCanTransportsByVehicleId(UUID vehicleId);

    Mono<Void> deleteCanTransport(UUID id);

    // IllustrationImage
    Mono<VehicleIllustrationImage> createIllustrationImage(VehicleIllustrationImage image);

    Flux<VehicleIllustrationImage> getIllustrationImagesByVehicleId(UUID vehicleId);

    Mono<Void> deleteIllustrationImage(UUID id);

    // Keyword
    Mono<VehicleKeyword> createKeyword(VehicleKeyword keyword);

    Flux<VehicleKeyword> getKeywordsByVehicleId(UUID vehicleId);

    Mono<Void> deleteKeyword(UUID id);

    // Review
    Mono<VehicleReview> createReview(VehicleReview review);

    Flux<VehicleReview> getReviewsByVehicleId(UUID vehicleId);

    Mono<Void> deleteReview(UUID id);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/ports/in/CreateProductUseCase.java`
```java
package com.yowyob.template.domain.ports.in;

import com.yowyob.template.domain.model.Product;
import reactor.core.publisher.Mono;

public interface CreateProductUseCase {
    Mono<Product> createProduct(Product product);
}```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/ports/out/MediaStoragePort.java`
```java
package com.yowyob.template.domain.ports.out;

import org.springframework.http.codec.multipart.FilePart;
import reactor.core.publisher.Mono;

public interface MediaStoragePort {
    /**
     * Upload un fichier vers le stockage externe.
     * @return L'URL publique du fichier + L'ID du mÃ©dia (encapsulÃ©s ou juste l'URL selon besoin)
     * Ici on renvoie l'objet complet rÃ©ponse pour avoir l'ID et l'URI.
     */
    Mono<com.yowyob.template.infrastructure.adapters.outbound.external.dto.MediaServiceResponse> upload(FilePart file, String location);

    /**
     * Supprime un fichier du stockage externe via son ID.
     */
    Mono<Void> delete(String mediaId);
}```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/ports/out/VehicleRepositoryPort.java`
```java
package com.yowyob.template.domain.ports.out;

import com.yowyob.template.domain.model.vehicle.Vehicle;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;

public interface VehicleRepositoryPort {

    Mono<Vehicle> saveVehicle(Vehicle vehicle);

    Flux<Vehicle> findAllVehicles();

    Flux<Vehicle> findVehiclesByPartyId(UUID partyId);

    Mono<Vehicle> findVehicleById(UUID id);

    Mono<Void> deleteVehicle(UUID id);

    // --- Validation d'unicitÃ© pour Update/Patch ---
    Mono<Boolean> existsBySerialNumberAndIdNot(String serialNumber, UUID id);
    Mono<Boolean> existsByRegistrationNumberAndIdNot(String registrationNumber, UUID id);
}```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/ports/out/ProductEventPublisherPort.java`
```java
package com.yowyob.template.domain.ports.out;

import com.yowyob.template.domain.model.Product;
import reactor.core.publisher.Mono;

public interface ProductEventPublisherPort {
    Mono<Void> publishProductCreated(Product product);
}```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/ports/out/ProductCachePort.java`
```java
package com.yowyob.template.domain.ports.out;

import com.yowyob.template.domain.model.Product;
import reactor.core.publisher.Mono;

public interface ProductCachePort {
    Mono<Boolean> saveInCache(Product product);
}```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/ports/out/VehicleOwnershipRepositoryPort.java`
```java
package com.yowyob.template.domain.ports.out;

import com.yowyob.template.domain.model.vehicle.ownership.VehicleOwnership;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import java.util.UUID;

public interface VehicleOwnershipRepositoryPort {
    Mono<VehicleOwnership> saveOwnership(VehicleOwnership ownership);

    Flux<VehicleOwnership> findOwnershipsByVehicleId(UUID vehicleId);

    Flux<VehicleOwnership> findOwnershipsByPartyId(UUID partyId);

    Mono<VehicleOwnership> findOwnershipById(UUID id);

    Mono<Void> deleteOwnership(UUID id);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/ports/out/VehicleDetailsRepositoryPort.java`
```java
package com.yowyob.template.domain.ports.out;

import com.yowyob.template.domain.model.vehicle.details.*;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import java.util.UUID;

public interface VehicleDetailsRepositoryPort {
    // Amenity
    Mono<VehicleAmenity> saveAmenity(VehicleAmenity amenity);

    Flux<VehicleAmenity> findAmenitiesByVehicleId(UUID vehicleId);

    Mono<Void> deleteAmenity(UUID id);

    // CanTransport
    Mono<VehicleCanTransport> saveCanTransport(VehicleCanTransport canTransport);

    Flux<VehicleCanTransport> findCanTransportsByVehicleId(UUID vehicleId);

    Mono<Void> deleteCanTransport(UUID id);

    // IllustrationImage
    Mono<VehicleIllustrationImage> saveIllustrationImage(VehicleIllustrationImage image);

    Flux<VehicleIllustrationImage> findIllustrationImagesByVehicleId(UUID vehicleId);

    Mono<Void> deleteIllustrationImage(UUID id);

    // Keyword
    Mono<VehicleKeyword> saveKeyword(VehicleKeyword keyword);

    Flux<VehicleKeyword> findKeywordsByVehicleId(UUID vehicleId);

    Mono<Void> deleteKeyword(UUID id);

    // Review
    Mono<VehicleReview> saveReview(VehicleReview review);

    Flux<VehicleReview> findReviewsByVehicleId(UUID vehicleId);

    Mono<Void> deleteReview(UUID id);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/ports/out/ProductRepositoryPort.java`
```java
package com.yowyob.template.domain.ports.out;

import com.yowyob.template.domain.model.Product;
import reactor.core.publisher.Mono;

public interface ProductRepositoryPort {
    Mono<Product> save(Product product);
}```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/ports/out/StockClientPort.java`
```java
package com.yowyob.template.domain.ports.out;

import reactor.core.publisher.Mono;

public interface StockClientPort {
    /**
     * Verify if te stock is full.
     * @return true full, false otherwise
     */
    Mono<Boolean> isStockFull(String productName);
}```

---
### Fichier : `./src/main/java/com/yowyob/template/domain/ports/out/VehicleLookupRepositoryPort.java`
```java
package com.yowyob.template.domain.ports.out;

import com.yowyob.template.domain.model.vehicle.*;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

public interface VehicleLookupRepositoryPort {

    // FuelType
    Mono<FuelType> saveFuelType(FuelType fuelType);

    Flux<FuelType> findAllFuelTypes();

    Mono<FuelType> findFuelTypeById(java.util.UUID id);

    Mono<Void> deleteFuelType(java.util.UUID id);

    // Manufacturer
    Mono<Manufacturer> saveManufacturer(Manufacturer manufacturer);

    Flux<Manufacturer> findAllManufacturers();

    Mono<Manufacturer> findManufacturerById(java.util.UUID id);

    Mono<Void> deleteManufacturer(java.util.UUID id);

    // TransmissionType
    Mono<TransmissionType> saveTransmissionType(TransmissionType transmissionType);

    Flux<TransmissionType> findAllTransmissionTypes();

    Mono<TransmissionType> findTransmissionTypeById(java.util.UUID id);

    Mono<Void> deleteTransmissionType(java.util.UUID id);

    // VehicleMake
    Mono<VehicleMake> saveVehicleMake(VehicleMake vehicleMake);

    Flux<VehicleMake> findAllVehicleMakes();

    Mono<VehicleMake> findVehicleMakeById(java.util.UUID id);

    Mono<Void> deleteVehicleMake(java.util.UUID id);

    // VehicleModel
    Mono<VehicleModel> saveVehicleModel(VehicleModel vehicleModel);

    Flux<VehicleModel> findAllVehicleModels();

    Mono<VehicleModel> findVehicleModelById(java.util.UUID id);

    Mono<Void> deleteVehicleModel(java.util.UUID id);

    // VehicleSize
    Mono<VehicleSize> saveVehicleSize(VehicleSize vehicleSize);

    Flux<VehicleSize> findAllVehicleSizes();

    Mono<VehicleSize> findVehicleSizeById(java.util.UUID id);

    Mono<Void> deleteVehicleSize(java.util.UUID id);

    // VehicleType
    Mono<VehicleType> saveVehicleType(VehicleType vehicleType);

    Flux<VehicleType> findAllVehicleTypes();

    Mono<VehicleType> findVehicleTypeById(java.util.UUID id);

    Mono<Void> deleteVehicleType(java.util.UUID id);
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/application/service/VehicleOwnershipService.java`
```java
package com.yowyob.template.application.service;

import com.yowyob.template.domain.model.vehicle.ownership.VehicleOwnership;
import com.yowyob.template.domain.ports.in.ManageVehicleOwnershipUseCase;
import com.yowyob.template.domain.ports.out.VehicleOwnershipRepositoryPort;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import java.util.UUID;

@Service
@RequiredArgsConstructor
public class VehicleOwnershipService implements ManageVehicleOwnershipUseCase {

    private final VehicleOwnershipRepositoryPort repositoryPort;

    @Override
    public Mono<VehicleOwnership> createOwnership(VehicleOwnership ownership) {
        return repositoryPort.saveOwnership(ownership);
    }

    @Override
    public Flux<VehicleOwnership> getOwnershipsByVehicleId(UUID vehicleId) {
        return repositoryPort.findOwnershipsByVehicleId(vehicleId);
    }

    @Override
    public Flux<VehicleOwnership> getOwnershipsByPartyId(UUID partyId) {
        return repositoryPort.findOwnershipsByPartyId(partyId);
    }

    @Override
    public Mono<VehicleOwnership> getOwnershipById(UUID id) {
        return repositoryPort.findOwnershipById(id);
    }

    @Override
    public Mono<Void> deleteOwnership(UUID id) {
        return repositoryPort.deleteOwnership(id);
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/application/service/VehicleMediaService.java`
```java
package com.yowyob.template.application.service;

import com.yowyob.template.domain.exception.NotFoundException;
import com.yowyob.template.domain.model.vehicle.Vehicle;
import com.yowyob.template.domain.model.vehicle.details.VehicleIllustrationImage;
import com.yowyob.template.domain.ports.in.ManageVehicleMediaUseCase;
import com.yowyob.template.domain.ports.out.MediaStoragePort;
import com.yowyob.template.domain.ports.out.VehicleDetailsRepositoryPort;
import com.yowyob.template.domain.ports.out.VehicleRepositoryPort;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.codec.multipart.FilePart;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;

@Slf4j
@Service
@RequiredArgsConstructor
public class VehicleMediaService implements ManageVehicleMediaUseCase {

    private final VehicleRepositoryPort vehicleRepository;
    private final VehicleDetailsRepositoryPort detailsRepository;
    private final MediaStoragePort mediaStorage;

    // --- DOCUMENT : SERIAL PHOTO ---

    @Override
    @Transactional
    public Mono<Vehicle> uploadSerialPhoto(UUID vehicleId, FilePart file) {
        return vehicleRepository.findVehicleById(vehicleId)
                .switchIfEmpty(Mono.error(new NotFoundException("VÃ©hicule non trouvÃ©")))
                .flatMap(vehicle -> {
                    // 1. Upload nouveau fichier
                    String location = "vehicles/" + vehicleId + "/documents";
                    return mediaStorage.upload(file, location)
                            .flatMap(response -> {
                                // 2. (Optionnel) Supprimer l'ancien fichier si URL existante
                                // Pour faire Ã§a proprement, il faudrait extraire l'ID de l'URL prÃ©cÃ©dente.
                                // Ici on simplifie : on Ã©crase juste la rÃ©fÃ©rence en DB.
                                
                                // 3. Mise Ã  jour DB
                                Vehicle updated = copyWithSerialPhoto(vehicle, response.uri());
                                return vehicleRepository.saveVehicle(updated);
                            });
                });
    }

    @Override
    @Transactional
    public Mono<Void> deleteSerialPhoto(UUID vehicleId) {
        return vehicleRepository.findVehicleById(vehicleId)
                .switchIfEmpty(Mono.error(new NotFoundException("VÃ©hicule non trouvÃ©")))
                .flatMap(vehicle -> {
                    // TODO: Extraire ID media de l'URL pour appeler mediaStorage.delete()
                    
                    Vehicle updated = copyWithSerialPhoto(vehicle, null);
                    return vehicleRepository.saveVehicle(updated).then();
                });
    }

    // --- DOCUMENT : REGISTRATION PHOTO ---

    @Override
    @Transactional
    public Mono<Vehicle> uploadRegistrationPhoto(UUID vehicleId, FilePart file) {
        return vehicleRepository.findVehicleById(vehicleId)
                .switchIfEmpty(Mono.error(new NotFoundException("VÃ©hicule non trouvÃ©")))
                .flatMap(vehicle -> {
                    String location = "vehicles/" + vehicleId + "/documents";
                    return mediaStorage.upload(file, location)
                            .flatMap(response -> {
                                Vehicle updated = copyWithRegistrationPhoto(vehicle, response.uri());
                                return vehicleRepository.saveVehicle(updated);
                            });
                });
    }

    @Override
    @Transactional
    public Mono<Void> deleteRegistrationPhoto(UUID vehicleId) {
        return vehicleRepository.findVehicleById(vehicleId)
                .switchIfEmpty(Mono.error(new NotFoundException("VÃ©hicule non trouvÃ©")))
                .flatMap(vehicle -> {
                    Vehicle updated = copyWithRegistrationPhoto(vehicle, null);
                    return vehicleRepository.saveVehicle(updated).then();
                });
    }

    // --- ILLUSTRATIONS ---

    @Override
    public Mono<VehicleIllustrationImage> addIllustrationImage(UUID vehicleId, FilePart file) {
        return vehicleRepository.findVehicleById(vehicleId)
                .switchIfEmpty(Mono.error(new NotFoundException("VÃ©hicule non trouvÃ©")))
                .flatMap(v -> {
                    String location = "vehicles/" + vehicleId + "/illustrations";
                    return mediaStorage.upload(file, location)
                            .flatMap(response -> {
                                VehicleIllustrationImage image = new VehicleIllustrationImage(
                                        null,
                                        vehicleId,
                                        response.uri()
                                );
                                return detailsRepository.saveIllustrationImage(image);
                            });
                });
    }

    @Override
    public Flux<VehicleIllustrationImage> getIllustrationImages(UUID vehicleId) {
        return detailsRepository.findIllustrationImagesByVehicleId(vehicleId);
    }

    @Override
    public Mono<Void> deleteIllustrationImage(UUID vehicleId, UUID imageId) {
        // On pourrait vÃ©rifier que l'image appartient bien au vÃ©hicule, 
        // mais pour l'instant la suppression par ID est suffisante.
        // IdÃ©alement : appeler mediaStorage.delete() aussi.
        return detailsRepository.deleteIllustrationImage(imageId);
    }

    // --- Helpers pour immutabilitÃ© des Records ---

    private Vehicle copyWithSerialPhoto(Vehicle v, String url) {
        return new Vehicle(
            v.vehicleId(), v.vehicleMakeId(), v.vehicleModelId(), v.transmissionTypeId(), 
            v.manufacturerId(), v.vehicleSizeId(), v.vehicleTypeId(), v.fuelTypeId(), 
            v.vehicleSerialNumber(), 
            url, // <--- Change ici
            v.registrationNumber(), v.registrationPhoto(), v.registrationExpiryDate(), 
            v.tankCapacity(), v.luggageMaxCapacity(), v.totalSeatNumber(), 
            v.averageFuelConsumptionPerKm(), v.mileageAtStart(), v.mileageSinceCommissioning(), 
            v.vehicleAgeAtStart(), v.brand(), v.createdAt(), null
        );
    }

    private Vehicle copyWithRegistrationPhoto(Vehicle v, String url) {
        return new Vehicle(
            v.vehicleId(), v.vehicleMakeId(), v.vehicleModelId(), v.transmissionTypeId(), 
            v.manufacturerId(), v.vehicleSizeId(), v.vehicleTypeId(), v.fuelTypeId(), 
            v.vehicleSerialNumber(), v.vehicleSerialPhoto(), v.registrationNumber(), 
            url, // <--- Change ici
            v.registrationExpiryDate(), 
            v.tankCapacity(), v.luggageMaxCapacity(), v.totalSeatNumber(), 
            v.averageFuelConsumptionPerKm(), v.mileageAtStart(), v.mileageSinceCommissioning(), 
            v.vehicleAgeAtStart(), v.brand(), v.createdAt(), null
        );
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/template/application/service/VehicleSmartCreationService.java`
```java
package com.yowyob.template.application.service;

import com.yowyob.template.domain.model.vehicle.Vehicle;
import com.yowyob.template.domain.model.vehicle.ownership.UsageRole;
import com.yowyob.template.domain.model.vehicle.ownership.VehicleOwnership;
import com.yowyob.template.domain.ports.in.ManageVehicleUseCase;
import com.yowyob.template.domain.ports.out.VehicleOwnershipRepositoryPort;
import com.yowyob.template.infrastructure.adapters.inbound.rest.dto.SimplifiedVehicleRequest;
import com.yowyob.template.infrastructure.adapters.outbound.persistence.entity.*;
import com.yowyob.template.infrastructure.adapters.outbound.persistence.repository.*;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import reactor.core.publisher.Mono;

import java.time.LocalDateTime;
import java.util.UUID;

@Slf4j
@Service
@RequiredArgsConstructor
public class VehicleSmartCreationService {

    private final ManageVehicleUseCase manageVehicleUseCase;
    private final VehicleOwnershipRepositoryPort ownershipRepository;

    private final VehicleMakeR2dbcRepository makeRepo;
    private final VehicleModelR2dbcRepository modelRepo;
    private final TransmissionTypeR2dbcRepository transmissionRepo;
    private final ManufacturerR2dbcRepository manufacturerRepo;
    private final VehicleSizeR2dbcRepository sizeRepo;
    private final VehicleTypeR2dbcRepository typeRepo;
    private final FuelTypeR2dbcRepository fuelRepo;

    @Transactional
    public Mono<Vehicle> createVehicleFromNames(SimplifiedVehicleRequest request, UUID partyId) {
        log.info("Smart Creation: DÃ©but pour user {}", partyId);

        // 1. Get or Create avec gÃ©nÃ©ration d'UUID explicite en Java
        // Cela garantit que l'objet retournÃ© A TOUJOURS un ID, mÃªme si la DB ne le renvoie pas
        
        Mono<VehicleMakeEntity> makeMono = makeRepo.findByMakeName(request.makeName())
                .switchIfEmpty(Mono.defer(() -> {
                    UUID id = UUID.randomUUID();
                    return makeRepo.save(VehicleMakeEntity.builder().vehicleMakeId(id).makeName(request.makeName()).build());
                }));

        Mono<VehicleModelEntity> modelMono = modelRepo.findByModelName(request.modelName())
                .switchIfEmpty(Mono.defer(() -> {
                    UUID id = UUID.randomUUID();
                    return modelRepo.save(VehicleModelEntity.builder().vehicleModelId(id).modelName(request.modelName()).build());
                }));

        Mono<TransmissionTypeEntity> transmissionMono = transmissionRepo.findByTypeName(request.transmissionType())
                .switchIfEmpty(Mono.defer(() -> {
                    UUID id = UUID.randomUUID();
                    return transmissionRepo.save(TransmissionTypeEntity.builder().transmissionTypeId(id).typeName(request.transmissionType()).build());
                }));

        Mono<ManufacturerEntity> manufacturerMono = manufacturerRepo.findByManufacturerName(request.manufacturerName())
                .switchIfEmpty(Mono.defer(() -> {
                    UUID id = UUID.randomUUID();
                    return manufacturerRepo.save(ManufacturerEntity.builder().manufacturerId(id).manufacturerName(request.manufacturerName()).build());
                }));

        Mono<VehicleSizeEntity> sizeMono = sizeRepo.findBySizeName(request.sizeName())
                .switchIfEmpty(Mono.defer(() -> {
                    UUID id = UUID.randomUUID();
                    return sizeRepo.save(VehicleSizeEntity.builder().vehicleSizeId(id).sizeName(request.sizeName()).build());
                }));

        Mono<VehicleTypeEntity> typeMono = typeRepo.findByTypeName(request.typeName())
                .switchIfEmpty(Mono.defer(() -> {
                    UUID id = UUID.randomUUID();
                    return typeRepo.save(VehicleTypeEntity.builder().vehicleTypeId(id).typeName(request.typeName()).build());
                }));

        Mono<FuelTypeEntity> fuelMono = fuelRepo.findByFuelTypeName(request.fuelTypeName())
                .switchIfEmpty(Mono.defer(() -> {
                    UUID id = UUID.randomUUID();
                    return fuelRepo.save(FuelTypeEntity.builder().fuelTypeId(id).fuelTypeName(request.fuelTypeName()).build());
                }));

        // 2. ExÃ©cution parallÃ¨le
        return Mono.zip(makeMono, modelMono, transmissionMono, manufacturerMono, sizeMono, typeMono, fuelMono)
            .flatMap(tuple -> {
                // VÃ©rification de sÃ©curitÃ© pour les logs
                log.info("IDs rÃ©solus - Make: {}, Model: {}", tuple.getT1().getVehicleMakeId(), tuple.getT2().getVehicleModelId());

                Vehicle vehicle = new Vehicle(
                    null, 
                    tuple.getT1().getVehicleMakeId(),
                    tuple.getT2().getVehicleModelId(),
                    tuple.getT3().getTransmissionTypeId(),
                    tuple.getT4().getManufacturerId(),
                    tuple.getT5().getVehicleSizeId(),
                    tuple.getT6().getVehicleTypeId(),
                    tuple.getT7().getFuelTypeId(),
                    request.vehicleSerialNumber(),
                    request.vehicleSerialPhoto(),
                    request.registrationNumber(),
                    request.registrationPhoto(),
                    request.registrationExpiryDate(),
                    request.tankCapacity(),
                    request.luggageMaxCapacity(),
                    request.totalSeatNumber(),
                    request.averageFuelConsumptionPerKm(),
                    request.mileageAtStart(),
                    request.mileageSinceCommissioning(),
                    request.vehicleAgeAtStart(),
                    request.brand(),
                    null, null
                );

                // 3. Gestion de l'Ownership et Sauvegarde
                return ownershipRepository.findOwnershipsByPartyId(partyId)
                        .hasElements()
                        .flatMap(hasExisting -> {
                            boolean isPrimary = !hasExisting;
                            
                            return manageVehicleUseCase.createVehicle(vehicle)
                                    .flatMap(savedVehicle -> {
                                        log.info("VÃ©hicule crÃ©Ã© avec ID: {}", savedVehicle.vehicleId());
                                        
                                        VehicleOwnership ownership = new VehicleOwnership(
                                                null,
                                                savedVehicle.vehicleId(),
                                                partyId,
                                                UsageRole.OWNER,
                                                isPrimary,
                                                LocalDateTime.now(),
                                                null
                                        );
                                        
                                        return ownershipRepository.saveOwnership(ownership)
                                                .doOnSuccess(o -> log.info("Ownership crÃ©Ã© pour user {} et vehicle {}", partyId, savedVehicle.vehicleId()))
                                                .thenReturn(savedVehicle);
                                    });
                        });
            });
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/template/application/service/ProductService.java`
```java
package com.yowyob.template.application.service;

import com.yowyob.template.domain.exception.StockFullException;
import com.yowyob.template.domain.model.Product;
import com.yowyob.template.domain.ports.in.CreateProductUseCase;
import com.yowyob.template.domain.ports.out.ProductCachePort;
import com.yowyob.template.domain.ports.out.ProductEventPublisherPort;
import com.yowyob.template.domain.ports.out.ProductRepositoryPort;
import com.yowyob.template.domain.ports.out.StockClientPort;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Mono;

// import java.util.UUID;

@Slf4j
@Service
@RequiredArgsConstructor
public class ProductService implements CreateProductUseCase {

    private final ProductRepositoryPort repository;
    private final StockClientPort stockClient;
    private final ProductCachePort cache;
    private final ProductEventPublisherPort publisher;

    @Override
    public Mono<Product> createProduct(Product product) {
        return stockClient.isStockFull(product.name())
                .flatMap(isFull -> {
                    if (isFull) {
                        return Mono.error(new StockFullException("Stock is full for the product : " + product.name()));
                    }
                    return Mono.just(product);
                })
                .map(p -> new Product(null, p.name(), p.price(), "CREATED"))
                .flatMap(repository::save)
                .flatMap(savedProduct -> 
                    // We cache and publish asynchronously, then return the object
                    Mono.when(
                        cache.saveInCache(savedProduct),
                        publisher.publishProductCreated(savedProduct)
                    ).thenReturn(savedProduct)
                )
                .doOnSuccess(p -> log.info("Product successfully created : {}", p.id()));
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/template/application/service/VehicleService.java`
```java
package com.yowyob.template.application.service;

import com.yowyob.template.domain.exception.NotFoundException;
import com.yowyob.template.domain.model.vehicle.Vehicle;
import com.yowyob.template.domain.ports.in.ManageVehicleUseCase;
import com.yowyob.template.domain.ports.out.VehicleRepositoryPort;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.dao.DuplicateKeyException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;

@Slf4j
@Service
@RequiredArgsConstructor
public class VehicleService implements ManageVehicleUseCase {

    public final VehicleRepositoryPort repositoryPort;

    @Override
    public Mono<Vehicle> createVehicle(Vehicle vehicle) {
        log.info("CrÃ©ation du vÃ©hicule : {}", vehicle.registrationNumber());
        return repositoryPort.saveVehicle(vehicle);
    }

    @Override
    @Transactional
    public Mono<Vehicle> updateVehicle(Vehicle vehicle) {
        UUID id = vehicle.vehicleId();
        return repositoryPort.findVehicleById(id)
                .switchIfEmpty(Mono.error(new NotFoundException("VÃ©hicule non trouvÃ© avec l'ID : " + id)))
                .flatMap(existing -> validateUniqueness(vehicle.vehicleSerialNumber(), vehicle.registrationNumber(), id))
                .then(Mono.defer(() -> {
                    log.info("Mise Ã  jour complÃ¨te (PUT) du vÃ©hicule : {}", id);
                    return repositoryPort.saveVehicle(vehicle);
                }));
    }

    @Override
    @Transactional
    public Mono<Vehicle> patchVehicle(UUID id, Vehicle partial) {
        return repositoryPort.findVehicleById(id)
                .switchIfEmpty(Mono.error(new NotFoundException("VÃ©hicule non trouvÃ© avec l'ID : " + id)))
                .flatMap(existing -> {
                    // Fusion manuelle
                    Vehicle merged = mergeVehicle(existing, partial);
                    
                    // Validation sur l'objet fusionnÃ©
                    return validateUniqueness(merged.vehicleSerialNumber(), merged.registrationNumber(), id)
                           .thenReturn(merged);
                })
                .flatMap(merged -> {
                    log.info("Mise Ã  jour partielle (PATCH) du vÃ©hicule : {}", id);
                    return repositoryPort.saveVehicle(merged);
                });
    }

    // MÃ©thode helper pour vÃ©rifier l'unicitÃ© avant update
    private Mono<Void> validateUniqueness(String serialNumber, String registrationNumber, UUID id) {
        return Mono.zip(
            repositoryPort.existsBySerialNumberAndIdNot(serialNumber, id),
            repositoryPort.existsByRegistrationNumberAndIdNot(registrationNumber, id)
        ).flatMap(tuple -> {
            boolean serialExists = tuple.getT1();
            boolean regExists = tuple.getT2();
            
            if (serialExists) {
                return Mono.error(new DuplicateKeyException("vehicle_serial_number exists"));
            }
            if (regExists) {
                return Mono.error(new DuplicateKeyException("registration_number exists"));
            }
            return Mono.empty();
        });
    }

    private Vehicle mergeVehicle(Vehicle existing, Vehicle partial) {
        return new Vehicle(
                existing.vehicleId(),
                partial.vehicleMakeId() != null ? partial.vehicleMakeId() : existing.vehicleMakeId(),
                partial.vehicleModelId() != null ? partial.vehicleModelId() : existing.vehicleModelId(),
                partial.transmissionTypeId() != null ? partial.transmissionTypeId() : existing.transmissionTypeId(),
                partial.manufacturerId() != null ? partial.manufacturerId() : existing.manufacturerId(),
                partial.vehicleSizeId() != null ? partial.vehicleSizeId() : existing.vehicleSizeId(),
                partial.vehicleTypeId() != null ? partial.vehicleTypeId() : existing.vehicleTypeId(),
                partial.fuelTypeId() != null ? partial.fuelTypeId() : existing.fuelTypeId(),
                
                partial.vehicleSerialNumber() != null ? partial.vehicleSerialNumber() : existing.vehicleSerialNumber(),
                partial.vehicleSerialPhoto() != null ? partial.vehicleSerialPhoto() : existing.vehicleSerialPhoto(),
                partial.registrationNumber() != null ? partial.registrationNumber() : existing.registrationNumber(),
                partial.registrationPhoto() != null ? partial.registrationPhoto() : existing.registrationPhoto(),
                partial.registrationExpiryDate() != null ? partial.registrationExpiryDate() : existing.registrationExpiryDate(),
                
                partial.tankCapacity() != null ? partial.tankCapacity() : existing.tankCapacity(),
                partial.luggageMaxCapacity() != null ? partial.luggageMaxCapacity() : existing.luggageMaxCapacity(),
                partial.totalSeatNumber() != null ? partial.totalSeatNumber() : existing.totalSeatNumber(),
                partial.averageFuelConsumptionPerKm() != null ? partial.averageFuelConsumptionPerKm() : existing.averageFuelConsumptionPerKm(),
                partial.mileageAtStart() != null ? partial.mileageAtStart() : existing.mileageAtStart(),
                partial.mileageSinceCommissioning() != null ? partial.mileageSinceCommissioning() : existing.mileageSinceCommissioning(),
                partial.vehicleAgeAtStart() != null ? partial.vehicleAgeAtStart() : existing.vehicleAgeAtStart(),
                
                partial.brand() != null ? partial.brand() : existing.brand(),
                existing.createdAt(),
                null 
        );
    }

    @Override
    public Flux<Vehicle> getAllVehicles() {
        return repositoryPort.findAllVehicles();
    }

    @Override
    public Flux<Vehicle> getVehiclesByOwner(UUID partyId) {
        return repositoryPort.findVehiclesByPartyId(partyId);
    }

    @Override
    public Mono<Vehicle> getVehicleById(UUID id) {
        return repositoryPort.findVehicleById(id)
                .switchIfEmpty(Mono.error(new NotFoundException("VÃ©hicule non trouvÃ© avec l'ID : " + id)));
    }

    @Override
    public Mono<Void> deleteVehicle(UUID id) {
        return repositoryPort.findVehicleById(id)
                .switchIfEmpty(Mono.error(new NotFoundException("Impossible de supprimer. VÃ©hicule non trouvÃ© avec l'ID : " + id)))
                .flatMap(v -> {
                    log.info("Suppression du vÃ©hicule : {}", id);
                    return repositoryPort.deleteVehicle(id);
                });
    }
}```

---
### Fichier : `./src/main/java/com/yowyob/template/application/service/VehicleLookupService.java`
```java
package com.yowyob.template.application.service;

import com.yowyob.template.domain.model.vehicle.*;
import com.yowyob.template.domain.ports.in.ManageVehicleLookupUseCase;
import com.yowyob.template.domain.ports.out.VehicleLookupRepositoryPort;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.UUID;

@Service
@RequiredArgsConstructor
public class VehicleLookupService implements ManageVehicleLookupUseCase {

    private final VehicleLookupRepositoryPort repositoryPort;

    // FuelType
    @Override
    public Mono<FuelType> createFuelType(FuelType fuelType) {
        return repositoryPort.saveFuelType(fuelType);
    }

    @Override
    public Flux<FuelType> getAllFuelTypes() {
        return repositoryPort.findAllFuelTypes();
    }

    @Override
    public Mono<FuelType> getFuelTypeById(UUID id) {
        return repositoryPort.findFuelTypeById(id);
    }

    @Override
    public Mono<Void> deleteFuelType(UUID id) {
        return repositoryPort.deleteFuelType(id);
    }

    // Manufacturer
    @Override
    public Mono<Manufacturer> createManufacturer(Manufacturer manufacturer) {
        return repositoryPort.saveManufacturer(manufacturer);
    }

    @Override
    public Flux<Manufacturer> getAllManufacturers() {
        return repositoryPort.findAllManufacturers();
    }

    @Override
    public Mono<Manufacturer> getManufacturerById(UUID id) {
        return repositoryPort.findManufacturerById(id);
    }

    @Override
    public Mono<Void> deleteManufacturer(UUID id) {
        return repositoryPort.deleteManufacturer(id);
    }

    // TransmissionType
    @Override
    public Mono<TransmissionType> createTransmissionType(TransmissionType transmissionType) {
        return repositoryPort.saveTransmissionType(transmissionType);
    }

    @Override
    public Flux<TransmissionType> getAllTransmissionTypes() {
        return repositoryPort.findAllTransmissionTypes();
    }

    @Override
    public Mono<TransmissionType> getTransmissionTypeById(UUID id) {
        return repositoryPort.findTransmissionTypeById(id);
    }

    @Override
    public Mono<Void> deleteTransmissionType(UUID id) {
        return repositoryPort.deleteTransmissionType(id);
    }

    // VehicleMake
    @Override
    public Mono<VehicleMake> createVehicleMake(VehicleMake vehicleMake) {
        return repositoryPort.saveVehicleMake(vehicleMake);
    }

    @Override
    public Flux<VehicleMake> getAllVehicleMakes() {
        return repositoryPort.findAllVehicleMakes();
    }

    @Override
    public Mono<VehicleMake> getVehicleMakeById(UUID id) {
        return repositoryPort.findVehicleMakeById(id);
    }

    @Override
    public Mono<Void> deleteVehicleMake(UUID id) {
        return repositoryPort.deleteVehicleMake(id);
    }

    // VehicleModel
    @Override
    public Mono<VehicleModel> createVehicleModel(VehicleModel vehicleModel) {
        return repositoryPort.saveVehicleModel(vehicleModel);
    }

    @Override
    public Flux<VehicleModel> getAllVehicleModels() {
        return repositoryPort.findAllVehicleModels();
    }

    @Override
    public Mono<VehicleModel> getVehicleModelById(UUID id) {
        return repositoryPort.findVehicleModelById(id);
    }

    @Override
    public Mono<Void> deleteVehicleModel(UUID id) {
        return repositoryPort.deleteVehicleModel(id);
    }

    // VehicleSize
    @Override
    public Mono<VehicleSize> createVehicleSize(VehicleSize vehicleSize) {
        return repositoryPort.saveVehicleSize(vehicleSize);
    }

    @Override
    public Flux<VehicleSize> getAllVehicleSizes() {
        return repositoryPort.findAllVehicleSizes();
    }

    @Override
    public Mono<VehicleSize> getVehicleSizeById(UUID id) {
        return repositoryPort.findVehicleSizeById(id);
    }

    @Override
    public Mono<Void> deleteVehicleSize(UUID id) {
        return repositoryPort.deleteVehicleSize(id);
    }

    // VehicleType
    @Override
    public Mono<VehicleType> createVehicleType(VehicleType vehicleType) {
        return repositoryPort.saveVehicleType(vehicleType);
    }

    @Override
    public Flux<VehicleType> getAllVehicleTypes() {
        return repositoryPort.findAllVehicleTypes();
    }

    @Override
    public Mono<VehicleType> getVehicleTypeById(UUID id) {
        return repositoryPort.findVehicleTypeById(id);
    }

    @Override
    public Mono<Void> deleteVehicleType(UUID id) {
        return repositoryPort.deleteVehicleType(id);
    }
}
```

---
### Fichier : `./src/main/java/com/yowyob/template/application/service/VehicleDetailsService.java`
```java
package com.yowyob.template.application.service;

import com.yowyob.template.domain.model.vehicle.details.*;
import com.yowyob.template.domain.ports.in.ManageVehicleDetailsUseCase;
import com.yowyob.template.domain.ports.out.VehicleDetailsRepositoryPort;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import java.util.UUID;

@Service
@RequiredArgsConstructor
public class VehicleDetailsService implements ManageVehicleDetailsUseCase {

    private final VehicleDetailsRepositoryPort repositoryPort;

    // Amenity
    @Override
    public Mono<VehicleAmenity> createAmenity(VehicleAmenity amenity) {
        return repositoryPort.saveAmenity(amenity);
    }

    @Override
    public Flux<VehicleAmenity> getAmenitiesByVehicleId(UUID vehicleId) {
        return repositoryPort.findAmenitiesByVehicleId(vehicleId);
    }

    @Override
    public Mono<Void> deleteAmenity(UUID id) {
        return repositoryPort.deleteAmenity(id);
    }

    // CanTransport
    @Override
    public Mono<VehicleCanTransport> createCanTransport(VehicleCanTransport canTransport) {
        return repositoryPort.saveCanTransport(canTransport);
    }

    @Override
    public Flux<VehicleCanTransport> getCanTransportsByVehicleId(UUID vehicleId) {
        return repositoryPort.findCanTransportsByVehicleId(vehicleId);
    }

    @Override
    public Mono<Void> deleteCanTransport(UUID id) {
        return repositoryPort.deleteCanTransport(id);
    }

    // IllustrationImage
    @Override
    public Mono<VehicleIllustrationImage> createIllustrationImage(VehicleIllustrationImage image) {
        return repositoryPort.saveIllustrationImage(image);
    }

    @Override
    public Flux<VehicleIllustrationImage> getIllustrationImagesByVehicleId(UUID vehicleId) {
        return repositoryPort.findIllustrationImagesByVehicleId(vehicleId);
    }

    @Override
    public Mono<Void> deleteIllustrationImage(UUID id) {
        return repositoryPort.deleteIllustrationImage(id);
    }

    // Keyword
    @Override
    public Mono<VehicleKeyword> createKeyword(VehicleKeyword keyword) {
        return repositoryPort.saveKeyword(keyword);
    }

    @Override
    public Flux<VehicleKeyword> getKeywordsByVehicleId(UUID vehicleId) {
        return repositoryPort.findKeywordsByVehicleId(vehicleId);
    }

    @Override
    public Mono<Void> deleteKeyword(UUID id) {
        return repositoryPort.deleteKeyword(id);
    }

    // Review
    @Override
    public Mono<VehicleReview> createReview(VehicleReview review) {
        return repositoryPort.saveReview(review);
    }

    @Override
    public Flux<VehicleReview> getReviewsByVehicleId(UUID vehicleId) {
        return repositoryPort.findReviewsByVehicleId(vehicleId);
    }

    @Override
    public Mono<Void> deleteReview(UUID id) {
        return repositoryPort.deleteReview(id);
    }
}
```

---
### Fichier : `./.mvn/wrapper/maven-wrapper.properties`
```properties
wrapperVersion=3.3.4
distributionType=only-script
distributionUrl=https://repo.maven.apache.org/maven2/org/apache/maven/apache-maven/3.9.11/apache-maven-3.9.11-bin.zip
```

---
### Fichier : `./Readme.md`
```md
# Template Hexagonal Reactive - com.yowyob

Ce projet est le **socle standard** pour le dÃ©veloppement de microservices backend chez **com.yowyob**. Il fournit une structure clÃ© en main respectant les principes de l'**Architecture Hexagonale** sur une stack technologique entiÃ¨rement **RÃ©active** (Non-bloquante).

## ðŸ“˜ Ã€ propos de ce Template

### Objectif
L'objectif de ce repository n'est pas d'Ãªtre un simple "Hello World", mais de fournir un **exemple complet et rÃ©aliste** d'un microservice de production. Il a Ã©tÃ© rÃ©alisÃ© pour standardiser nos dÃ©veloppements, assurer la cohÃ©rence du code entre les Ã©quipes et faciliter la maintenance.

### ScÃ©nario d'implÃ©mentation (Comment il a Ã©tÃ© rÃ©alisÃ©)
Pour dÃ©montrer les capacitÃ©s du template, nous avons implÃ©mentÃ© un cas d'usage fonctionnel complet : **"La crÃ©ation d'un produit"**.

Ce scÃ©nario a Ã©tÃ© choisi car il traverse toutes les couches techniques nÃ©cessaires dans un vrai systÃ¨me distribuÃ© :

1.  **EntrÃ©e API** : RÃ©ception d'une requÃªte POST (Layer REST).
2.  **Validation MÃ©tier** : Appel Ã  un service externe (Stock Service) pour vÃ©rifier la capacitÃ© via HTTP.
3.  **Persistance** : Sauvegarde des donnÃ©es dans PostgreSQL (R2DBC).
4.  **Performance** : Mise en cache du rÃ©sultat dans Redis.
5.  **Communication Asynchrone** : Publication d'un Ã©vÃ©nement "ProductCreated" dans Kafka.
6.  **RÃ©silience** : Gestion des pannes du service externe via un Circuit Breaker.

Ce flux permet aux dÃ©veloppeurs de voir concrÃ¨tement comment enchaÃ®ner ces opÃ©rations de maniÃ¨re rÃ©active (Reactor/Mono/Flux) tout en gardant le cÅ“ur du mÃ©tier pur.

---

## ðŸ“‹ PrÃ©requis

- **Java 21**
- **Maven 3.8+**
- **Docker** (Optionel)

## ðŸ— Architecture du Projet

L'architecture est divisÃ©e en trois couches distinctes pour isoler la logique mÃ©tier des technologies.

### 1. Domain (`src/main/java/com/yowyob/template/domain`)
C'est le cÅ“ur du mÃ©tier. **Aucune dÃ©pendance Spring** ne doit se trouver ici (sauf exception rare).
- **`model/`** : Les objets mÃ©tiers (Records Java).
- **`ports/in/`** : Les interfaces (Use Cases) dÃ©finissant ce que l'application *peut faire* (ex: `CreateProductUseCase`).
- **`ports/out/`** : Les interfaces dÃ©finissant ce dont l'application *a besoin* (ex: Repository, Client API, Bus d'Ã©vÃ©nements).
- **`exception/`** : Exceptions mÃ©tier.

### 2. Application (`src/main/java/com/yowyob/template/application`)
L'orchestrateur.
- ImplÃ©mente les interfaces `ports/in`.
- Utilise les interfaces `ports/out`.
- Contient la logique des flux (Flows reactor).

### 3. Infrastructure (`src/main/java/com/yowyob/template/infrastructure`)
Tout ce qui est technique. C'est ici qu'on implÃ©mente Spring, les bases de donnÃ©es, etc.
- **`adapters/inbound/`** : Ce qui *entre* dans l'app (Controlleurs REST, Listeners Kafka).
- **`adapters/outbound/`** : Ce qui *sort* ou stocke (ImplÃ©mentation R2DBC, Client WebClient, Redis, Kafka Producer).
- **`config/`** : Configuration Spring (Beans, Security, Serializers).
- **`mappers/`** : Conversion entre les DTOs, les EntitÃ©s et le Domaine (MapStruct).


## âš™ï¸ Configuration et URLs Externes

La configuration est centralisÃ©e dans `src/main/resources/application.yml`.

### Comment dÃ©finir l'URL d'un Microservice externe ?

Pour appeler un autre service (ex: Stock Service), nous utilisons `WebClient` configurÃ© via une interface dÃ©clarative (Http Interface Client).

1. **DÃ©finir l'URL dans le YAML** :
   Dans `application.yml` (ou `prod.application.yml`), localisez la section `application.external` :
   ```yaml
   application:
     external:
       stock-service-url: http://168.119.122.86:8081
   ```

2. **Injection dans le Client** :
   Dans `WebClientConfig.java`, cette valeur est injectÃ©e via `@Value("${application.external.stock-service-url}")` et passÃ©e au builder du client HTTP.

3. **Utilisation** :
   L'adaptateur (`StockAdapter`) utilise l'interface `StockApiClient` sans se soucier de l'URL.

### Configuration Infrastructure (DB, Redis, Kafka)

Les accÃ¨s aux services de donnÃ©es sont dÃ©finis dans les fichiers YAML.
- **Profil par dÃ©faut (`application.yml`)** : ConfigurÃ© pour le dÃ©veloppement (Redis standalone).
- **Profil Prod (`prod.application.yml`)** : ConfigurÃ© pour la production (Redis Cluster, IPs statiques).

---

## ðŸš€ Comment Lancer l'Application

### 1. En local (DÃ©veloppement)

Assurez-vous que vos services (Postgres, Kafka, Redis) sont accessibles aux adresses dÃ©finies dans `application.yml`.

```bash
mvn clean install
mvn spring-boot:run
```

### 2. Via Docker

Pour construire l'image et lancer un conteneur :

```bash
# Construire l'image
docker build -t reactive-hexagonal .

# Lancer (en pointant vers le profil prod par exemple)
docker run -p 8080:8080 -e SPRING_PROFILES_ACTIVE=prod reactive-hexagonal
```

---

## ðŸ›  Guide du DÃ©veloppeur : Comment ajouter une fonctionnalitÃ© ?

Si vous devez ajouter une fonctionnalitÃ© (ex: "Supprimer un produit"), suivez cet ordre strict :

1.  **Domain (Port In)** : CrÃ©ez l'interface `DeleteProductUseCase` dans `domain/ports/in`.
2.  **Domain (Port Out)** : Si besoin d'accÃ¨s DB, crÃ©ez/maj `ProductRepositoryPort` dans `domain/ports/out`.
3.  **Application** : ImplÃ©mentez le UseCase dans `ProductService` (ou un nouveau service `DeleteProductService`).
4.  **Infrastructure (Out)** : ImplÃ©mentez la mÃ©thode de suppression dans `PostgresR2dbcAdapter`.
5.  **Infrastructure (In)** : Ajoutez l'endpoint `DELETE` dans `ProductController`.

### RÃ©silience (Circuit Breaker)

Les appels externes sont protÃ©gÃ©s par Resilience4j.
Pour modifier les seuils (ex: passer Ã  10s d'attente), modifiez la section `resilience4j` dans le fichier YAML.

```yaml
resilience4j:
  circuitbreaker:
    instances:
      stock-service:
        failureRateThreshold: 50 # Ouvre le circuit si 50% d'Ã©checs
```

---

## âœ… VÃ©rifications avant commit

- [ ] Les DTOs (Infrastructure) sont sÃ©parÃ©s des Objets du Domaine (Domain).
- [ ] Aucune annotation Spring (`@Service`, `@Component`) dans le package `domain`.
- [ ] Les tests unitaires couvrent la couche Application.

## ðŸ“š Documentation de l'API (Swagger UI)

Le projet intÃ¨gre **OpenAPI 3** (via Springdoc) pour documenter et tester les endpoints automatiquement.

Une fois l'application lancÃ©e, la documentation est accessible ici :

- **Interface Visuelle (Swagger UI)** : [http://localhost:8080/swagger-ui.html](http://localhost:8080/swagger-ui.html)
- **DÃ©finition JSON (OpenAPI)** : [http://localhost:8080/v3/api-docs](http://localhost:8080/v3/api-docs)```

---
### Fichier : `./pom.xml`
```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" 
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    
    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>3.2.6</version>
        <relativePath/>
    </parent>
    
    <groupId>com.yowyob</groupId>
    <artifactId>reactive-hexagonal</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>reactive-hexagonal</name>
    <description>Template Hexagonal Reactive pour com.yowyob</description>
    
    <properties>
        <java.version>21</java.version>
        <spring-cloud.version>2023.0.0</spring-cloud.version>
        <mapstruct.version>1.5.5.Final</mapstruct.version>
    </properties>
    
    <dependencies>
        <!-- REACTIVE CORE -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>
        <dependency>
	        <groupId>org.springframework.boot</groupId>
             <artifactId>spring-boot-starter-actuator</artifactId>
	    </dependency>
	    <dependency>
	        <groupId>io.micrometer</groupId>
	        <artifactId>micrometer-registry-prometheus</artifactId>
	    </dependency>

        <!-- DATA (R2DBC & REDIS) -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-r2dbc</artifactId>
        </dependency>
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>r2dbc-postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.postgresql</groupId>
            <artifactId>postgresql</artifactId>
            <scope>runtime</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis-reactive</artifactId>
        </dependency>

        <!-- MESSAGING (KAFKA) -->
        <dependency>
            <groupId>org.springframework.kafka</groupId>
            <artifactId>spring-kafka</artifactId>
        </dependency>
        <dependency>
            <groupId>io.projectreactor.kafka</groupId>
            <artifactId>reactor-kafka</artifactId>
            <version>1.3.22</version>
        </dependency>

        <!-- CLOUD & RESILIENCE -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-circuitbreaker-reactor-resilience4j</artifactId>
        </dependency>

        <!-- TOOLS (Lombok & Mapstruct) -->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.mapstruct</groupId>
            <artifactId>mapstruct</artifactId>
            <version>${mapstruct.version}</version>
        </dependency>
        
        <!-- Docker Compose Auto-setup -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-docker-compose</artifactId>
            <scope>runtime</scope>
            <optional>true</optional>
        </dependency>
        
        <!-- Test -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>io.projectreactor</groupId>
            <artifactId>reactor-test</artifactId>
            <scope>test</scope>
        </dependency>

        <!-- Documentation API (Swagger/OpenAPI) -->
        <dependency>
            <groupId>org.springdoc</groupId>
            <artifactId>springdoc-openapi-starter-webflux-ui</artifactId>
            <version>2.5.0</version>
        </dependency>

        <!-- SECURITY -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-security</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.security</groupId>
            <artifactId>spring-security-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring-cloud.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
                <configuration>
                    <excludes>
                        <exclude>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                        </exclude>
                    </excludes>
                </configuration>
            </plugin>
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>3.11.0</version>
                <configuration>
                    <source>${java.version}</source>
                    <target>${java.version}</target>
                    <annotationProcessorPaths>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok</artifactId>
                            <version>1.18.30</version>
                        </path>
                        <path>
                            <groupId>org.mapstruct</groupId>
                            <artifactId>mapstruct-processor</artifactId>
                            <version>${mapstruct.version}</version>
                        </path>
                        <path>
                            <groupId>org.projectlombok</groupId>
                            <artifactId>lombok-mapstruct-binding</artifactId>
                            <version>0.2.0</version>
                        </path>
                    </annotationProcessorPaths>
                </configuration>
            </plugin>
        </plugins>
    </build>
</project>```

---
### Fichier : `./.github/workflows/ci-cd.yml`
```yaml
name: Spring Boot CI/CD

on:
  push:
    branches:
      - "**"
      #- main

env:
  REGISTRY_IMAGE: ghcr.io/${{ github.repository_owner }}/vehicule-service
  APP_NAME: vehicule-service
  HEALTH_DELAY: ${{ secrets.DEPLOY_DELAY }}
  CONTAINER_NAME: vehicule-service

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: 21

      - name: Run Unit Tests + SonarQube Analysis
        continue-on-error: true
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn clean verify sonar:sonar \
            -Dsonar.projectKey=${{ env.APP_NAME }} \
            -Dsonar.projectName=${{ env.APP_NAME }} \
            -Dsonar.host.url=${{ secrets.SONAR_HOST_URL }}

  build:
    needs: tests
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to GitHub Container Registry
        run: |
          echo "${{ secrets.PERSONAL_ACCESS_TOKEN }}" | docker login ghcr.io -u ${{ secrets.REGISTRY_NAMESPACE }} --password-stdin

      - name: Use prod.application.yml
        run: |
          echo "Using prod.application.yml"
          rm src/main/resources/application.yml
          mv src/main/resources/prod.application.yml src/main/resources/application.yml
          cat src/main/resources/application.yml

      - name: Build Docker image
        run: |
          echo "Building Docker image..."
          docker build -t ${{ env.REGISTRY_IMAGE }}:latest .

      - name: Push Docker image
        run: |
          echo "Pushing Docker image..."
          docker push ${{ env.REGISTRY_IMAGE }}:latest


  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy on server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.REMOTE_USER }}@${{ secrets.REMOTE_HOST }} << 'EOF'

            echo "Pulling latest image ${{ env.REGISTRY_IMAGE }}"

            docker login ghcr.io -u ${{ secrets.REGISTRY_NAMESPACE }} -p ${{ secrets.PERSONAL_ACCESS_TOKEN }}

            cd /root/projet_synthese/infra

            echo "Stopping container"
            docker compose down ${{ env.CONTAINER_NAME }}

            echo "Removing old image"
            docker rmi -f ${{ env.REGISTRY_IMAGE }}:latest || true

            echo "Pulling new image"
            docker pull ${{ env.REGISTRY_IMAGE }}:latest

            echo " Starting container"
            docker compose up -d ${{ env.CONTAINER_NAME }}

            echo " Waiting ${{ env.HEALTH_DELAY }} seconds for health check"
            sleep ${{ env.HEALTH_DELAY }}

            echo " Checking container health..."
            STATUS=$(docker inspect --format='{{json .State.Health.Status}}' ${{ env.CONTAINER_NAME }})

            echo "Health status: $STATUS"

            if [ "$STATUS" != "\"healthy\"" ]; then
              echo "ERROR: Container is not healthy"
              exit 1
            fi

            echo "Deployment successful & container healthy!"
          EOF


```
