services:
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: reactivedb
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
  #kafka:
    #image: bitnami/kafka:3.6.2
    #ports:
    #  - "9092:9092"
    #environment:
      #- KAFKA_CFG_NODE_ID=0
      #- KAFKA_CFG_PROCESS_ROLES=controller,broker
      #- KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@kafka:9093
      #- KAFKA_CFG_LISTENERS=PLAINTEXT://:9092,CONTROLLER://:9093
      #- KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092
      #- KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      #- KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      # Zookeeper écoute sur le port 2181 pour les ordres
      ZOOKEEPER_CLIENT_PORT: 2181

  # ÉTAPE 2 : On lance le Travailleur
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    #  Kafka ne démarrera pas TANT QUE Zookeeper n'est pas prêt
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      # Kafka dit à Zookeeper : "Salut, je suis le broker n°1, enregistre-moi"
      KAFKA_BROKER_ID: 1
      #  Kafka demande : "Où se trouve mon manager ?" Il est à l'adresse 'zookeeper' sur le port 2181
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      
      # LA LIGNE LA PLUS IMPORTANTE POUR TOI
      # Quand ton application Java demandera à Kafka "Où dois-je me connecter ?",
      # Kafka répondra : "Utilise l'adresse localhost sur le port 9092".
      # C'est le pont entre le monde Docker et ton ordinateur.
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092

  # Stock service Mock
  stock-mock:
    image: wiremock/wiremock:2.35.0
    ports:
      - "8081:8080"
    # start the wiremock
    command: ["--verbose", "--global-response-templating"]

volumes:
  postgres_data: